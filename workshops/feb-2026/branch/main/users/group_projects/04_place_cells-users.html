
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Analyzing hippocampal place cells with Pynapple and NeMoS &#8212; CCN software workshop, Feb 2026  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=9c3e77be" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=f4437bd1" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=1ae7504c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'users/group_projects/04_place_cells-users';</script>
    <link rel="icon" href="../../_static/ccn_small.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Exploring the Allen Institute’s Visual Coding dataset" href="05_visual_coding-users.html" />
    <link rel="prev" title="Calcium imaging analysis of head-direction cells" href="03_calcium_imaging_analysis-users.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/01-FI-primary-logo-color.png" class="logo__image only-light" alt="Home"/>
    <script>document.write(`<img src="../../_static/03-FI-primary-logo-white.png" class="logo__image only-dark" alt="Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/flatironinstitute/ccn-software-feb-2026" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://flatironinstitute.github.io/neurorse-workshops/" title="Workshops home" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-house fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Workshops home</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://binder.flatironinstitute.org/v2/user/wbroderick/feb2026?labpath=notebooks/" title="Binder" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="https://mybinder.org/badge_logo.svg" class="icon-link-image" alt="Binder"/></a>
        </li>
</ul></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    Welcome!
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../jupyter.html">Intro to Jupyter Lab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cheatsheet.html">Cheatsheet and reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../can_you_read.html">Are You Sitting Too Far?</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Full notebooks</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../full/live_coding/01_fundamentals_of_pynapple.html">Learning the fundamentals of pynapple</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../full/live_coding/02_current_injection.html">Introduction to GLM and NeMoS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../full/live_coding/03_nemos_advanced.html">NeMoS Advanced: Cross-Validation and Model Selection</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Group projects</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="01_head_direction-users.html">Analyzing head-direction cells with Pynapple</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_population_analysis_with_nemos-users.html">Fitting a population GLM model with Nemos</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_calcium_imaging_analysis-users.html">Calcium imaging analysis of head-direction cells</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Analyzing hippocampal place cells with Pynapple and NeMoS</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_visual_coding-users.html">Exploring the Allen Institute’s Visual Coding dataset</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Limited live coding notebooks</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../index.html">For users (some code, some text)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../live_coding/01_fundamentals_of_pynapple-users.html">Learning the fundamentals of pynapple</a></li>
<li class="toctree-l2"><a class="reference internal" href="../live_coding/02_current_injection-users.html">Introduction to GLM and NeMoS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../live_coding/03_nemos_advanced-users.html">NeMoS Advanced: Cross-Validation and Model Selection</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../presenters/index.html">For presenter reference (all code, no text)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../presenters/live_coding/01_fundamentals_of_pynapple-presenters.html">Learning the fundamentals of pynapple</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presenters/live_coding/02_current_injection-presenters.html">Introduction to GLM and NeMoS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presenters/live_coding/03_nemos_advanced-presenters.html">NeMoS Advanced: Cross-Validation and Model Selection</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/flatironinstitute/ccn-software-feb-2026" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/users/group_projects/04_place_cells-users.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Analyzing hippocampal place cells with Pynapple and NeMoS</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-data-wrangling">Part 1: Data wrangling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fetching-the-data">Fetching the data</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#units">units</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#rem-nrem-and-forward-ep">rem, nrem, and forward_ep</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#eeg">eeg</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#position">position</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#restricting-the-data-computing-speed-and-visualization">Restricting the data, computing speed, and visualization</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#restrict-position-to-forward-ep-and-confirm-that-there-are-no-nan-values-in-the-restricted-data-set">1. Restrict <code class="docutils literal notranslate"><span class="pre">position</span></code> to <code class="docutils literal notranslate"><span class="pre">forward_ep</span></code> and confirm that there are no <code class="docutils literal notranslate"><span class="pre">nan</span></code> values in the restricted data set.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-velocity-using-the-derivative-method-on-position-during-forward-runs-use-np-abs-to-convert-the-velocity-into-speed">2. Calculate velocity using the <code class="docutils literal notranslate"><span class="pre">derivative</span></code> method on position during forward runs. Use <code class="docutils literal notranslate"><span class="pre">np.abs</span></code> to convert the velocity into speed.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-an-interval-set-for-forward-run-index-9-adding-2-seconds-to-the-end-of-the-interval-restrict-lfp-and-position-to-this-epoch">3. Create an interval set for forward run index 9, adding 2 seconds to the end of the interval. Restrict <code class="docutils literal notranslate"><span class="pre">lfp</span></code> and <code class="docutils literal notranslate"><span class="pre">position</span></code> to this epoch.</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-1d-neural-tuning-and-model-fitting">Part 2: 1D neural tuning and model fitting</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-1d-tuning-curves-place-fields">Computing 1D tuning curves: place fields</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#restrict-spikes-to-forward-ep-and-select-for-units-whose-rate-is-at-least-1-hz-and-at-most-10-hz">1. Restrict <code class="docutils literal notranslate"><span class="pre">spikes</span></code> to <code class="docutils literal notranslate"><span class="pre">forward_ep</span></code> and select for units whose rate is at least 1 Hz and at most 10 Hz</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-tuning-curves-with-respect-to-position-for-units-in-good-spikes">2. Compute tuning curves with respect to <code class="docutils literal notranslate"><span class="pre">position</span></code> for units in <code class="docutils literal notranslate"><span class="pre">good_spikes</span></code>.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-tuning-curves-with-respect-to-speed-for-units-in-good-spikes">3. Compute tuning curves with respect to <code class="docutils literal notranslate"><span class="pre">speed</span></code> for units in <code class="docutils literal notranslate"><span class="pre">good_spikes</span></code>.</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-tuning-curves-using-a-population-glm">Estimating tuning curves using a population GLM</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-observations-by-counting-spikes-using-the-pynapple-method-count-on-our-tsgroup-of-spike-times-good-spikes">4. Compute observations by counting spikes, using the pynapple method <code class="docutils literal notranslate"><span class="pre">count</span></code>, on our <code class="docutils literal notranslate"><span class="pre">TsGroup</span></code> of spike times, <code class="docutils literal notranslate"><span class="pre">good_spikes</span></code>.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#upsample-position-and-speed-using-the-pynapple-method-interpolate-with-the-time-stamps-from-counts">5. Upsample <code class="docutils literal notranslate"><span class="pre">position</span></code> and <code class="docutils literal notranslate"><span class="pre">speed</span></code> using the pynapple method <code class="docutils literal notranslate"><span class="pre">interpolate</span></code> with the time stamps from <code class="docutils literal notranslate"><span class="pre">counts</span></code>.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#instantiate-the-basis-by-doing-the-following">6. Instantiate the basis by doing the following:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-an-additive-basis-by-adding-together-position-basis-and-speed-basis">7. Create an additive basis by adding together <code class="docutils literal notranslate"><span class="pre">position_basis</span></code> and <code class="docutils literal notranslate"><span class="pre">speed_basis</span></code>.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-design-matrix-by-passing-up-position-and-up-speed-to-the-basis-method-compute-features">8. Create a design matrix by passing <code class="docutils literal notranslate"><span class="pre">up_position</span></code> and <code class="docutils literal notranslate"><span class="pre">up_speed</span></code> to the basis method <code class="docutils literal notranslate"><span class="pre">compute_features</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-a-glm-by-doing-the-following">9. Fit a GLM by doing the following:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#use-predict-to-calculated-the-predicted-firing-rate-of-our-model-use-the-predicted-rate-to-compute-predicted-tuning-curves-using-nap-compute-tuning-curves">10. Use <code class="docutils literal notranslate"><span class="pre">predict</span></code> to calculated the predicted firing rate of our model. Use the predicted rate to compute predicted tuning curves using <code class="docutils literal notranslate"><span class="pre">nap.compute_tuning_curves</span></code>.</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3-signal-processing">Part 3: Signal processing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-the-wavelet-decomposition">Getting the Wavelet Decomposition</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-100-log-spaced-samples-between-5-and-200-hz-using-np-geomspace">1. Define 100 log-spaced samples between 5 and 200 Hz using <code class="docutils literal notranslate"><span class="pre">np.geomspace</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-the-wavelet-transform-of-ex-lfp-using-freqs-defined-above">2. Compute the wavelet transform of <code class="docutils literal notranslate"><span class="pre">ex_lfp</span></code> using <code class="docutils literal notranslate"><span class="pre">freqs</span></code> defined above.</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-theta-phase">Computing theta phase</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#restrict-lfp-to-forward-ep">3. Restrict <code class="docutils literal notranslate"><span class="pre">lfp</span></code> to <code class="docutils literal notranslate"><span class="pre">forward_ep</span></code>.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#using-nap-apply-bandpass-filter-filter-lfp-for-theta-within-a-6-12-hz-range">4. Using <code class="docutils literal notranslate"><span class="pre">nap.apply_bandpass_filter</span></code>, filter <code class="docutils literal notranslate"><span class="pre">lfp</span></code> for theta within a 6-12 Hz range.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#use-sp-signal-hilbert-to-perform-the-hilbert-transform-of-theta-band-using-np-angle-to-extract-the-angle-convert-the-output-angle-to-a-0-2pi-range-and-store-the-result-in-a-tsd-object">5. Use <code class="docutils literal notranslate"><span class="pre">sp.signal.hilbert</span></code> to perform the Hilbert transform of <code class="docutils literal notranslate"><span class="pre">theta_band</span></code>, using <code class="docutils literal notranslate"><span class="pre">np.angle</span></code> to extract the angle. Convert the output angle to a [0, 2pi] range, and store the result in a <code class="docutils literal notranslate"><span class="pre">Tsd</span></code> object.</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-phase-precession-within-a-single-unit">Visualizing phase precession within a single unit</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#use-the-pynapple-object-method-value-from-to-find-the-value-of-theta-band-corresponding-to-each-spike-time-from-unit-177">6. Use the pynapple object method <code class="docutils literal notranslate"><span class="pre">value_from</span></code> to find the value of <code class="docutils literal notranslate"><span class="pre">theta_band</span></code> corresponding to each spike time from unit 177.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-the-value-of-theta-phase-corresponding-to-each-spike-time-from-unit-177">7. Compute the value of <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code> corresponding to each spike time from unit 177.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-the-position-corresponding-to-each-spike-for-example-unit-177">8. Compute the position corresponding to each spike for example unit 177.</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-4-2d-neural-tuning-and-model-fitting">Part 4: 2D neural tuning and model fitting</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-2d-tuning-curves-position-vs-phase">Computing 2D tuning curves: position vs. phase</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#interpolate-position-to-the-time-points-of-theta-phase">1. Interpolate <code class="docutils literal notranslate"><span class="pre">position</span></code> to the time points of <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code>.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#stack-upsampled-pos-and-theta-phase-together-into-a-single-tsdframe">2. Stack <code class="docutils literal notranslate"><span class="pre">upsampled_pos</span></code> and <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code> together into a single <code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#apply-nap-compute-tuning-curves-with-features-on-our-subselected-group-of-units-good-spikes">3. Apply <code class="docutils literal notranslate"><span class="pre">nap.compute_tuning_curves</span></code> with <code class="docutils literal notranslate"><span class="pre">features</span></code> on our subselected group of units, <code class="docutils literal notranslate"><span class="pre">good_spikes</span></code></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-2d-tuning-curves-using-2d-basis-functions">Estimating 2D tuning curves using 2D basis functions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#instantiate-a-cyclicbsplineeval-basis-object-for-phase-using-10-basis-functions">4. Instantiate a <code class="docutils literal notranslate"><span class="pre">CyclicBSplineEval</span></code> basis object for phase, using 10 basis functions.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-the-full-basis-by-multiplying-position-basis-and-phase-basis-and-adding-speed-basis">5. Create the full basis by multiplying <code class="docutils literal notranslate"><span class="pre">position_basis</span></code> and <code class="docutils literal notranslate"><span class="pre">phase_basis</span></code> and adding <code class="docutils literal notranslate"><span class="pre">speed_basis</span></code>.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#downsample-theta-phase-using-bin-average-and-a-bin-size-of-0-01-s">6. Downsample <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code> using <code class="docutils literal notranslate"><span class="pre">bin_average</span></code> and a bin size of 0.01 s.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-design-matrix-by-calling-compute-features-on-full-basis-using-up-position-bin-theta-and-up-speed">7. Create a design matrix by calling <code class="docutils literal notranslate"><span class="pre">compute_features</span></code> on <code class="docutils literal notranslate"><span class="pre">full_basis</span></code> using <code class="docutils literal notranslate"><span class="pre">up_position</span></code>, <code class="docutils literal notranslate"><span class="pre">bin_theta</span></code>, and <code class="docutils literal notranslate"><span class="pre">up_speed</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">8. Fit a GLM by doing the following:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">9. Use <code class="docutils literal notranslate"><span class="pre">predict</span></code> to calculated the predicted firing rate of our model. Use the predicted rate to compute predicted tuning curves using <code class="docutils literal notranslate"><span class="pre">nap.compute_tuning_curves</span></code>.</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-exercise">Bonus Exercise</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-5-neural-decoding">Part 5: Neural decoding</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decoding-position-from-spiking-activity">Decoding position from spiking activity</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#use-nap-decode-bayes-to-decode-position-during-ex-run-ep">1. Use <code class="docutils literal notranslate"><span class="pre">nap.decode_bayes</span></code> to decode position during <code class="docutils literal notranslate"><span class="pre">ex_run_ep</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#decode-the-same-run-as-above-now-using-sliding-window-size-of-5-bins">2. Decode the same run as above, now using sliding window size of 5 bins.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#decode-again-using-a-smaller-bin-size-of-10-ms-and-sliding-window-size-of-5-bins">3. Decode again using a smaller bin size of <span class="math notranslate nohighlight">\(10 ms\)</span> and sliding window size of 5 bins.</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-exercise-1">Bonus Exercise 1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-exercise-2">Bonus Exercise 2</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell tag_hide-input tag_render-all docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="o">%</span><span class="n">load_ext</span> <span class="n">autoreload</span>
<span class="o">%</span><span class="n">autoreload</span> <span class="mi">2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
    <span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;plotting functions contained within `_documentation_utils` are intended for nemos&#39;s documentation.&quot;</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="important render-all admonition">
<p class="admonition-title">Download</p>
<p>This notebook can be downloaded as <strong><a class="reference download internal" download="" href="../../_downloads/f59805a7d6834c48bc1ce63c0e0a05f9/04_place_cells-users.ipynb"><code class="xref download myst-nb docutils literal notranslate"><span class="pre">04_place_cells-users.ipynb</span></code></a></strong>. See the button at the top right to download as markdown or pdf.</p>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="analyzing-hippocampal-place-cells-with-pynapple-and-nemos">
<h1>Analyzing hippocampal place cells with Pynapple and NeMoS<a class="headerlink" href="#analyzing-hippocampal-place-cells-with-pynapple-and-nemos" title="Link to this heading">#</a></h1>
<p>This notebook has had all its explanatory text removed and has not been run.
It is intended to be downloaded and run locally (or on the provided binder),
working through the questions with your small group.</p>
<p>In this tutorial we will review more advanced applications of pynapple; tuning curves, signal processing, and decoding; as well as fitting GLMs to the data using NeMoS. We’ll apply these methods to demonstrate and visualize some well-known physiological properties of hippocampal activity, specifically phase presession of place cells and sequential coordination of place cell activity during theta oscillations.</p>
<p>This notebook is separated into 5 Parts:</p>
<ol class="arabic simple">
<li><p>Data wrangling</p></li>
<li><p>1D neural tuning and model fitting</p></li>
<li><p>Signal processing</p></li>
<li><p>2D neural tuning and model fitting</p></li>
<li><p>Neural decoding</p></li>
</ol>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">workshop_utils</span>
<span class="c1"># imports</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tqdm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pynapple</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nap</span>

<span class="c1"># necessary for animation</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">nemos</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nmo</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">nmo</span><span class="o">.</span><span class="n">styles</span><span class="o">.</span><span class="n">plot_style</span><span class="p">)</span>

<span class="c1"># configure pynapple to ignore conversion warning</span>
<span class="n">nap</span><span class="o">.</span><span class="n">nap_config</span><span class="o">.</span><span class="n">suppress_conversion_warnings</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
</div>
<section id="part-1-data-wrangling">
<h2>Part 1: Data wrangling<a class="headerlink" href="#part-1-data-wrangling" title="Link to this heading">#</a></h2>
<section id="fetching-the-data">
<h3>Fetching the data<a class="headerlink" href="#fetching-the-data" title="Link to this heading">#</a></h3>
<p>The data set we’ll be looking at is from the manuscript <a class="reference external" href="https://www.science.org/doi/10.1126/science.aad1935">Diversity in neural firing dynamics supports both rigid and learned hippocampal sequences</a>. In this study, the authors collected electrophisiology data in rats across multiple sites in layer CA1 of hippocampus to extract the LFP alongside spiking activity of many simultaneous pyramidal units. In each recording session, data were collected while the rats explored a novel environment (a linear or circular track), as well as during sleep before and after exploration. In our following analyses, we’ll focus on the exploration period of a single rat and recording session.</p>
<p>The full dataset for this study can be accessed on <a class="reference external" href="https://dandiarchive.org/dandiset/000044/0.210812.1516">DANDI</a>. Since the file size of a recording session can be large from the LFP saved for each recorded channel, we’ll use a smaller file that contains the spiking activity and the LFP from a single, representative channel, which is hosted on <a class="reference external" href="https://osf.io/2dfvp">OSF</a>. This smaller file, like the original data, is saved as an <a class="reference external" href="https://www.nwb.org">NWB</a> file.</p>
<p>If you ran the workshop setup script, you should have this file downloaded already. If not, the function we’ll use to fetch it will download it for you. This function is called <code class="docutils literal notranslate"><span class="pre">fetch_data</span></code>, and can be imported from the <code class="docutils literal notranslate"><span class="pre">workshop_utils</span></code> module. This function will give us the file path to where the data is stored. We can then use the pynapple function <code class="docutils literal notranslate"><span class="pre">load_file</span></code> to load in the data, which is able to handle the NWB file type.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># fetch file path</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">workshop_utils</span><span class="o">.</span><span class="n">fetch_data</span><span class="p">(</span><span class="s2">&quot;Achilles_10252013_EEG.nwb&quot;</span><span class="p">)</span>
<span class="c1"># load data with pynapple</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This returns a dictionary of pynapple objects that have been extracted from the NWB file. Let’s explore each of these objects.</p>
<div class="note render-all admonition">
<p class="admonition-title">Note</p>
<p>We will ignore the object <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code> because we will be computing this ourselves later on in the exercise.</p>
</div>
<section id="units">
<h4>units<a class="headerlink" href="#units" title="Link to this heading">#</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">units</span></code> field is a <a class="reference external" href="https://pynapple.org/generated/pynapple.TsGroup.html#pynapple.TsGroup"><code class="docutils literal notranslate"><span class="pre">TsGroup</span></code></a>: a collection of <a class="reference external" href="https://pynapple.org/generated/pynapple.Ts.html#pynapple.Ts"><code class="docutils literal notranslate"><span class="pre">Ts</span></code></a> objects containing the spike times of each unit, where the “Index” is the unit number or key. Each unit has the following metadata:</p>
<ul class="simple">
<li><p><strong>rate</strong>: computed by pynapple, is the average firing rate of the neuron across all recorded time points.</p></li>
<li><p><strong>location</strong>, <strong>shank</strong>, and <strong>cell_type</strong>: variables saved and imported from the original data set.</p></li>
</ul>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We can access the spike times of a single unit by indexing the <code class="docutils literal notranslate"><span class="pre">TsGroup</span></code> by its unit number. For example, to access the spike times of unit 1:</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="rem-nrem-and-forward-ep">
<h4>rem, nrem, and forward_ep<a class="headerlink" href="#rem-nrem-and-forward-ep" title="Link to this heading">#</a></h4>
<p>The next three objects; <code class="docutils literal notranslate"><span class="pre">rem</span></code>, <code class="docutils literal notranslate"><span class="pre">nrem</span></code>, and <code class="docutils literal notranslate"><span class="pre">forward_ep</span></code>; are all <a class="reference external" href="https://pynapple.org/generated/pynapple.IntervalSet.html#pynapple.IntervalSet"><code class="docutils literal notranslate"><span class="pre">IntervalSet</span></code></a> objects containing time windows of REM sleep, nREM sleep, and forward runs down the linear maze, respectively.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rem&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;nrem&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;forward_ep&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>All intervals in <code class="docutils literal notranslate"><span class="pre">forward_ep</span></code> occur in the middle of the session, while <code class="docutils literal notranslate"><span class="pre">rem</span></code> and <code class="docutils literal notranslate"><span class="pre">nrem</span></code> both contain sleep epochs that occur before and after exploration.</p>
<p>The following plot demonstrates how each of these labelled epochs are organized across the session.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">t_start</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;nrem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sp1</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">((</span><span class="n">iset</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">t_start</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="p">(</span><span class="n">iset</span><span class="o">.</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">t_start</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> <span class="k">for</span> <span class="n">iset</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rem&quot;</span><span class="p">]];</span>
<span class="n">sp2</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">((</span><span class="n">iset</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">t_start</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="p">(</span><span class="n">iset</span><span class="o">.</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">t_start</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> <span class="k">for</span> <span class="n">iset</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;nrem&quot;</span><span class="p">]];</span>
<span class="n">sp3</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">((</span><span class="n">iset</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">t_start</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="p">(</span><span class="n">iset</span><span class="o">.</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">t_start</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> <span class="k">for</span> <span class="n">iset</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;forward_ep&quot;</span><span class="p">]];</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Time within session (minutes)&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Labelled time intervals across session&quot;</span><span class="p">,</span> <span class="n">yticks</span><span class="o">=</span><span class="p">[])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">sp1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">sp2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">sp3</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="s2">&quot;REM sleep&quot;</span><span class="p">,</span><span class="s2">&quot;nREM sleep&quot;</span><span class="p">,</span><span class="s2">&quot;forward runs&quot;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="eeg">
<h4>eeg<a class="headerlink" href="#eeg" title="Link to this heading">#</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">eeg</span></code> object is a <a class="reference external" href="https://pynapple.org/generated/pynapple.TsdFrame.html#pynapple.TsdFrame"><code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code></a> containing an LFP voltage trace for a single representative channel in CA1.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;eeg&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Despite having a single column, this <a class="reference external" href="https://pynapple.org/generated/pynapple.TsdFrame.html#pynapple.TsdFrame"><code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code></a> is still a 2D object. We can represent this as a 1D <code class="docutils literal notranslate"><span class="pre">Tsd</span></code> by indexing into the first column.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;eeg&quot;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="position">
<h4>position<a class="headerlink" href="#position" title="Link to this heading">#</a></h4>
<p>The final object, <code class="docutils literal notranslate"><span class="pre">position</span></code>, is a <a class="reference external" href="https://pynapple.org/generated/pynapple.Tsd.html#pynapple.Tsd"><code class="docutils literal notranslate"><span class="pre">Tsd</span></code></a> containing the linearized position of the animal, in centimeters, recorded during the exploration window.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Positions that are not defined, i.e. when the animal is at rest, are filled with <code class="docutils literal notranslate"><span class="pre">NaN</span></code>.</p>
<p>This object additionally contains a <a class="reference external" href="https://pynapple.org/generated/pynapple.Tsd.html#id1"><code class="docutils literal notranslate"><span class="pre">time_support</span></code></a> attribute, which gives the time interval during which positions are recorded (including points recorded as <code class="docutils literal notranslate"><span class="pre">NaN</span></code>).</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">time_support</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s visualize the first 300 seconds of position data and overlay <code class="docutils literal notranslate"><span class="pre">forward_ep</span></code> intervals.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">time_support</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">l1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">])</span>
<span class="n">l2</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">iset</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">iset</span><span class="o">.</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> <span class="k">for</span> <span class="n">iset</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;forward_ep&quot;</span><span class="p">]];</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="n">pos_start</span><span class="p">,</span><span class="n">pos_start</span><span class="o">+</span><span class="mi">300</span><span class="p">],</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Position (cm)&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Tracked position along linear maze&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">l1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="s2">&quot;animal position&quot;</span><span class="p">,</span> <span class="s2">&quot;forward run epochs&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>This plot confirms that positions are only recorded while the animal is moving along the track. Additionally, it is clear that the intervals in <code class="docutils literal notranslate"><span class="pre">forward_ep</span></code> capture only perios when the animal’s position is increasing, during forward runs.</p>
<p>We’ll save out the following variables that we’ll need throughout the notebook.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">position</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span>
<span class="n">lfp</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;eeg&quot;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">spikes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span>
<span class="n">forward_ep</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;forward_ep&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="restricting-the-data-computing-speed-and-visualization">
<h3>Restricting the data, computing speed, and visualization<a class="headerlink" href="#restricting-the-data-computing-speed-and-visualization" title="Link to this heading">#</a></h3>
<p>For the following exercises, we’ll only focus on periods labeled as forward runs aloong the linear track. We can extract this information using the interval set <code class="docutils literal notranslate"><span class="pre">forward_ep</span></code>.</p>
<section id="restrict-position-to-forward-ep-and-confirm-that-there-are-no-nan-values-in-the-restricted-data-set">
<h4>1. Restrict <code class="docutils literal notranslate"><span class="pre">position</span></code> to <code class="docutils literal notranslate"><span class="pre">forward_ep</span></code> and confirm that there are no <code class="docutils literal notranslate"><span class="pre">nan</span></code> values in the restricted data set.<a class="headerlink" href="#restrict-position-to-forward-ep-and-confirm-that-there-are-no-nan-values-in-the-restricted-data-set" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># restrict position and check for nans</span>
<span class="n">position</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>We also want the speed of the animal during forward runs. We can get this using the pynapple object method <a class="reference external" href="https://pynapple.org/generated/pynapple.Tsd.derivative.html"><code class="docutils literal notranslate"><span class="pre">derivative</span></code></a>. Conveniently, this will account for discontinuous intervals either in the time support, or by inputting the optional argument <code class="docutils literal notranslate"><span class="pre">ep</span></code>, the intervals over which you want to compute the derivative.</p>
<p>Note, however, that the output of the derivative function is <em>velocity</em>. For the following analyses, we only care about the magnitude, or <em>speed</em>; therefore, we’ll need to take the absolute value of the output to get our variable of interest.</p>
</section>
<section id="calculate-velocity-using-the-derivative-method-on-position-during-forward-runs-use-np-abs-to-convert-the-velocity-into-speed">
<h4>2. Calculate velocity using the <a class="reference external" href="https://pynapple.org/generated/pynapple.Tsd.derivative.html"><code class="docutils literal notranslate"><span class="pre">derivative</span></code></a> method on position during forward runs. Use <code class="docutils literal notranslate"><span class="pre">np.abs</span></code> to convert the velocity into speed.<a class="headerlink" href="#calculate-velocity-using-the-derivative-method-on-position-during-forward-runs-use-np-abs-to-convert-the-velocity-into-speed" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculate speed</span>
<span class="n">speed</span> <span class="o">=</span>
</pre></div>
</div>
</div>
</div>
<p>To get a sense of what the LFP looks like while the animal runs down the linear track, we can plot each variable; <code class="docutils literal notranslate"><span class="pre">lfp</span></code>, <code class="docutils literal notranslate"><span class="pre">position</span></code>, and <code class="docutils literal notranslate"><span class="pre">speed</span></code>; side-by-side. Let’s do this for an example run; specifically, we’ll look at forward run 9.</p>
</section>
<section id="create-an-interval-set-for-forward-run-index-9-adding-2-seconds-to-the-end-of-the-interval-restrict-lfp-and-position-to-this-epoch">
<h4>3. Create an interval set for forward run index 9, adding 2 seconds to the end of the interval. Restrict <code class="docutils literal notranslate"><span class="pre">lfp</span></code> and <code class="docutils literal notranslate"><span class="pre">position</span></code> to this epoch.<a class="headerlink" href="#create-an-interval-set-for-forward-run-index-9-adding-2-seconds-to-the-end-of-the-interval-restrict-lfp-and-position-to-this-epoch" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ex_ep</span> <span class="o">=</span>
<span class="n">ex_lfp</span> <span class="o">=</span> 
<span class="n">ex_position</span> <span class="o">=</span> 
<span class="n">ex_speed</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>Let’s plot the example LFP trace and animal position and speed. Plotting <code class="docutils literal notranslate"><span class="pre">Tsd</span></code> objects will automatically put time on the x-axis.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># plot LFP</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_lfp</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Local Field Potential on Linear Track&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;LFP (a.u.)&quot;</span><span class="p">)</span>

<span class="c1"># plot animal&#39;s position</span>
<span class="n">l1</span><span class="p">,</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_position</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Animal Position on Linear Track&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Position (cm)&quot;</span><span class="p">)</span> 
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">);</span>

<span class="c1"># plot animal&#39;s speed</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">l2</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_speed</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Animal Position on Linear Track&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Speed (cm/s)&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">,</span><span class="s2">&quot;speed&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Figure check</p>
<p><img alt="" src="../../_images/pc-01.png" /></p>
</div>
<p>As we would expect, there is a strong theta oscillation dominating the LFP while the animal runs down the track. This oscillation is weaker after the run is complete.</p>
</section>
</section>
</section>
<section id="part-2-1d-neural-tuning-and-model-fitting">
<h2>Part 2: 1D neural tuning and model fitting<a class="headerlink" href="#part-2-1d-neural-tuning-and-model-fitting" title="Link to this heading">#</a></h2>
<section id="computing-1d-tuning-curves-place-fields">
<h3>Computing 1D tuning curves: place fields<a class="headerlink" href="#computing-1d-tuning-curves-place-fields" title="Link to this heading">#</a></h3>
<p>First, we will look at the place selectivity of each unit. We can find place firing preferences of each unit by using the function <a class="reference external" href="https://pynapple.org/generated/pynapple.process.tuning_curves.html#pynapple.process.tuning_curves.compute_tuning_curves"><code class="docutils literal notranslate"><span class="pre">nap.compute_tuning_curves</span></code></a>.</p>
<p>We’ll filter for units that fire at least 1 Hz and at most 10 Hz when the animal is running forward along the linear track. This will select for units that are active during our window of interest and eliminate putative interneurons (i.e. fast-firing inhibitory neurons that don’t usually have place selectivity). Afterwards, we’ll compute the tuning curves for these sub-selected units over position.</p>
<section id="restrict-spikes-to-forward-ep-and-select-for-units-whose-rate-is-at-least-1-hz-and-at-most-10-hz">
<h4>1. Restrict <code class="docutils literal notranslate"><span class="pre">spikes</span></code> to <code class="docutils literal notranslate"><span class="pre">forward_ep</span></code> and select for units whose rate is at least 1 Hz and at most 10 Hz<a class="headerlink" href="#restrict-spikes-to-forward-ep-and-select-for-units-whose-rate-is-at-least-1-hz-and-at-most-10-hz" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># save the filtered spikes in the following variable</span>
<span class="n">good_spikes</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
</section>
<section id="compute-tuning-curves-with-respect-to-position-for-units-in-good-spikes">
<h4>2. Compute tuning curves with respect to <code class="docutils literal notranslate"><span class="pre">position</span></code> for units in <code class="docutils literal notranslate"><span class="pre">good_spikes</span></code>.<a class="headerlink" href="#compute-tuning-curves-with-respect-to-position-for-units-in-good-spikes" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Use 50 position bins</p></li>
<li><p>Name the feature <code class="docutils literal notranslate"><span class="pre">&quot;position&quot;</span></code> using the optional argument <code class="docutils literal notranslate"><span class="pre">feature_names</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">place_fields</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>This function returns tuning curves as an <code class="docutils literal notranslate"><span class="pre">xarray.DataArray</span></code>, with coordinates for unit (first dimension) and position (second dimension). An <code class="docutils literal notranslate"><span class="pre">xarray.DataArray</span></code> object provides convenient tools for plotting and other manipulations, and it scales well for tuning curves with more than 1 feature.</p>
<div class="tip render-all admonition">
<p class="admonition-title">Tip</p>
<p>The reason <a class="reference external" href="https://pynapple.org/generated/pynapple.process.tuning_curves.html#pynapple.process.tuning_curves.compute_tuning_curves"><code class="docutils literal notranslate"><span class="pre">nap.compute_tuning_curves</span></code></a> returns a <code class="docutils literal notranslate"><span class="pre">xarray.DataArray</span></code> and not a Pynapple object is because the array elements no longer correspond to <em>time</em>, which Pynapple objects require.</p>
</div>
<p>We can use the <code class="docutils literal notranslate"><span class="pre">xarray.DataArray</span></code> <code class="docutils literal notranslate"><span class="pre">plot</span></code> method to easily plot each unit, focusing on three example units.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">neurons</span> <span class="o">=</span> <span class="p">[</span><span class="mi">82</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">220</span><span class="p">]</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">place_fields</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">neurons</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;unit&quot;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">set_ylabels</span><span class="p">(</span><span class="s2">&quot;firing rate (Hz)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Figure check</p>
<p><img alt="" src="../../_images/pc-02.png" /></p>
</div>
<p>We can see clear spatial selectivity in these example units, where firing rate peaks at specific positions along the track.</p>
<p>Let’s repeat this exercise, but instead compute tuning curves as a function of <em>speed</em> instead of position.</p>
</section>
<section id="compute-tuning-curves-with-respect-to-speed-for-units-in-good-spikes">
<h4>3. Compute tuning curves with respect to <code class="docutils literal notranslate"><span class="pre">speed</span></code> for units in <code class="docutils literal notranslate"><span class="pre">good_spikes</span></code>.<a class="headerlink" href="#compute-tuning-curves-with-respect-to-speed-for-units-in-good-spikes" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Use 30 speed bins</p></li>
<li><p>Name the feature <code class="docutils literal notranslate"><span class="pre">&quot;speed&quot;</span></code> using the optional argument <code class="docutils literal notranslate"><span class="pre">feature_names</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">speed_fields</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Figure check</p>
<p><img alt="" src="../../_images/pc-03.png" /></p>
</div>
</section>
</section>
<section id="estimating-tuning-curves-using-a-population-glm">
<h3>Estimating tuning curves using a population GLM<a class="headerlink" href="#estimating-tuning-curves-using-a-population-glm" title="Link to this heading">#</a></h3>
<div class="render-all admonition note">
<p class="admonition-title">Note</p>
<p>This afternoon, we’ll show how to cross-validate across basis identity, which you can use to choose the basis.</p>
</div>
<section id="compute-observations-by-counting-spikes-using-the-pynapple-method-count-on-our-tsgroup-of-spike-times-good-spikes">
<h4>4. Compute observations by counting spikes, using the pynapple method <code class="docutils literal notranslate"><span class="pre">count</span></code>, on our <code class="docutils literal notranslate"><span class="pre">TsGroup</span></code> of spike times, <code class="docutils literal notranslate"><span class="pre">good_spikes</span></code>.<a class="headerlink" href="#compute-observations-by-counting-spikes-using-the-pynapple-method-count-on-our-tsgroup-of-spike-times-good-spikes" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Use a <code class="docutils literal notranslate"><span class="pre">bin_size</span></code> of 10 ms (0.01s)</p></li>
<li><p>Pass <code class="docutils literal notranslate"><span class="pre">forward_ep</span></code> as the optional argument <code class="docutils literal notranslate"><span class="pre">ep</span></code> to make sure we’re only counting during forward runs.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">bin_size</span> <span class="o">=</span> 
<span class="n">counts</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
</section>
<section id="upsample-position-and-speed-using-the-pynapple-method-interpolate-with-the-time-stamps-from-counts">
<h4>5. Upsample <code class="docutils literal notranslate"><span class="pre">position</span></code> and <code class="docutils literal notranslate"><span class="pre">speed</span></code> using the pynapple method <a class="reference external" href="https://pynapple.org/generated/pynapple.Tsd.interpolate.html"><code class="docutils literal notranslate"><span class="pre">interpolate</span></code></a> with the time stamps from <code class="docutils literal notranslate"><span class="pre">counts</span></code>.<a class="headerlink" href="#upsample-position-and-speed-using-the-pynapple-method-interpolate-with-the-time-stamps-from-counts" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Use a <code class="docutils literal notranslate"><span class="pre">bin_size</span></code> of 10 ms (0.01s)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">up_position</span> <span class="o">=</span> 
<span class="n">up_speed</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<div class="render-all admonition note">
<p class="admonition-title">Note</p>
<p>This afternoon, we’ll show how to cross-validate across basis identity, which you can use to choose the basis.</p>
</div>
</section>
<section id="instantiate-the-basis-by-doing-the-following">
<span id="basis-eval-place-cells-users"></span><h4>6. Instantiate the basis by doing the following:<a class="headerlink" href="#instantiate-the-basis-by-doing-the-following" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Create a separate basis object for each model input (speed and position).</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">BSplineEval</span></code> basis with, using 12 basis functions for position and 6 basis functions for speed.</p></li>
<li><p>Provide a label for each basis (“position” and “speed”).</p></li>
</ul>
<p>We’ll use a helper function to visualize the resulting basis functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">position_basis</span> <span class="o">=</span> 
<span class="n">speed_basis</span> <span class="o">=</span> 
<span class="n">workshop_utils</span><span class="o">.</span><span class="n">plot_pos_speed_bases</span><span class="p">(</span><span class="n">position_basis</span><span class="p">,</span> <span class="n">speed_basis</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Figure check</p>
<p><img alt="" src="../../_images/pc-04.png" /></p>
</div>
<p>However, now we have an issue: in all our previous examples, we had a single basis object, which took a single input to produce a single array which we then passed to the <code class="docutils literal notranslate"><span class="pre">GLM</span></code> object as the design matrix. What do we do when we have multiple basis objects?</p>
<p>To do this, we can use <a class="reference external" href="https://nemos.readthedocs.io/en/latest/background/basis/plot_02_ND_basis_function.html">NeMoS basis composition</a>, where you can add the two bases together and obtain a new additive basis. We can similarly call <code class="docutils literal notranslate"><span class="pre">compute_features</span></code> on this additive basis, passing both position and speed, to obtain the same design matrix. For people familiar with NumPy, this is equivalent to calling <code class="docutils literal notranslate"><span class="pre">basis.compute_features()</span></code> for each basis separately and then <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.concatenate.html">concatenate</a> the outputs.</p>
</section>
<section id="create-an-additive-basis-by-adding-together-position-basis-and-speed-basis">
<h4>7. Create an additive basis by adding together <code class="docutils literal notranslate"><span class="pre">position_basis</span></code> and <code class="docutils literal notranslate"><span class="pre">speed_basis</span></code>.<a class="headerlink" href="#create-an-additive-basis-by-adding-together-position-basis-and-speed-basis" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">additive_basis</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-design-matrix-by-passing-up-position-and-up-speed-to-the-basis-method-compute-features">
<h4>8. Create a design matrix by passing <code class="docutils literal notranslate"><span class="pre">up_position</span></code> and <code class="docutils literal notranslate"><span class="pre">up_speed</span></code> to the basis method <code class="docutils literal notranslate"><span class="pre">compute_features</span></code><a class="headerlink" href="#create-a-design-matrix-by-passing-up-position-and-up-speed-to-the-basis-method-compute-features" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Make sure the features are passed in the same order that the basis objects were added together!</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>Notice that, since we passed pynapple objects to the basis object, we got a pynapple object back, preserving the time stamps. Additionally, <code class="docutils literal notranslate"><span class="pre">X</span></code> has the same number of time points as our input position and speed, but 20 columns. The columns come from  <code class="docutils literal notranslate"><span class="pre">n_basis_funcs</span></code> from each basis (10 for position, 10 for speed).</p>
<p>As we’ve done before, we can now use the Poisson GLM from NeMoS to learn the combined model.</p>
</section>
<section id="fit-a-glm-by-doing-the-following">
<h4>9. Fit a GLM by doing the following:<a class="headerlink" href="#fit-a-glm-by-doing-the-following" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Initialize <code class="docutils literal notranslate"><span class="pre">PopulationGLM</span></code></p></li>
<li><p>Use the “LBFGS” solver and pass <code class="docutils literal notranslate"><span class="pre">{&quot;tol&quot;:</span> <span class="pre">1e-12}</span></code> to <code class="docutils literal notranslate"><span class="pre">solver_kwargs</span></code>.</p></li>
<li><p>Fit the data, passing the design matrix <code class="docutils literal notranslate"><span class="pre">X</span></code> and spike counts <code class="docutils literal notranslate"><span class="pre">counts</span></code> to the glm object.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># define the model</span>
<span class="n">glm</span> <span class="o">=</span>
<span class="c1"># fit</span>
<span class="n">glm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s check first if our model can accurately predict the tuning curves we displayed above. We can use the <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.GLM.predict.html#nemos.glm.GLM.predict"><code class="docutils literal notranslate"><span class="pre">predict</span></code></a> function of NeMoS and then compute new tuning curves using pynapple.</p>
</section>
<section id="use-predict-to-calculated-the-predicted-firing-rate-of-our-model-use-the-predicted-rate-to-compute-predicted-tuning-curves-using-nap-compute-tuning-curves">
<h4>10. Use <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.GLM.predict.html#nemos.glm.GLM.predict"><code class="docutils literal notranslate"><span class="pre">predict</span></code></a> to calculated the predicted firing rate of our model. Use the predicted rate to compute predicted tuning curves using <a class="reference external" href="https://pynapple.org/generated/pynapple.process.tuning_curves.html#pynapple.process.tuning_curves.compute_tuning_curves"><code class="docutils literal notranslate"><span class="pre">nap.compute_tuning_curves</span></code></a>.<a class="headerlink" href="#use-predict-to-calculated-the-predicted-firing-rate-of-our-model-use-the-predicted-rate-to-compute-predicted-tuning-curves-using-nap-compute-tuning-curves" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Remember to convert the predicted firing rate to spikes per second!</p></li>
<li><p>Use 50 bins for position tuning curves and 30 bins for speed tuning curves.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># predict the model&#39;s firing rate</span>
<span class="n">predicted_rate</span> <span class="o">=</span>
<span class="c1"># compute the position and speed tuning curves using the predicted firing rate.</span>
<span class="n">glm_tuning_pos</span> <span class="o">=</span> 
<span class="n">glm_tuning_speed</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>We can plot the results to compare the model and data tuning curves.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">workshop_utils</span><span class="o">.</span><span class="n">plot_position_speed_tuning</span><span class="p">(</span><span class="n">place_fields</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">neurons</span><span class="p">),</span> <span class="n">speed_fields</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">neurons</span><span class="p">),</span> <span class="n">glm_tuning_pos</span><span class="p">,</span> <span class="n">glm_tuning_speed</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Figure check</p>
<p><img alt="" src="../../_images/pc-05.png" /></p>
</div>
<p>We can see that this model does a good job capturing both the position and the speed.</p>
</section>
</section>
</section>
<section id="part-3-signal-processing">
<h2>Part 3: Signal processing<a class="headerlink" href="#part-3-signal-processing" title="Link to this heading">#</a></h2>
<section id="getting-the-wavelet-decomposition">
<h3>Getting the Wavelet Decomposition<a class="headerlink" href="#getting-the-wavelet-decomposition" title="Link to this heading">#</a></h3>
<p>Next we’ll use pynapple’s signal processing module to analyze LFP and visualize phase precessing within hippocampal place cells. We’ll start by performing a wavelet decomposition on the LFP trace during example run 9 that saved in Part 1 question 3 as the Tsd <code class="docutils literal notranslate"><span class="pre">ex_lfp</span></code>. We can do this in pynapple using the function <a class="reference external" href="https://pynapple.org/generated/pynapple.process.wavelets.html#pynapple.process.wavelets.compute_wavelet_transform"><code class="docutils literal notranslate"><span class="pre">nap.compute_wavelet_transform</span></code></a>.</p>
<p>A <a class="reference external" href="https://en.wikipedia.org/wiki/Continuous_wavelet_transform">continuous wavelet transform</a> decomposes a signal into a set of <a class="reference external" href="https://en.wikipedia.org/wiki/Wavelet">wavelets</a>, in this case <a class="reference external" href="https://en.wikipedia.org/wiki/Morlet_wavelet">Morlet wavelets</a>, that span both frequency and time. You can think of the wavelet transform as a cross-correlation between the signal and each wavelet, giving the similarity between the signal and various frequency components at each time point of the signal. Similar to a Fourier transform, this gives us an estimate of what frequencies are dominating a signal. Unlike the Fourier tranform, however, the wavelet transform gives us this estimate as a function of time.</p>
<p>We must define the frequency set that we’d like to use for our decomposition. We can do this with the numpy function <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.geomspace.html"><code class="docutils literal notranslate"><span class="pre">np.geomspace</span></code></a>, which returns numbers evenly spaced on a log scale. We pass the lower frequency, the upper frequency, and number of samples as positional arguments.</p>
<section id="define-100-log-spaced-samples-between-5-and-200-hz-using-np-geomspace">
<h4>1. Define 100 log-spaced samples between 5 and 200 Hz using <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.geomspace.html"><code class="docutils literal notranslate"><span class="pre">np.geomspace</span></code></a><a class="headerlink" href="#define-100-log-spaced-samples-between-5-and-200-hz-using-np-geomspace" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 100 log-spaced samples between 5Hz and 200Hz</span>
<span class="n">freqs</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>We can now compute the wavelet transform on our LFP data during the example run using <a class="reference external" href="https://pynapple.org/generated/pynapple.process.wavelets.html#pynapple.process.wavelets.compute_wavelet_transform"><code class="docutils literal notranslate"><span class="pre">nap.compute_wavelet_transform</span></code></a> by passing both <code class="docutils literal notranslate"><span class="pre">ex_lfp</span></code> and <code class="docutils literal notranslate"><span class="pre">freqs</span></code>. We’ll also pass the optional argument <code class="docutils literal notranslate"><span class="pre">fs</span></code>, which is known to be 1250Hz from the study methods.</p>
</section>
<section id="compute-the-wavelet-transform-of-ex-lfp-using-freqs-defined-above">
<h4>2. Compute the wavelet transform of <code class="docutils literal notranslate"><span class="pre">ex_lfp</span></code> using <code class="docutils literal notranslate"><span class="pre">freqs</span></code> defined above.<a class="headerlink" href="#compute-the-wavelet-transform-of-ex-lfp-using-freqs-defined-above" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Supply the known sampling rate, 1250 Hz, as the optional argument <code class="docutils literal notranslate"><span class="pre">fs</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sample_rate</span> <span class="o">=</span> <span class="mi">1250</span>
<span class="n">ex_cwt</span> <span class="o">=</span>
</pre></div>
</div>
</div>
</div>
<div class="tip render-all admonition">
<p class="admonition-title">Note</p>
<p>If <code class="docutils literal notranslate"><span class="pre">fs</span></code> is not provided, it can be inferred from the time series <a class="reference external" href="https://pynapple.org/generated/pynapple.Tsd.html#id0"><code class="docutils literal notranslate"><span class="pre">rate</span></code></a> attribute, e.g. <code class="docutils literal notranslate"><span class="pre">ex_lfp.rate</span></code>. However, while inferred rate is close to the true sampling rate, it can introduce a small floating-point error. Therefore, it is better to supply the true sampling rate when it is known.</p>
</div>
<p>We can visualize the results by plotting a heat map of the calculated wavelet scalogram.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Wavelet Decomposition&quot;</span><span class="p">)</span>

<span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ex_cwt</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">ex_cwt</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">amp</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Frequency (Hz)&quot;</span><span class="p">,</span> <span class="n">yscale</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">yticks</span><span class="o">=</span><span class="n">freqs</span><span class="p">[::</span><span class="mi">10</span><span class="p">],</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">freqs</span><span class="p">[::</span><span class="mi">10</span><span class="p">]));</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">minorticks_off</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cax</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Amplitude&quot;</span><span class="p">)</span>

<span class="n">p1</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_lfp</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;LFP (a.u.)&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Time(s)&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_position</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Position (cm)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="s2">&quot;raw LFP&quot;</span><span class="p">,</span><span class="s2">&quot;animal position&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Figure check</p>
<p><img alt="" src="../../_images/pc-06.png" /></p>
</div>
<p>You should see a strong presence of theta in the 6-12Hz frequency band while the animal runs down the track, which dampens during rest.</p>
</section>
</section>
<section id="computing-theta-phase">
<h3>Computing theta phase<a class="headerlink" href="#computing-theta-phase" title="Link to this heading">#</a></h3>
<p>To capture phase precession, we will need to compute the phase of the theta oscillation present in the LFP. Similar to our analysis of position, we only want to compute theta phase during forward runs down the track, where the theta power will be strongest.</p>
<section id="restrict-lfp-to-forward-ep">
<h4>3. Restrict <code class="docutils literal notranslate"><span class="pre">lfp</span></code> to <code class="docutils literal notranslate"><span class="pre">forward_ep</span></code>.<a class="headerlink" href="#restrict-lfp-to-forward-ep" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Confirm that <code class="docutils literal notranslate"><span class="pre">position</span></code> is already be restricted to this epoch from Part 1: question 1. If not, also restrict <code class="docutils literal notranslate"><span class="pre">position</span></code> to <code class="docutils literal notranslate"><span class="pre">forward_ep</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lfp</span> <span class="o">=</span> 
<span class="n">position</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>We can extract the theta oscillation by applying a bandpass filter on the raw LFP. To do this, we use the pynapple function <a class="reference external" href="https://pynapple.org/generated/pynapple.process.filtering.html#pynapple.process.filtering.apply_bandpass_filter"><code class="docutils literal notranslate"><span class="pre">nap.apply_bandpass_filter</span></code></a>. Conveniently, this function will recognize and handle splits in the epoched data (i.e. applying the filtering separately to discontinuous epochs), so we don’t have to worry about passing signals that have been split in time.</p>
</section>
<section id="using-nap-apply-bandpass-filter-filter-lfp-for-theta-within-a-6-12-hz-range">
<h4>4. Using <a class="reference external" href="https://pynapple.org/generated/pynapple.process.filtering.html#pynapple.process.filtering.apply_bandpass_filter"><code class="docutils literal notranslate"><span class="pre">nap.apply_bandpass_filter</span></code></a>, filter <code class="docutils literal notranslate"><span class="pre">lfp</span></code> for theta within a 6-12 Hz range.<a class="headerlink" href="#using-nap-apply-bandpass-filter-filter-lfp-for-theta-within-a-6-12-hz-range" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Same as before, pass the sampling rate of 1250 Hz (<code class="docutils literal notranslate"><span class="pre">sample_rate</span></code>)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">theta_band</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>We can visualize the output by plotting the filtered signal with the original signal.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ex_run_ep</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">IntervalSet</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">forward_ep</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">forward_ep</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfp</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;raw&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_band</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;filtered&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;LFP (a.u.)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Bandpass filter for theta oscillations (6-12 Hz)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Figure check</p>
<p><img alt="" src="../../_images/pc-07.png" /></p>
</div>
<p>Finally, we need to extract the phase of theta from the filtered signal. We can do this by taking the angle of the <a class="reference external" href="https://en.wikipedia.org/wiki/Hilbert_transform">Hilbert transform</a>.</p>
</section>
<section id="use-sp-signal-hilbert-to-perform-the-hilbert-transform-of-theta-band-using-np-angle-to-extract-the-angle-convert-the-output-angle-to-a-0-2pi-range-and-store-the-result-in-a-tsd-object">
<h4>5. Use <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.hilbert.html"><code class="docutils literal notranslate"><span class="pre">sp.signal.hilbert</span></code></a> to perform the Hilbert transform of <code class="docutils literal notranslate"><span class="pre">theta_band</span></code>, using <a class="reference external" href="https://numpy.org/doc/2.3/reference/generated/numpy.angle.html"><code class="docutils literal notranslate"><span class="pre">np.angle</span></code></a> to extract the angle. Convert the output angle to a [0, 2pi] range, and store the result in a <code class="docutils literal notranslate"><span class="pre">Tsd</span></code> object.<a class="headerlink" href="#use-sp-signal-hilbert-to-perform-the-hilbert-transform-of-theta-band-using-np-angle-to-extract-the-angle-convert-the-output-angle-to-a-0-2pi-range-and-store-the-result-in-a-tsd-object" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>TIP: don’t forget to pass the time support!</p></li>
<li><p>The line for wrapping the phase from [0, 2pi] is provided, by adding 2pi to all negative angles</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute the phase</span>
<span class="n">phase</span> <span class="o">=</span> 
<span class="n">phase</span><span class="p">[</span><span class="n">phase</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="c1"># wrap to [0,2pi]</span>
<span class="c1"># store as a Tsd</span>
<span class="n">theta_phase</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>Let’s plot the phase on top of the filtered LFP signal, zooming in on a few cycles.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ex_run_shorter</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">IntervalSet</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ex_run_ep</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span><span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="c1">#, height_ratios=[2,1])</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfp</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_shorter</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;LFP (a.u.)&quot;</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_phase</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_shorter</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Phase (rad)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_band</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_shorter</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Filtered LFP (a.u.)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="s2">&quot;theta phase&quot;</span><span class="p">,</span><span class="s2">&quot;filtered LFP&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Figure check</p>
<p><img alt="" src="../../_images/pc-08.png" /></p>
</div>
</section>
</section>
<section id="visualizing-phase-precession-within-a-single-unit">
<h3>Visualizing phase precession within a single unit<a class="headerlink" href="#visualizing-phase-precession-within-a-single-unit" title="Link to this heading">#</a></h3>
<p>As an initial visualization of phase precession, we’ll look at a single traversal of the linear track. First, let’s look at how the timing of an example unit’s spikes lines up with the LFP and theta. To plot the spike times on the same axis as the LFP, we’ll use the pynapple object’s method <a class="reference external" href="https://pynapple.org/generated/pynapple.TsGroup.value_from.html"><code class="docutils literal notranslate"><span class="pre">value_from</span></code></a> to align the spike times with the theta amplitude. For our spiking data, this will find the amplitude closest in time to each spike. Let’s start by applying <a class="reference external" href="https://pynapple.org/generated/pynapple.TsGroup.value_from.html"><code class="docutils literal notranslate"><span class="pre">value_from</span></code></a> on unit 177, who’s place field is cenetered on the linear track, using <code class="docutils literal notranslate"><span class="pre">theta_band</span></code> to align the amplityde of the filtered LFP.</p>
<section id="use-the-pynapple-object-method-value-from-to-find-the-value-of-theta-band-corresponding-to-each-spike-time-from-unit-177">
<h4>6. Use the pynapple object method <a class="reference external" href="https://pynapple.org/generated/pynapple.TsGroup.value_from.html"><code class="docutils literal notranslate"><span class="pre">value_from</span></code></a> to find the value of <code class="docutils literal notranslate"><span class="pre">theta_band</span></code> corresponding to each spike time from unit 177.<a class="headerlink" href="#use-the-pynapple-object-method-value-from-to-find-the-value-of-theta-band-corresponding-to-each-spike-time-from-unit-177" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">unit</span> <span class="o">=</span> <span class="mi">177</span>
<span class="n">spike_theta</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>Let’s plot <code class="docutils literal notranslate"><span class="pre">spike_theta</span></code> on top of the LFP and filtered theta, as well as visualize the animal’s position along the track.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span><span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfp</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;raw LFP&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_band</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;slateblue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;filtered theta&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spike_theta</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">),</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;spike times&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;LFP (a.u.)&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_position</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;animal position&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_position</span><span class="p">[(</span><span class="n">ex_position</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">values</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ex_position</span> <span class="o">&lt;</span> <span class="mi">130</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;place field bounds&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Position (cm)&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Figure check</p>
<p><img alt="" src="../../_images/pc-09.png" /></p>
</div>
<p>As the animal runs through unit 177’s place field (thick green), the unit spikes (orange dots) at specific points along the theta cycle dependent on position: starting at the rising edge, moving towards the trough, and ending at the falling edge.</p>
<p>We can exemplify this pattern by plotting the spike times aligned to the phase of theta. We’ll want the corresponding phase of theta at which the unit fires as the animal is running down the track, which we can again compute using the method <a class="reference external" href="https://pynapple.org/generated/pynapple.TsGroup.value_from.html"><code class="docutils literal notranslate"><span class="pre">value_from</span></code></a>.</p>
</section>
<section id="compute-the-value-of-theta-phase-corresponding-to-each-spike-time-from-unit-177">
<h4>7. Compute the value of <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code> corresponding to each spike time from unit 177.<a class="headerlink" href="#compute-the-value-of-theta-phase-corresponding-to-each-spike-time-from-unit-177" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spike_phase</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>To visualize the results, we’ll recreate the plot above, but instead with the theta phase.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span><span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_band</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;slateblue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;filtered theta&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spike_theta</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">),</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;spike times&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;LFP (a.u.)&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Spike times relative to filtered theta&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_phase</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;slateblue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;theta phase&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spike_phase</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">),</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;spike times&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Phase (rad)&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Spike times relative to theta phase&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_position</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;animal position&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_position</span><span class="p">[(</span><span class="n">ex_position</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">values</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ex_position</span> <span class="o">&lt;</span> <span class="mi">130</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;place field bounds&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Position (cm)&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Animal position&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Figure check</p>
<p><img alt="" src="../../_images/pc-10.png" /></p>
</div>
<p>We now see a negative trend in the spike phase as the animal moves through unit 177’s place field. This phemomena is known as phase precession: the phase at which a unit spikes <em>precesses</em> (gets earlier) as the animal runs through that unit’s place field. Explicitly, that unit will spike at <em>late</em> phases of theta (higher radians) in <em>earlier</em> positions in the field, and fire at <em>early</em> phases of theta (lower radians) in <em>late</em> positions in the field.</p>
<p>We can observe this phenomena on average across the session by relating the spike phase to the spike position.</p>
</section>
<section id="compute-the-position-corresponding-to-each-spike-for-example-unit-177">
<h4>8. Compute the position corresponding to each spike for example unit 177.<a class="headerlink" href="#compute-the-position-corresponding-to-each-spike-for-example-unit-177" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spike_position</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>Now we can plot the spike phase against the spike position in a scatter plot.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">axs</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spike_position</span><span class="p">,</span> <span class="n">spike_phase</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Phase (rad)&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Position (cm)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Figure check</p>
<p><img alt="" src="../../_images/pc-11.png" /></p>
</div>
<p>Similar to what we saw in a single run, there is a negative relationship between theta phase and field position, characteristic of phase precession.</p>
</section>
</section>
</section>
<section id="part-4-2d-neural-tuning-and-model-fitting">
<h2>Part 4: 2D neural tuning and model fitting<a class="headerlink" href="#part-4-2d-neural-tuning-and-model-fitting" title="Link to this heading">#</a></h2>
<section id="computing-2d-tuning-curves-position-vs-phase">
<h3>Computing 2D tuning curves: position vs. phase<a class="headerlink" href="#computing-2d-tuning-curves-position-vs-phase" title="Link to this heading">#</a></h3>
<p>The scatter plot above can be similarly be represented as a 2D tuning curve over position and phase. We can compute this using the same function, <a class="reference external" href="https://pynapple.org/generated/pynapple.process.tuning_curves.html#pynapple.process.tuning_curves.compute_tuning_curves"><code class="docutils literal notranslate"><span class="pre">nap.compute_tuning_curves</span></code></a>, but now passing second input, <code class="docutils literal notranslate"><span class="pre">features</span></code>, as a 2-column <code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code> containing the two target features.</p>
<p>To do this, we’ll need to combine <code class="docutils literal notranslate"><span class="pre">position</span></code> and <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code> into a <code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code>. For this to work, both variables must have the same length. Similar to what we did in Part 2, we can achieve this by upsampling <code class="docutils literal notranslate"><span class="pre">position</span></code> to the length of <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code> using the pynapple object method <a class="reference external" href="https://pynapple.org/generated/pynapple.Tsd.interpolate.html"><code class="docutils literal notranslate"><span class="pre">interpolate</span></code></a>. Once they’re the same length, they can be combined into a single <code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code> and used to compute 2D tuning curves.</p>
<section id="interpolate-position-to-the-time-points-of-theta-phase">
<h4>1. Interpolate <code class="docutils literal notranslate"><span class="pre">position</span></code> to the time points of <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code>.<a class="headerlink" href="#interpolate-position-to-the-time-points-of-theta-phase" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">upsampled_pos</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
</section>
<section id="stack-upsampled-pos-and-theta-phase-together-into-a-single-tsdframe">
<h4>2. Stack <code class="docutils literal notranslate"><span class="pre">upsampled_pos</span></code> and <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code> together into a single <a class="reference external" href="https://pynapple.org/generated/pynapple.TsdFrame.html"><code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code></a><a class="headerlink" href="#stack-upsampled-pos-and-theta-phase-together-into-a-single-tsdframe" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>For stacking arrays, you can use a numpy function like <code class="docutils literal notranslate"><span class="pre">np.stack</span></code>.</p>
<ul>
<li><p>Tip: you may need to transpose to make sure time is in the first dimension of the stacked array</p></li>
</ul>
</li>
<li><p>Make sure to name your <code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code> columns <code class="docutils literal notranslate"><span class="pre">&quot;position&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;phase&quot;</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># store the resulting TsdFrame into the following variable</span>
<span class="n">features</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
</section>
<section id="apply-nap-compute-tuning-curves-with-features-on-our-subselected-group-of-units-good-spikes">
<h4>3. Apply <a class="reference external" href="https://pynapple.org/generated/pynapple.process.tuning_curves.html#pynapple.process.tuning_curves.compute_tuning_curves"><code class="docutils literal notranslate"><span class="pre">nap.compute_tuning_curves</span></code></a> with <code class="docutils literal notranslate"><span class="pre">features</span></code> on our subselected group of units, <code class="docutils literal notranslate"><span class="pre">good_spikes</span></code><a class="headerlink" href="#apply-nap-compute-tuning-curves-with-features-on-our-subselected-group-of-units-good-spikes" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Use 50 bins for position and 30 bins for theta phase</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tuning_curves</span> <span class="o">=</span>
</pre></div>
</div>
</div>
</div>
<p>We can plot 2D tuning curves for each unit and phase precession in some example units.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">neurons</span> <span class="o">=</span> <span class="p">[</span><span class="mi">23</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="mi">177</span><span class="p">,</span> <span class="mi">220</span><span class="p">]</span>
<span class="n">tc_norm</span> <span class="o">=</span> <span class="n">tuning_curves</span> <span class="o">/</span> <span class="n">tuning_curves</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">tc_norm</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">neurons</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;phase&quot;</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;unit&quot;</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Figure check</p>
<p><img alt="" src="../../_images/pc-11.png" /></p>
</div>
<p>You should be able to notice a negative relationship between position and phase, characteristic of phase precession.</p>
</section>
</section>
<section id="estimating-2d-tuning-curves-using-2d-basis-functions">
<h3>Estimating 2D tuning curves using 2D basis functions<a class="headerlink" href="#estimating-2d-tuning-curves-using-2d-basis-functions" title="Link to this heading">#</a></h3>
<p>How can we model 2D tuning curves in a GLM? Similar to Part 2, we can define a 2D basis by using <a class="reference external" href="https://nemos.readthedocs.io/en/latest/background/basis/plot_02_ND_basis_function.html">NeMoS basis composition</a>, but instead <em>multiplying</em> two basis objects. In fact, we can use both addition and multiplication together to create arbitrarily complex, multidimensional basis objects.</p>
<p>First, we’ll create a basis object for theta phase, specifically using <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/basis/nemos.basis.CyclicBSplineEval.html#nemos.basis.BSplineEval"><code class="docutils literal notranslate"><span class="pre">CyclicBSplineEval</span></code></a>.</p>
<section id="instantiate-a-cyclicbsplineeval-basis-object-for-phase-using-10-basis-functions">
<h4>4. Instantiate a <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/basis/nemos.basis.CyclicBSplineEval.html#nemos.basis.BSplineEval"><code class="docutils literal notranslate"><span class="pre">CyclicBSplineEval</span></code></a> basis object for phase, using 10 basis functions.<a class="headerlink" href="#instantiate-a-cyclicbsplineeval-basis-object-for-phase-using-10-basis-functions" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Provide the label <code class="docutils literal notranslate"><span class="pre">&quot;phase&quot;</span></code> for the basis.</p></li>
<li><p>If necessary, reinstantiate the basis objects for position, <code class="docutils literal notranslate"><span class="pre">position_basis</span></code>, and speed, <code class="docutils literal notranslate"><span class="pre">speed_basis</span></code>, as you did in Part 2 question 6.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">phase_basis</span> <span class="o">=</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-the-full-basis-by-multiplying-position-basis-and-phase-basis-and-adding-speed-basis">
<h4>5. Create the full basis by multiplying <code class="docutils literal notranslate"><span class="pre">position_basis</span></code> and <code class="docutils literal notranslate"><span class="pre">phase_basis</span></code> and adding <code class="docutils literal notranslate"><span class="pre">speed_basis</span></code>.<a class="headerlink" href="#create-the-full-basis-by-multiplying-position-basis-and-phase-basis-and-adding-speed-basis" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">full_basis</span> <span class="o">=</span>
</pre></div>
</div>
</div>
</div>
<p>Before we can call <code class="docutils literal notranslate"><span class="pre">compute_features</span></code>, we need to make sure <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code> has the same number of time points as <code class="docutils literal notranslate"><span class="pre">counts</span></code>. Since <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code> has <em>more</em> time points than counts, we’ll need to <em>downsample</em> the number of time points. We can do this using the pynapple object method <a class="reference external" href="https://pynapple.org/generated/pynapple.Tsd.bin_average.html"><code class="docutils literal notranslate"><span class="pre">bin_average</span></code></a>. This function will average values within a specified bin size. We can achieve the same sampling rate by using the same bin size as we used for our spike counts.</p>
</section>
<section id="downsample-theta-phase-using-bin-average-and-a-bin-size-of-0-01-s">
<h4>6. Downsample <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code> using <code class="docutils literal notranslate"><span class="pre">bin_average</span></code> and a bin size of 0.01 s.<a class="headerlink" href="#downsample-theta-phase-using-bin-average-and-a-bin-size-of-0-01-s" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>If necessary, redefine <code class="docutils literal notranslate"><span class="pre">up_position</span></code> and <code class="docutils literal notranslate"><span class="pre">up_speed</span></code> the same as Part 2 question 5</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">bin_theta</span> <span class="o">=</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-design-matrix-by-calling-compute-features-on-full-basis-using-up-position-bin-theta-and-up-speed">
<h4>7. Create a design matrix by calling <code class="docutils literal notranslate"><span class="pre">compute_features</span></code> on <code class="docutils literal notranslate"><span class="pre">full_basis</span></code> using <code class="docutils literal notranslate"><span class="pre">up_position</span></code>, <code class="docutils literal notranslate"><span class="pre">bin_theta</span></code>, and <code class="docutils literal notranslate"><span class="pre">up_speed</span></code><a class="headerlink" href="#create-a-design-matrix-by-calling-compute-features-on-full-basis-using-up-position-bin-theta-and-up-speed" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">bin_theta</span> <span class="o">=</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id1">
<h4>8. Fit a GLM by doing the following:<a class="headerlink" href="#id1" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Initialize <code class="docutils literal notranslate"><span class="pre">PopulationGLM</span></code></p></li>
<li><p>Use the “LBFGS” solver and pass <code class="docutils literal notranslate"><span class="pre">{&quot;tol&quot;:</span> <span class="pre">1e-12}</span></code> to <code class="docutils literal notranslate"><span class="pre">solver_kwargs</span></code>.</p></li>
<li><p>Fit the data, passing the design matrix <code class="docutils literal notranslate"><span class="pre">X</span></code> and spike counts <code class="docutils literal notranslate"><span class="pre">counts</span></code> to the glm object.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">bin_theta</span> <span class="o">=</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id2">
<h4>9. Use <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.GLM.predict.html#nemos.glm.GLM.predict"><code class="docutils literal notranslate"><span class="pre">predict</span></code></a> to calculated the predicted firing rate of our model. Use the predicted rate to compute predicted tuning curves using <a class="reference external" href="https://pynapple.org/generated/pynapple.process.tuning_curves.html#pynapple.process.tuning_curves.compute_tuning_curves"><code class="docutils literal notranslate"><span class="pre">nap.compute_tuning_curves</span></code></a>.<a class="headerlink" href="#id2" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Remember to convert the predicted firing rate to spikes per second!</p></li>
<li><p>Compute 1D tuning curves for position and speeds in the same way as Part 2 question 10.</p></li>
<li><p>Compute 2D tuning curves for position x phase using <code class="docutils literal notranslate"><span class="pre">predicted_rate</span></code> and the TsdFrame <code class="docutils literal notranslate"><span class="pre">features</span></code>, using 50 bins for position and 30 bins for phase.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># predict the model&#39;s firing rate</span>
<span class="n">predicted_rate</span> <span class="o">=</span>
<span class="c1"># compute the 1D tuning curves for position and speed</span>
<span class="n">glm_pf</span> <span class="o">=</span> 
<span class="n">glm_speed</span> <span class="o">=</span> 
<span class="c1"># compute 2D tuning curves for position x phase</span>
<span class="n">glm_pos_theta</span> <span class="o">=</span>   
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Figure check</p>
<p><img alt="" src="../../_images/pc-12.png" /></p>
</div>
</section>
</section>
<section id="bonus-exercise">
<h3>Bonus Exercise<a class="headerlink" href="#bonus-exercise" title="Link to this heading">#</a></h3>
<p>As an bonus, more open-ended exercise, we can investigate all the scientific decisions that we swept under the rug: should we regularize the model? What basis should we use? Do we need all inputs? If you’re feeling ambitious, here are some suggestions to answer these questions:</p>
<ul class="simple">
<li><p>Try to fit and compare the results we just obtained with different models:</p>
<ul>
<li><p>A model with position as the only predictor.</p></li>
<li><p>A model with speed as the only predictor.</p></li>
<li><p>A model with phase as the only predictor</p></li>
</ul>
</li>
<li><p>Introduce L1 (Lasso) regularization and fit models with increasingly large penalty strengths (<span class="math notranslate nohighlight">\(\lambda\)</span>). Plot the regularization path showing how each coefficient changes with <span class="math notranslate nohighlight">\(\lambda\)</span>. Identify which coefficients remain non-zero longest as <span class="math notranslate nohighlight">\(\lambda\)</span> increases - these correspond to the most informative predictors.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># enter code here</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="part-5-neural-decoding">
<h2>Part 5: Neural decoding<a class="headerlink" href="#part-5-neural-decoding" title="Link to this heading">#</a></h2>
<section id="decoding-position-from-spiking-activity">
<h3>Decoding position from spiking activity<a class="headerlink" href="#decoding-position-from-spiking-activity" title="Link to this heading">#</a></h3>
<p>Finally we’ll do a popular analysis in the rat hippocampus sphere: Bayesian decoding. This analysis is an elegent application of Bayes’ rule in predicting the animal’s location (or other behavioral variables) given neural activity at some point in time. Refer to the dropdown box below for a more in-depth explanation.</p>
<div class="dropdown admonition">
<p class="admonition-title">Background: Bayesian decoding</p>
<p>Recall Bayes’ rule, written here in terms of our relevant variables:</p>
<div class="math notranslate nohighlight">
\[P(position|spikes) = \frac{P(position)P(spikes|position)}{P(spikes)}\]</div>
<p>Our goal is to compute the unknown posterior <span class="math notranslate nohighlight">\(P(position|spikes)\)</span> given known prior <span class="math notranslate nohighlight">\(P(position)\)</span> and known likelihood <span class="math notranslate nohighlight">\(P(spikes|position)\)</span>.</p>
<p><span class="math notranslate nohighlight">\(P(position)\)</span>, also known as the <em>occupancy</em>, is the probability that the animal is occupying some position. This can be computed exactly by the proportion of the total time spent at each position, but in many cases it is sufficient to estimate the occupancy as a uniform distribution, i.e. it is equally likely for the animal to occupy any location.</p>
<p>The next term, <span class="math notranslate nohighlight">\(P(spikes|position)\)</span>, which is the probability of seeing some sequence of spikes across all neurons at some position. Computing this relys on the following assumptions:</p>
<ol class="arabic simple">
<li><p>Neurons fire according to a Poisson process (i.e. their spiking activity follows a Poisson distribution)</p></li>
<li><p>Neurons fire independently from one another.</p></li>
</ol>
<p>While neither of these assumptions are strictly true, they are generally reasonable for pyramidal cells in hippocampus and allow us to simplify our computation of <span class="math notranslate nohighlight">\(P(spikes|position)\)</span></p>
<p>The first assumption gives us an equation for <span class="math notranslate nohighlight">\(P(spikes|position)\)</span> for a single neuron, which we’ll call <span class="math notranslate nohighlight">\(P(spikes_i|position)\)</span> to differentiate it from <span class="math notranslate nohighlight">\(P(spikes|position) = P(spikes_1,spikes_2,...,spikes_N|position)\)</span>, or the total probability across all <span class="math notranslate nohighlight">\(N\)</span> neurons. The equation we get is that of the Poisson distribution:</p>
<div class="math notranslate nohighlight">
\[
P(spikes_i|position) = \frac{(\tau f_i(position))^n e^{-\tau f_i(position)}}{n!}
\]</div>
<p>where <span class="math notranslate nohighlight">\(f_i(position)\)</span> is the firing rate of the neuron at position <span class="math notranslate nohighlight">\((position)\)</span> (i.e. the tuning curve), <span class="math notranslate nohighlight">\(\tau\)</span> is the width of the time window over which we’re computing the probability, and <span class="math notranslate nohighlight">\(n\)</span> is the total number of times the neuron spiked in the time window of interest.</p>
<p>The second assumptions allows us to simply combine the probabilities of individual neurons. Recall the product rule for independent events: <span class="math notranslate nohighlight">\(P(A,B) = P(A)P(B)\)</span> if <span class="math notranslate nohighlight">\(A\)</span> and <span class="math notranslate nohighlight">\(B\)</span> are independent. Treating neurons as independent, then, gives us the following:</p>
<div class="math notranslate nohighlight">
\[
P(spikes|position) = \prod_i P(spikes_i|position)
\]</div>
<p>The final term, <span class="math notranslate nohighlight">\(P(spikes)\)</span>, is inferred indirectly using the law of total probability:</p>
<div class="math notranslate nohighlight">
\[P(spikes) = \sum_{position}P(position,spikes) = \sum_{position}P(position)P(spikes|position)\]</div>
<p>Another way of putting it is <span class="math notranslate nohighlight">\(P(spikes)\)</span> is the normalization factor such that <span class="math notranslate nohighlight">\(\sum_{position} P(position|spikes) = 1\)</span>, which is achived by dividing the numerator by its sum.</p>
<p>If this method looks daunting, we have some good news: pynapple has it implemented already in the function <code class="docutils literal notranslate"><span class="pre">nap.decode_bayes</span></code>. All we’ll need are the spikes, the tuning curves, and the width of the time window <span class="math notranslate nohighlight">\(\tau\)</span>.</p>
</div>
<div class="tip admonition" id="phase-precess-cv-users">
<p class="admonition-title">Aside: Cross-validation</p>
<p>Generally this method is cross-validated, which means you train the model on one set of data and test the model on a different, held-out data set. For Bayesian decoding, the “model” refers to the model <em>likelihood</em>, which is computed from the tuning curves.</p>
<p>If we want to decode an example run down the track, our training set should omit this run before computing the tuning curves. We can do this by using the IntervalSet method <code class="docutils literal notranslate"><span class="pre">set_diff</span></code>, to take out the example run epoch from all run epochs. Next, we’ll restrict our data to these training epochs and re-compute the place fields using <code class="docutils literal notranslate"><span class="pre">nap.compute_tuning_curves</span></code>. We’ll also apply a Gaussian smoothing filter to the place fields, which will smooth our decoding results down the line.</p>
<p>The code cell below will do these steps for you.</p>
</div>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_filter1d</span>
<span class="c1"># hold out trial from place field computation</span>
<span class="n">run_train</span> <span class="o">=</span> <span class="n">forward_ep</span><span class="o">.</span><span class="n">set_diff</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">)</span>
<span class="c1"># get position of training set</span>
<span class="n">position_train</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">run_train</span><span class="p">)</span>
<span class="c1"># compute place fields using training set</span>
<span class="n">place_fields</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">compute_tuning_curves</span><span class="p">(</span><span class="n">spikes</span><span class="p">,</span> <span class="n">position_train</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">])</span>
<span class="c1"># smooth place fields</span>
<span class="n">place_fields</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">gaussian_filter1d</span><span class="p">(</span><span class="n">place_fields</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># plot sorted, normalized tuning curves</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">place_fields</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">place_fields_sorted</span> <span class="o">=</span> <span class="n">place_fields</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
<span class="n">place_fields_sorted</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">place_fields_sorted</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">place_fields_sorted</span> <span class="o">/</span> <span class="n">place_fields_sorted</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Figure check</p>
<p><img alt="" src="../../_images/pc-13.png" /></p>
</div>
<p>We can decode any number of features using the function <a class="reference external" href="https://pynapple.org/generated/pynapple.process.decoding.html#pynapple.process.decoding.decode_bayes"><code class="docutils literal notranslate"><span class="pre">nap.decode_bayes</span></code></a>, which will decode any number of features given by the input <code class="docutils literal notranslate"><span class="pre">tuning_curves</span></code>, computed by <a class="reference external" href="https://pynapple.org/generated/pynapple.process.tuning_curves.html#pynapple.process.tuning_curves.compute_tuning_curves"><code class="docutils literal notranslate"><span class="pre">nap.compute_tuning_curves</span></code></a>.</p>
<section id="use-nap-decode-bayes-to-decode-position-during-ex-run-ep">
<h4>1. Use <a class="reference external" href="https://pynapple.org/generated/pynapple.process.decoding.html#pynapple.process.decoding.decode_bayes"><code class="docutils literal notranslate"><span class="pre">nap.decode_bayes</span></code></a> to decode position during <code class="docutils literal notranslate"><span class="pre">ex_run_ep</span></code><a class="headerlink" href="#use-nap-decode-bayes-to-decode-position-during-ex-run-ep" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Use 40 ms time bins</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">decoded_position</span><span class="p">,</span> <span class="n">decoded_prob</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>Let’s plot decoded position with the animal’s true position. We’ll overlay them on a heat map of the decoded probability to visualize the confidence of the decoder.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">decoded_position</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">place_fields</span><span class="o">.</span><span class="n">position</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">decoded_prob</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">decoded_position</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;decoded position&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_position</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;true position&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;decoded probability&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Position (cm)&quot;</span><span class="p">,</span> <span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Figure check</p>
<p><img alt="" src="../../_images/pc-14.png" /></p>
</div>
<p>While the decoder generally follows the animal’s true position, there is still a lot of error in the decoder, especially later in the run. We can improve the decoder error by smoothing the spike counts. <a class="reference external" href="https://pynapple.org/generated/pynapple.process.decoding.html#pynapple.process.decoding.decode_bayes"><code class="docutils literal notranslate"><span class="pre">nap.decode_bayes</span></code></a> provides the option to do this for you by specifying <code class="docutils literal notranslate"><span class="pre">sliding_window_size</span></code>, which specifies the width, in number of bins, of a uniform (all ones) kernel to convolve with the spike counts. This is equivalent to applying a moving sum to adjacent bins, where the width of the kernel is the number of adjacent bins being added together. This is equivalent to counting spikes in a <em>sliding window</em> that shifts in shorter increments than the window’s width, resulting in bins that overlap. This combines the accuracy of using a wider time bin with the temporal resolution of a shorter time bin.</p>
<p>For example, let’s say we want a sliding window of <span class="math notranslate nohighlight">\(200 ms\)</span> that shifts by <span class="math notranslate nohighlight">\(40 ms\)</span>. This is equivalent to summing together 5 adjacent <span class="math notranslate nohighlight">\(40 ms\)</span> bins, or convolving spike counts in <span class="math notranslate nohighlight">\(40 ms\)</span> bins with a length-5 array of ones (<span class="math notranslate nohighlight">\([1, 1, 1, 1, 1]\)</span>). Let’s visualize this convolution.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ex_counts</span> <span class="o">=</span> <span class="n">spikes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">workshop_utils</span><span class="o">.</span><span class="n">animate_1d_convolution</span><span class="p">(</span><span class="n">ex_counts</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">tsd_label</span><span class="o">=</span><span class="s2">&quot;original counts&quot;</span><span class="p">,</span> <span class="n">kernel_label</span><span class="o">=</span><span class="s2">&quot;moving sum&quot;</span><span class="p">,</span> <span class="n">conv_label</span><span class="o">=</span><span class="s2">&quot;convolved counts&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The count at each time point is computed by convolving the kernel (yellow), centered at that time point, with the original spike counts (blue). For a length-5 kernel of ones, this amounts to summing the counts in the center bin with two bins before and two bins after (shaded green, top). The result is an array of counts smoothed out in time (green, bottom).</p>
</section>
<section id="decode-the-same-run-as-above-now-using-sliding-window-size-of-5-bins">
<h4>2. Decode the same run as above, now using sliding window size of 5 bins.<a class="headerlink" href="#decode-the-same-run-as-above-now-using-sliding-window-size-of-5-bins" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">smth_decoded_position</span><span class="p">,</span> <span class="n">smth_decoded_prob</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>Let’s plot the results.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">smth_decoded_position</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">place_fields</span><span class="o">.</span><span class="n">position</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">smth_decoded_prob</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">smth_decoded_position</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;decoded position&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_position</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;true position&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;decoded probability&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Position (cm)&quot;</span><span class="p">,</span> <span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Figure check</p>
<p><img alt="" src="../../_images/pc-15.png" /></p>
</div>
<p>This gives us a much closer approximation of the animal’s true position.</p>
<p>Units phase precessing together creates fast, spatial sequences around the animal’s true position. We can reveal this by decoding at an even shorter time scale, which will appear as smooth errors in the decoder.</p>
</section>
<section id="decode-again-using-a-smaller-bin-size-of-10-ms-and-sliding-window-size-of-5-bins">
<h4>3. Decode again using a smaller bin size of <span class="math notranslate nohighlight">\(10 ms\)</span> and sliding window size of 5 bins.<a class="headerlink" href="#decode-again-using-a-smaller-bin-size-of-10-ms-and-sliding-window-size-of-5-bins" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">smth_decoded_position</span><span class="p">,</span> <span class="n">smth_decoded_prob</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>We’ll make the same plot as before to visualize the results, but plot it alongside the raw and filtered LFP.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">smth_decoded_prob</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">smth_decoded_prob</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">smth_decoded_prob</span><span class="p">))</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">smth_decoded_position</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_position</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Position (cm)&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="s2">&quot;decoded position&quot;</span><span class="p">,</span><span class="s2">&quot;true position&quot;</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;predicted probability&quot;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfp</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_band</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;LFP (a.u.)&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Figure check</p>
<p><img alt="" src="../../_images/pc-16.png" /></p>
</div>
<p>The estimated position oscillates with cycles of theta, where each “sweep” is referred to as a “theta sequence”. Fully understanding the properties of theta sequences and their role in learning, memory, and planning is an active topic of research in Neuroscience!</p>
</section>
</section>
<section id="bonus-exercise-1">
<h3>Bonus Exercise 1<a class="headerlink" href="#bonus-exercise-1" title="Link to this heading">#</a></h3>
<p>Pynapple has another decoding method, <a class="reference external" href="https://pynapple.org/generated/pynapple.process.decoding.html#pynapple.process.decoding.decode_template"><code class="docutils literal notranslate"><span class="pre">nap.decode_template</span></code></a>, that is agnostic to the underlying noise model of the data. In other words, where the above implementation of Bayesian decoding is specific to spiking data (Poisson distributed data), template decoding can be applied to any data modality. As a bonus exercise, you can try decoding position using this method and compare the results to the Bayesian decoder used above!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># enter code here</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="bonus-exercise-2">
<h3>Bonus Exercise 2<a class="headerlink" href="#bonus-exercise-2" title="Link to this heading">#</a></h3>
<p>Instead of using place fields computed from the data, what if we used the predicted tuning curves by our GLM in Part 2 to do decoding? As a second bonus exercise, you can try Bayesian decoding using GLM-predicted tuning curves and compare the results to the decoding above.</p>
</section>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h2>
<p>The data in this tutorial comes from <a class="reference external" href="https://www.science.org/doi/full/10.1126/science.aad1935">Grosmark, Andres D., and György Buzsáki. “Diversity in neural firing dynamics supports both rigid and learned hippocampal sequences.” Science 351.6280 (2016): 1440-1443</a>.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="03_calcium_imaging_analysis-users.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Calcium imaging analysis of head-direction cells</p>
      </div>
    </a>
    <a class="right-next"
       href="05_visual_coding-users.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Exploring the Allen Institute’s Visual Coding dataset</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-1-data-wrangling">Part 1: Data wrangling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fetching-the-data">Fetching the data</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#units">units</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#rem-nrem-and-forward-ep">rem, nrem, and forward_ep</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#eeg">eeg</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#position">position</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#restricting-the-data-computing-speed-and-visualization">Restricting the data, computing speed, and visualization</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#restrict-position-to-forward-ep-and-confirm-that-there-are-no-nan-values-in-the-restricted-data-set">1. Restrict <code class="docutils literal notranslate"><span class="pre">position</span></code> to <code class="docutils literal notranslate"><span class="pre">forward_ep</span></code> and confirm that there are no <code class="docutils literal notranslate"><span class="pre">nan</span></code> values in the restricted data set.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-velocity-using-the-derivative-method-on-position-during-forward-runs-use-np-abs-to-convert-the-velocity-into-speed">2. Calculate velocity using the <code class="docutils literal notranslate"><span class="pre">derivative</span></code> method on position during forward runs. Use <code class="docutils literal notranslate"><span class="pre">np.abs</span></code> to convert the velocity into speed.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-an-interval-set-for-forward-run-index-9-adding-2-seconds-to-the-end-of-the-interval-restrict-lfp-and-position-to-this-epoch">3. Create an interval set for forward run index 9, adding 2 seconds to the end of the interval. Restrict <code class="docutils literal notranslate"><span class="pre">lfp</span></code> and <code class="docutils literal notranslate"><span class="pre">position</span></code> to this epoch.</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-2-1d-neural-tuning-and-model-fitting">Part 2: 1D neural tuning and model fitting</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-1d-tuning-curves-place-fields">Computing 1D tuning curves: place fields</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#restrict-spikes-to-forward-ep-and-select-for-units-whose-rate-is-at-least-1-hz-and-at-most-10-hz">1. Restrict <code class="docutils literal notranslate"><span class="pre">spikes</span></code> to <code class="docutils literal notranslate"><span class="pre">forward_ep</span></code> and select for units whose rate is at least 1 Hz and at most 10 Hz</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-tuning-curves-with-respect-to-position-for-units-in-good-spikes">2. Compute tuning curves with respect to <code class="docutils literal notranslate"><span class="pre">position</span></code> for units in <code class="docutils literal notranslate"><span class="pre">good_spikes</span></code>.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-tuning-curves-with-respect-to-speed-for-units-in-good-spikes">3. Compute tuning curves with respect to <code class="docutils literal notranslate"><span class="pre">speed</span></code> for units in <code class="docutils literal notranslate"><span class="pre">good_spikes</span></code>.</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-tuning-curves-using-a-population-glm">Estimating tuning curves using a population GLM</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-observations-by-counting-spikes-using-the-pynapple-method-count-on-our-tsgroup-of-spike-times-good-spikes">4. Compute observations by counting spikes, using the pynapple method <code class="docutils literal notranslate"><span class="pre">count</span></code>, on our <code class="docutils literal notranslate"><span class="pre">TsGroup</span></code> of spike times, <code class="docutils literal notranslate"><span class="pre">good_spikes</span></code>.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#upsample-position-and-speed-using-the-pynapple-method-interpolate-with-the-time-stamps-from-counts">5. Upsample <code class="docutils literal notranslate"><span class="pre">position</span></code> and <code class="docutils literal notranslate"><span class="pre">speed</span></code> using the pynapple method <code class="docutils literal notranslate"><span class="pre">interpolate</span></code> with the time stamps from <code class="docutils literal notranslate"><span class="pre">counts</span></code>.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#instantiate-the-basis-by-doing-the-following">6. Instantiate the basis by doing the following:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-an-additive-basis-by-adding-together-position-basis-and-speed-basis">7. Create an additive basis by adding together <code class="docutils literal notranslate"><span class="pre">position_basis</span></code> and <code class="docutils literal notranslate"><span class="pre">speed_basis</span></code>.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-design-matrix-by-passing-up-position-and-up-speed-to-the-basis-method-compute-features">8. Create a design matrix by passing <code class="docutils literal notranslate"><span class="pre">up_position</span></code> and <code class="docutils literal notranslate"><span class="pre">up_speed</span></code> to the basis method <code class="docutils literal notranslate"><span class="pre">compute_features</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-a-glm-by-doing-the-following">9. Fit a GLM by doing the following:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#use-predict-to-calculated-the-predicted-firing-rate-of-our-model-use-the-predicted-rate-to-compute-predicted-tuning-curves-using-nap-compute-tuning-curves">10. Use <code class="docutils literal notranslate"><span class="pre">predict</span></code> to calculated the predicted firing rate of our model. Use the predicted rate to compute predicted tuning curves using <code class="docutils literal notranslate"><span class="pre">nap.compute_tuning_curves</span></code>.</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-3-signal-processing">Part 3: Signal processing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-the-wavelet-decomposition">Getting the Wavelet Decomposition</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#define-100-log-spaced-samples-between-5-and-200-hz-using-np-geomspace">1. Define 100 log-spaced samples between 5 and 200 Hz using <code class="docutils literal notranslate"><span class="pre">np.geomspace</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-the-wavelet-transform-of-ex-lfp-using-freqs-defined-above">2. Compute the wavelet transform of <code class="docutils literal notranslate"><span class="pre">ex_lfp</span></code> using <code class="docutils literal notranslate"><span class="pre">freqs</span></code> defined above.</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-theta-phase">Computing theta phase</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#restrict-lfp-to-forward-ep">3. Restrict <code class="docutils literal notranslate"><span class="pre">lfp</span></code> to <code class="docutils literal notranslate"><span class="pre">forward_ep</span></code>.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#using-nap-apply-bandpass-filter-filter-lfp-for-theta-within-a-6-12-hz-range">4. Using <code class="docutils literal notranslate"><span class="pre">nap.apply_bandpass_filter</span></code>, filter <code class="docutils literal notranslate"><span class="pre">lfp</span></code> for theta within a 6-12 Hz range.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#use-sp-signal-hilbert-to-perform-the-hilbert-transform-of-theta-band-using-np-angle-to-extract-the-angle-convert-the-output-angle-to-a-0-2pi-range-and-store-the-result-in-a-tsd-object">5. Use <code class="docutils literal notranslate"><span class="pre">sp.signal.hilbert</span></code> to perform the Hilbert transform of <code class="docutils literal notranslate"><span class="pre">theta_band</span></code>, using <code class="docutils literal notranslate"><span class="pre">np.angle</span></code> to extract the angle. Convert the output angle to a [0, 2pi] range, and store the result in a <code class="docutils literal notranslate"><span class="pre">Tsd</span></code> object.</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-phase-precession-within-a-single-unit">Visualizing phase precession within a single unit</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#use-the-pynapple-object-method-value-from-to-find-the-value-of-theta-band-corresponding-to-each-spike-time-from-unit-177">6. Use the pynapple object method <code class="docutils literal notranslate"><span class="pre">value_from</span></code> to find the value of <code class="docutils literal notranslate"><span class="pre">theta_band</span></code> corresponding to each spike time from unit 177.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-the-value-of-theta-phase-corresponding-to-each-spike-time-from-unit-177">7. Compute the value of <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code> corresponding to each spike time from unit 177.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-the-position-corresponding-to-each-spike-for-example-unit-177">8. Compute the position corresponding to each spike for example unit 177.</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-4-2d-neural-tuning-and-model-fitting">Part 4: 2D neural tuning and model fitting</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-2d-tuning-curves-position-vs-phase">Computing 2D tuning curves: position vs. phase</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#interpolate-position-to-the-time-points-of-theta-phase">1. Interpolate <code class="docutils literal notranslate"><span class="pre">position</span></code> to the time points of <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code>.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#stack-upsampled-pos-and-theta-phase-together-into-a-single-tsdframe">2. Stack <code class="docutils literal notranslate"><span class="pre">upsampled_pos</span></code> and <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code> together into a single <code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#apply-nap-compute-tuning-curves-with-features-on-our-subselected-group-of-units-good-spikes">3. Apply <code class="docutils literal notranslate"><span class="pre">nap.compute_tuning_curves</span></code> with <code class="docutils literal notranslate"><span class="pre">features</span></code> on our subselected group of units, <code class="docutils literal notranslate"><span class="pre">good_spikes</span></code></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#estimating-2d-tuning-curves-using-2d-basis-functions">Estimating 2D tuning curves using 2D basis functions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#instantiate-a-cyclicbsplineeval-basis-object-for-phase-using-10-basis-functions">4. Instantiate a <code class="docutils literal notranslate"><span class="pre">CyclicBSplineEval</span></code> basis object for phase, using 10 basis functions.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-the-full-basis-by-multiplying-position-basis-and-phase-basis-and-adding-speed-basis">5. Create the full basis by multiplying <code class="docutils literal notranslate"><span class="pre">position_basis</span></code> and <code class="docutils literal notranslate"><span class="pre">phase_basis</span></code> and adding <code class="docutils literal notranslate"><span class="pre">speed_basis</span></code>.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#downsample-theta-phase-using-bin-average-and-a-bin-size-of-0-01-s">6. Downsample <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code> using <code class="docutils literal notranslate"><span class="pre">bin_average</span></code> and a bin size of 0.01 s.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-design-matrix-by-calling-compute-features-on-full-basis-using-up-position-bin-theta-and-up-speed">7. Create a design matrix by calling <code class="docutils literal notranslate"><span class="pre">compute_features</span></code> on <code class="docutils literal notranslate"><span class="pre">full_basis</span></code> using <code class="docutils literal notranslate"><span class="pre">up_position</span></code>, <code class="docutils literal notranslate"><span class="pre">bin_theta</span></code>, and <code class="docutils literal notranslate"><span class="pre">up_speed</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">8. Fit a GLM by doing the following:</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">9. Use <code class="docutils literal notranslate"><span class="pre">predict</span></code> to calculated the predicted firing rate of our model. Use the predicted rate to compute predicted tuning curves using <code class="docutils literal notranslate"><span class="pre">nap.compute_tuning_curves</span></code>.</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-exercise">Bonus Exercise</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#part-5-neural-decoding">Part 5: Neural decoding</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decoding-position-from-spiking-activity">Decoding position from spiking activity</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#use-nap-decode-bayes-to-decode-position-during-ex-run-ep">1. Use <code class="docutils literal notranslate"><span class="pre">nap.decode_bayes</span></code> to decode position during <code class="docutils literal notranslate"><span class="pre">ex_run_ep</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#decode-the-same-run-as-above-now-using-sliding-window-size-of-5-bins">2. Decode the same run as above, now using sliding window size of 5 bins.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#decode-again-using-a-smaller-bin-size-of-10-ms-and-sliding-window-size-of-5-bins">3. Decode again using a smaller bin size of <span class="math notranslate nohighlight">\(10 ms\)</span> and sliding window size of 5 bins.</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-exercise-1">Bonus Exercise 1</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-exercise-2">Bonus Exercise 2</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Edoardo Balzani, Billy Broderick, Sarah Jo Venditto, Guillaume Viejo
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025, Edoardo Balzani, Billy Broderick, Sarah Jo Venditto, Guillaume Viejo.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>