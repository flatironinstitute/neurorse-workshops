
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Exploring the Visual Coding Dataset &#8212; CCN software workshop, SfN 2025  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=f4437bd1" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'presenters/day2/visual_coding-presenters';</script>
    <link rel="icon" href="../../_static/ccn_small.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="Model selection" href="place_cells-presenters.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/01-FI-primary-logo-color.png" class="logo__image only-light" alt="Home"/>
    <script>document.write(`<img src="../../_static/03-FI-primary-logo-white.png" class="logo__image only-dark" alt="Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/flatironinstitute/ccn-software-sfn-2025" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://flatironinstitute.github.io/neurorse-workshops/" title="Workshops home" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-house fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Workshops home</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://binder.flatironinstitute.org/v2/user/wbroderick/sfn2025?labpath=notebooks/" title="Binder" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="https://mybinder.org/badge_logo.svg" class="icon-link-image" alt="Binder"/></a>
        </li>
</ul></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    Welcome!
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Full notebooks</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../full/day1/fundamentals_of_pynapple.html">Learning the fundamentals of pynapple</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../full/day1/head_direction.html">Data analysis with pynapple &amp; nemos</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../full/day1/phase_precession.html">Signal processing and decoding in pynapple</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../full/day2/current_injection.html">Introduction to GLM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../full/day2/place_cells.html">Model selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../full/day2/visual_coding.html">Exploring the Visual Coding Dataset</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">For users (some code, some text)</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../users/day1/fundamentals_of_pynapple-users.html">Learning the fundamentals of pynapple</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../users/day1/head_direction-users.html">Data analysis with pynapple &amp; nemos</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../users/day1/phase_precession-users.html">Signal processing and decoding in pynapple</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../users/day2/current_injection-users.html">Introduction to GLM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../users/day2/place_cells-users.html">Model selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../users/day2/visual_coding-users.html">Exploring the Visual Coding Dataset</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">For presenter reference (all code, no text)</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../day1/fundamentals_of_pynapple-presenters.html">Learning the fundamentals of pynapple</a></li>
<li class="toctree-l1"><a class="reference internal" href="../day1/head_direction-presenters.html">Data analysis with pynapple &amp; nemos</a></li>

<li class="toctree-l1"><a class="reference internal" href="../day1/phase_precession-presenters.html">Signal processing and decoding in pynapple</a></li>
<li class="toctree-l1"><a class="reference internal" href="current_injection-presenters.html">Introduction to GLM</a></li>
<li class="toctree-l1"><a class="reference internal" href="place_cells-presenters.html">Model selection</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Exploring the Visual Coding Dataset</a></li>




</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/flatironinstitute/ccn-software-sfn-2025" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/presenters/day2/visual_coding-presenters.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Exploring the Visual Coding Dataset</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Exploring the Visual Coding Dataset</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-and-preparing-data">Downloading and preparing data</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#restrict-around-stimuli-presentation">Restrict around stimuli presentation</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#filter-according-to-criterion-3">Filter according to criterion 3</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#get-threshold-for-top-15-most-responsive">Get threshold for top 15% most responsive</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#only-keep-units-that-are-within-the-15-most-responsive-for-either-black-or-white">Only keep units that are within the 15% most responsive for either black or white</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#avoiding-overfitting">Avoiding overfitting</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell tag_hide-input tag_render-all docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="o">%</span><span class="n">load_ext</span> <span class="n">autoreload</span>
<span class="o">%</span><span class="n">autoreload</span> <span class="mi">2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
    <span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;plotting functions contained within `_documentation_utils` are intended for nemos&#39;s documentation.&quot;</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="important render-all admonition">
<p class="admonition-title">Download</p>
<p>This notebook can be downloaded as <strong><a class="reference download internal" download="" href="../../_downloads/399abab6ede7ea7878ea9b4f886f16da/visual_coding-presenters.ipynb"><code class="xref download myst-nb docutils literal notranslate"><span class="pre">visual_coding-presenters.ipynb</span></code></a></strong>. See the button at the top right to download as markdown or pdf.</p>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="exploring-the-visual-coding-dataset">
<h1>Exploring the Visual Coding Dataset<a class="headerlink" href="#exploring-the-visual-coding-dataset" title="Link to this heading">#</a></h1>
<p>This notebook has had all its explanatory text removed and has not been run.
It is intended to be downloaded and run locally (or on the provided binder)
while listening to the presenter’s explanation. In order to see the fully
rendered of this notebook, go <a class="reference internal" href="../../full/day2/visual_coding.html"><span class="std std-doc">here</span></a></p>
<p>This notebook serves as a group project: in groups of 4 or 5, you will analyze data from the <a class="reference external" href="https://portal.brain-map.org/circuits-behavior/visual-coding-neuropixels">Visual Coding - Neuropixels dataset</a>, published by the Allen Institute. This dataset uses <a class="reference external" href="https://www.nature.com/articles/nature24636">extracellular electrophysiology probes</a> to record spikes from multiple regions in the brain during passive visual stimulation.</p>
<p>To start, we will focus on the activity of neurons in the visual cortex (VISp) during passive exposure to full-field flashes of color either black (coded as “-1.0”) or white (coded as “1.0”) in a gray background. If you have time, you can apply the same procedure to other stimuli or brain areas.</p>
<p>For this exercise, you will:</p>
<ul class="simple">
<li><p>Compute Peristimulus Time Histograms (PSTHs) and select relevant neurons to analyze using <code class="docutils literal notranslate"><span class="pre">pynapple</span></code>.</p></li>
<li><p>Fit GLMs to these neurons using <code class="docutils literal notranslate"><span class="pre">nemos</span></code>.</p></li>
</ul>
<p>As this is the last notebook, the instructions are a bit more hands-off: you will make more of the analysis and modeling decisions yourselves. As a group, you will use your neuroscience knowledge and the skills gained over this workshop to decide:</p>
<ul class="simple">
<li><p>How to select relevant neurons.</p></li>
<li><p>How to avoid overfitting.</p></li>
<li><p>What features to include in your GLMs.</p></li>
<li><p>Which basis functions (and parameters) to use for each feature.</p></li>
<li><p>How to regularize your features.</p></li>
<li><p>How to evaluate your model.</p></li>
</ul>
<p>At the end of this session, we will regroup to discuss the decisions people made and evaluate each others’ models.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import everything</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pynapple</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nap</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">nemos</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nmo</span>

<span class="c1"># some helper plotting functions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nemos</span><span class="w"> </span><span class="kn">import</span> <span class="n">_documentation_utils</span> <span class="k">as</span> <span class="n">doc_plots</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">workshop_utils</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="kn">import</span> <span class="n">MaxNLocator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_kde</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">Patch</span>

<span class="c1"># configure plots some</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">nmo</span><span class="o">.</span><span class="n">styles</span><span class="o">.</span><span class="n">plot_style</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="downloading-and-preparing-data">
<h2>Downloading and preparing data<a class="headerlink" href="#downloading-and-preparing-data" title="Link to this heading">#</a></h2>
<p>In this section, we will download the data from DANDI and extract the relevant parts for analysis and modeling. This section is largely presented to you as is, so that you can get to the substantive sections more quickly.</p>
<p>First we download and load the data into pynapple.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dataset information</span>
<span class="n">dandiset_id</span> <span class="o">=</span> <span class="s2">&quot;000021&quot;</span>
<span class="n">dandi_filepath</span> <span class="o">=</span> <span class="s2">&quot;sub-726298249/sub-726298249_ses-754829445.nwb&quot;</span>

<span class="c1"># Download the data using NeMoS</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">fetch</span><span class="o">.</span><span class="n">download_dandi_data</span><span class="p">(</span><span class="n">dandiset_id</span><span class="p">,</span> <span class="n">dandi_filepath</span><span class="p">)</span>

<span class="c1"># load data using pynapple</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">NWBFile</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">lazy_loading</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># grab the spiking data</span>
<span class="n">units</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span>

<span class="c1"># map from electrodes to brain area</span>
<span class="n">channel_probes</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">elec</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">nwb</span><span class="o">.</span><span class="n">electrodes</span><span class="p">:</span>
    <span class="n">channel_id</span> <span class="o">=</span> <span class="n">elec</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">location</span> <span class="o">=</span> <span class="n">elec</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">channel_probes</span><span class="p">[</span><span class="n">channel_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">location</span>

<span class="c1"># Add a new column to include location in our spikes TsGroup</span>
<span class="n">units</span><span class="o">.</span><span class="n">brain_area</span> <span class="o">=</span> <span class="p">[</span><span class="n">channel_probes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ch_id</span><span class="p">)]</span> <span class="k">for</span> <span class="n">ch_id</span> <span class="ow">in</span> <span class="n">units</span><span class="o">.</span><span class="n">peak_channel_id</span><span class="p">]</span>

<span class="c1"># drop unnecessary metadata</span>
<span class="n">units</span><span class="o">.</span><span class="n">restrict_info</span><span class="p">([</span><span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="s2">&quot;quality&quot;</span><span class="p">,</span> <span class="s2">&quot;brain_area&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Now that we have our spiking data, let’s restrict our dataset to the relevant part.</p>
<p><img alt="Visual stimuli set" src="../../_images/visual_stimuli_set.png" /></p>
<p>During the flashes presentation trials, mice were exposed to white or black full-field flashes in a gray background, each lasting 250 ms, and separated by a 2 second inter-trial interval. In total, they were exposed to 150 flashes (75 black, 75 white).</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">flashes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;flashes_presentations&quot;</span><span class="p">]</span>
<span class="n">flashes</span><span class="o">.</span><span class="n">restrict_info</span><span class="p">([</span><span class="s2">&quot;color&quot;</span><span class="p">])</span>

<span class="c1"># create a separate object for black and white flashes</span>
<span class="n">flashes_white</span> <span class="o">=</span> <span class="n">flashes</span><span class="p">[</span><span class="n">flashes</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1.0&quot;</span><span class="p">]</span>
<span class="n">flashes_black</span> <span class="o">=</span> <span class="n">flashes</span><span class="p">[</span><span class="n">flashes</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-1.0&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="render-all">
<div class="dropdown admonition">
<p class="admonition-title">Other stimulus classes?</p>
<p>As can be seen in the image above, there are many other stimulus types shown in this experiment. If you finish analyzing the flashes and want to look at one of the others, you can do so by grabbing the corresponding <code class="docutils literal notranslate"><span class="pre">IntervalSet</span></code> from the <code class="docutils literal notranslate"><span class="pre">data</span></code> object; they are all named <code class="docutils literal notranslate"><span class="pre">{stim_type}_presentations</span></code>, where <code class="docutils literal notranslate"><span class="pre">{stim_type}</span></code> may be <code class="docutils literal notranslate"><span class="pre">flashes</span></code>, <code class="docutils literal notranslate"><span class="pre">gabors</span></code>, <code class="docutils literal notranslate"><span class="pre">static_gratings</span></code>, etc.</p>
</div>
<p>Let’s visualize our stimuli:</p>
</div>
```{code-cell} ipython3
:tags: [render-all, hide-input]
<p>n_flashes = 5
n_seconds = 13
offset = .5</p>
<p>start = data[“flashes_presentations”][“start”].min() - offset
end = start + n_seconds</p>
<p>fig, ax = plt.subplots(figsize = (17, 4))
for flash, c in zip([flashes_white, flashes_black], [“silver”, “black”]):
for fl in flash[:n_flashes]:
ax.axvspan(fl.start[0], fl.end[0], color=c, alpha=.4, ec=c)</p>
<p>plt.xlabel(“Time (s)”)
plt.ylabel(“Absent = 0, Present = 1”)
ax.set_title(“Stimuli presentation”)
ax.yaxis.set_major_locator(MaxNLocator(integer=True))</p>
<p>plt.xlim(start-.1,end)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>## Preliminary analyses and neuron selection


From here on out, you will write the code yourself. This first section will involve us doing some preliminary analyses to find the neurons that are most visually responsive; these are the neurons we will fit our GLM to.

First, let&#39;s construct a {class}`~pynapple.IntervalSet` called `extended_flashes` which contains the peristimulus time. Right now, our `flashes` `IntervalSet` defines the start and end time for the flashes. In order to make sure we can model the pre-stimulus baseline and any responses to the stimulus being turned off, we would like to expand these intervals to go from 500 msecs before the start of the stimuli to 500 msecs after the end.

This `IntervalSet` should be the same shape as `flashes` and have the same metadata columns.


```{code-cell} ipython3
dt = .50 # 500 ms
start = flashes.start - dt # Start 500 ms before stimulus presentation
end = flashes.end + dt # End 500 ms after stimulus presentation

extended_flashes = nap.IntervalSet(start, end, metadata=flashes.metadata) 
</pre></div>
</div>
<p>If you have succeeded, the following should pass:</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">extended_flashes</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">flashes</span><span class="o">.</span><span class="n">shape</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">extended_flashes</span><span class="o">.</span><span class="n">metadata</span> <span class="o">==</span> <span class="n">flashes</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">extended_flashes</span><span class="o">.</span><span class="n">start</span> <span class="o">==</span> <span class="n">flashes</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="mf">.5</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">extended_flashes</span><span class="o">.</span><span class="n">end</span> <span class="o">==</span> <span class="n">flashes</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="mf">.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, create two separate <code class="docutils literal notranslate"><span class="pre">IntervalSet</span></code> objects, <code class="docutils literal notranslate"><span class="pre">extended_flashes_black</span></code> and <code class="docutils literal notranslate"><span class="pre">extended_flashes_white</span></code>, which contain this info for only the black and the white flashes, respectively.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">extended_flashes_white</span> <span class="o">=</span> <span class="n">extended_flashes</span><span class="p">[</span><span class="n">extended_flashes</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1.0&quot;</span><span class="p">]</span>
<span class="n">extended_flashes_black</span> <span class="o">=</span> <span class="n">extended_flashes</span><span class="p">[</span><span class="n">extended_flashes</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-1.0&quot;</span><span class="p">]</span>

<span class="c1"># OR</span>

<span class="n">dt</span> <span class="o">=</span> <span class="mf">.50</span> <span class="c1"># 500 ms</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">flashes_white</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">dt</span> <span class="c1"># Start 500 ms before stimulus presentation</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">flashes_white</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="n">dt</span> <span class="c1"># End 500 ms after stimulus presentation</span>
<span class="n">extended_flashes_white</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">IntervalSet</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">flashes_white</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span> 

<span class="n">start</span> <span class="o">=</span> <span class="n">flashes_black</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">dt</span> <span class="c1"># Start 500 ms before stimulus presentation</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">flashes_black</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="n">dt</span> <span class="c1"># End 500 ms after stimulus presentation</span>
<span class="n">extended_flashes_black</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">IntervalSet</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">flashes_black</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># This should all pass if you created the IntervalSet correctly</span>
<span class="k">assert</span> <span class="n">extended_flashes_white</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">flashes_white</span><span class="o">.</span><span class="n">shape</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">extended_flashes_white</span><span class="o">.</span><span class="n">metadata</span> <span class="o">==</span> <span class="n">flashes_white</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">extended_flashes_white</span><span class="o">.</span><span class="n">start</span> <span class="o">==</span> <span class="n">flashes_white</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="mf">.5</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">extended_flashes_white</span><span class="o">.</span><span class="n">end</span> <span class="o">==</span> <span class="n">flashes_white</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="mf">.5</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">extended_flashes_black</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">flashes_black</span><span class="o">.</span><span class="n">shape</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">extended_flashes_black</span><span class="o">.</span><span class="n">metadata</span> <span class="o">==</span> <span class="n">flashes_black</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">extended_flashes_black</span><span class="o">.</span><span class="n">start</span> <span class="o">==</span> <span class="n">flashes_black</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="mf">.5</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">extended_flashes_black</span><span class="o">.</span><span class="n">end</span> <span class="o">==</span> <span class="n">flashes_black</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="mf">.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="render-all">
<p>Now, select your neurons. There are four criteria we want to use:</p>
<ol class="arabic simple">
<li><p>Brain area: we are interested in analyzing VISp units for this tutorial</p></li>
<li><p>Quality: we will only select “good” quality units. If you’re curious, you can (optionally) <a class="reference external" href="https://alleninstitute.github.io/openscope_databook/visualization/visualize_unit_metrics.html">read more</a> how about the Allen Institute defines quality.</p></li>
<li><p>Firing rate: overall, we want units with a firing rate larger than 2Hz around the presentation of stimuli</p></li>
<li><p>Responsiveness: we want units that actually respond to changes in the visual stimuli, i.e., their firing rate changes as a result of the stimulus.</p></li>
</ol>
<p>Create a new <code class="docutils literal notranslate"><span class="pre">TsGroup</span></code>, <code class="docutils literal notranslate"><span class="pre">selected_units</span></code>, which includes only those units that meet the first three criteria, then check that it passes the assertion block.</p>
<div class="reminder admonition">
<p class="admonition-title">Restrict!</p>
<p>Don’t forget when selecting based on firing rate that we want neurons whose firing rate is above the threshold <strong>around the presentation of the stimuli!</strong> This means you should use <code class="xref py py-func docutils literal notranslate"><span class="pre">restrict()</span></code>! If only we had a useful <code class="docutils literal notranslate"><span class="pre">IntervalSet</span></code> lying around…</p>
</div>
</div>
```{code-cell} ipython3
# Filter units according criteria 1 & 2
selected_units = units[(units["brain_area"]=="VISp") & (units["quality"]=="good")] 
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="restrict-around-stimuli-presentation">
<h1>Restrict around stimuli presentation<a class="headerlink" href="#restrict-around-stimuli-presentation" title="Link to this heading">#</a></h1>
<p>selected_units = selected_units.restrict(extended_flashes)</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="filter-according-to-criterion-3">
<h1>Filter according to criterion 3<a class="headerlink" href="#filter-according-to-criterion-3" title="Link to this heading">#</a></h1>
<p>selected_units = selected_units[(selected_units[“rate”]&gt;2.0)]</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>```{code-cell} ipython3
:tags: [render-all]

assert len(selected_units) == 92
</pre></div>
</div>
<p>Now, in order to determine the responsiveness of the units, it’s helpful to use the <a class="reference external" href="https://pynapple.org/generated/pynapple.process.perievent.html#pynapple.process.perievent.compute_perievent" title="(in pynapple v0.9.1)"><code class="xref py py-func docutils literal notranslate"><span class="pre">compute_perievent()</span></code></a> function: this will align units’ spiking timestamps with the onset of the stimulus repetitions and take an average over them.</p>
<p>Let’s use that function to construct two separate perievent dictionaries, one aligned to the start of the white stimuli, one aligned to the start of the black, and they should run from 250 msec before to 500 msec after the event.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set window of perievent 500 ms before and after the start of the event</span>
<span class="n">window_size</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">.250</span><span class="p">,</span> <span class="mf">.500</span><span class="p">)</span> 

<span class="c1"># Re-center timestamps for white stimuli</span>
<span class="c1"># +50 because we subtracted 500 ms at beginning of stimulus presentation</span>
<span class="n">peri_white</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">compute_perievent</span><span class="p">(</span><span class="n">timestamps</span><span class="o">=</span><span class="n">selected_units</span><span class="p">,</span>
                                   <span class="n">tref</span><span class="o">=</span><span class="n">nap</span><span class="o">.</span><span class="n">Ts</span><span class="p">(</span><span class="n">extended_flashes_white</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span><span class="mf">.50</span><span class="p">),</span> 
                                   <span class="n">minmax</span><span class="o">=</span><span class="n">window_size</span><span class="p">)</span>

<span class="c1"># Re-center timestamps for black stimuli</span>
<span class="c1"># +50 because we subtracted 500 ms at beginning of stimulus presentation</span>
<span class="n">peri_black</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">compute_perievent</span><span class="p">(</span><span class="n">timestamps</span><span class="o">=</span><span class="n">selected_units</span><span class="p">,</span>
                                   <span class="n">tref</span><span class="o">=</span><span class="n">nap</span><span class="o">.</span><span class="n">Ts</span><span class="p">(</span><span class="n">extended_flashes_black</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span><span class="mf">.50</span><span class="p">),</span> 
                                   <span class="n">minmax</span><span class="o">=</span><span class="n">window_size</span><span class="p">)</span>

<span class="c1"># OR</span>

<span class="n">peri_white</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">compute_perievent</span><span class="p">(</span><span class="n">timestamps</span><span class="o">=</span><span class="n">selected_units</span><span class="p">,</span>
                                   <span class="n">tref</span><span class="o">=</span><span class="n">nap</span><span class="o">.</span><span class="n">Ts</span><span class="p">(</span><span class="n">flashes_white</span><span class="o">.</span><span class="n">start</span><span class="p">),</span>
                                   <span class="n">minmax</span><span class="o">=</span><span class="n">window_size</span><span class="p">)</span>
<span class="n">peri_black</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">compute_perievent</span><span class="p">(</span><span class="n">timestamps</span><span class="o">=</span><span class="n">selected_units</span><span class="p">,</span>
                                   <span class="n">tref</span><span class="o">=</span><span class="n">nap</span><span class="o">.</span><span class="n">Ts</span><span class="p">(</span><span class="n">flashes_black</span><span class="o">.</span><span class="n">start</span><span class="p">),</span>
                                   <span class="n">minmax</span><span class="o">=</span><span class="n">window_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">peri_white</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_units</span><span class="p">)</span>
<span class="k">assert</span> <span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">ref_times</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">peri_white</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span> <span class="o">==</span> <span class="n">flashes_white</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">peri_black</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_units</span><span class="p">)</span>
<span class="k">assert</span> <span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">ref_times</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">peri_black</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span> <span class="o">==</span> <span class="n">flashes_black</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Visualizing these perievents can help us determine which units to include. The following helper function should help.</p>
<div class="cell tag_render-all tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_raster_psth</span><span class="p">(</span><span class="n">peri</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">color_flashes</span><span class="p">,</span> <span class="n">n_units</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">start_unit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mf">.005</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mf">0.015</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot perievent time histograms (PSTHs) and raster plots for multiple units.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    peri : dict</span>
<span class="sd">        Dictionary mapping unit names to binned spike count peri-stimulus data (e.g., binned time series).</span>
<span class="sd">    units : dict</span>
<span class="sd">        Dictionary of neural units, e.g., spike trains or trial-aligned spike events.</span>
<span class="sd">    color_flashes : str</span>
<span class="sd">        A label indicating the flash color condition (&#39;black&#39; or &#39;white&#39;), used for visual styling.</span>
<span class="sd">    n_units : int</span>
<span class="sd">        The number of units to visualize.</span>
<span class="sd">    start_unit : int</span>
<span class="sd">        The index of the unit to start with.</span>
<span class="sd">    bin_size : float</span>
<span class="sd">        Size of the bin used for spike count computation (in seconds).</span>
<span class="sd">    smoothing : float</span>
<span class="sd">        Standard deviation for Gaussian smoothing of the PSTH traces.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Layout setup: 9 columns (units), 2 rows (split vertically into PSTH and raster plot)</span>
    <span class="n">n_cols</span> <span class="o">=</span> <span class="n">n_units</span>
    <span class="n">n_rows</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span>
                             <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_cols</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

    <span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab10</span><span class="o">.</span><span class="n">colors</span>

    <span class="c1"># Extract unit names for iteration</span>
    <span class="n">units_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">start_unit</span><span class="p">:</span><span class="n">start_unit</span><span class="o">+</span><span class="n">n_units</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">units_list</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">peri</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span>
        <span class="n">line_color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)]</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>

        <span class="c1"># Plot PSTH (smoothed firing rate)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">bin_size</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">bin_size</span><span class="p">)</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">std</span><span class="o">=</span><span class="n">smoothing</span><span class="p">),</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">line_color</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># Stimulus onset line</span>

        <span class="n">span_color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span> <span class="k">if</span> <span class="n">color_flashes</span> <span class="o">==</span> <span class="s2">&quot;black&quot;</span> <span class="k">else</span> <span class="s2">&quot;silver&quot;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.250</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">span_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>  <span class="c1"># Stim duration</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Plot raster</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">to_tsd</span><span class="p">(),</span> <span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">line_color</span><span class="p">,</span> <span class="n">mew</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.250</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">span_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>

    <span class="c1"># Y-axis and title annotations</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Rate (Hz)&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Trial&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_rows</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Rate (Hz)&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Trial&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="s1">&#39;Time from stim(s)&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;PSTH &amp; Spike Raster Plot - </span><span class="si">{</span><span class="n">color_flashes</span><span class="si">}</span><span class="s1"> flashes&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># called like this, the function will visualize the first 9 units. play with the n_units</span>
<span class="c1"># and start_unit arguments to see the other units.</span>
<span class="n">plot_raster_psth</span><span class="p">(</span><span class="n">peri_white</span><span class="p">,</span> <span class="n">selected_units</span><span class="p">,</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">n_units</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">start_unit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plot_raster_psth</span><span class="p">(</span><span class="n">peri_black</span><span class="p">,</span> <span class="n">selected_units</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">n_units</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">start_unit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="render-all">
<p>You could manually visualize each of our units and select those that appear, from their PSTH to be responsive.</p>
<p>However, it would be easier to scale (and more reproducible) if you came up with some measure of responsiveness. So how do we compute something that captures “this neuron responds to visual stimuli”?</p>
<p>You should be able to do this using a function that iterates over the <code class="docutils literal notranslate"><span class="pre">peri_white</span></code> and <code class="docutils literal notranslate"><span class="pre">peri_black</span></code> dictionaries, returning a single float for each unit.</p>
<p>Let’s aim to pick around 20 neurons.</p>
<p>If you’re having trouble coming up with one that seems reasonable, expand the following admonition.</p>
<div class="hint dropdown admonition">
<p class="admonition-title">How to compute responsiveness?</p>
<p>Try defining responsiveness as the normalized difference in average firing rate between during stimulus presentation and before the stimulus was presented.</p>
<p>We can use <code class="xref py py-func docutils literal notranslate"><span class="pre">restrict()</span></code> together with <code class="docutils literal notranslate"><span class="pre">np.mean</span></code> to compute the average firing rates above, and then combine them.</p>
</div>
</div>
```{code-cell} ipython3
def get_responsiveness(perievents, bin_size=0.005):
    """Calculate responsiveness for each neuron. This is computed as:
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>post_presentation_avg  : 
    Average firing rate during presentation (250 ms) of stimulus across
    all instances of stimulus. 

pre_presentation_avg :
    Average firing rate prior (250 ms) to the presentation of stimulus
    across all instances prior of stimulus. 

responsiveness : 
    abs((post_presentation_avg - pre_presentation_avg) / (post_presentation_avg + pre_presentation_avg))

Larger values indicate higher responsiveness to the stimuli.
    
Parameters
----------
perievents : TsGroup
    Contains perievent information of a subset of neurons
bin_size : float
    Bin size for calculating spike counts

Returns
----------   
resp_array : np.array
    Array of responsiveness information.

&quot;&quot;&quot;
resp_dict = {}
resp_array = np.zeros(len(perievents.keys()), dtype=float)

for index, peri in enumerate(perievents.values()):
    # Count the number of timestamps in each bin_size bin.
    peri_counts = peri.count(bin_size)

    # Compute average spikes for each millisecond in the
    # the 250 ms before stimulus presentation
    pre_presentation = np.mean(peri_counts, 1).restrict(nap.IntervalSet([-.25,0]))

    # Compute average spikes for each millisecond in the
    # the 250 ms after stimulus presentation
    post_presentation = np.mean(peri_counts, 1).restrict(nap.IntervalSet([0,.25]))

    pre_presentation_avg = np.mean(pre_presentation)
    post_presentation_avg = np.mean(post_presentation)
    responsiveness = abs((post_presentation_avg - pre_presentation_avg) / (post_presentation_avg + pre_presentation_avg))

    resp_array[index] = responsiveness

return resp_array
</pre></div>
</div>
<p>responsiveness_white = get_responsiveness(peri_white)
responsiveness_black = get_responsiveness(peri_black)</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="get-threshold-for-top-15-most-responsive">
<h1>Get threshold for top 15% most responsive<a class="headerlink" href="#get-threshold-for-top-15-most-responsive" title="Link to this heading">#</a></h1>
<p>thresh_black = np.percentile(responsiveness_black, 85)
thresh_white = np.percentile(responsiveness_white, 85)</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="only-keep-units-that-are-within-the-15-most-responsive-for-either-black-or-white">
<h1>Only keep units that are within the 15% most responsive for either black or white<a class="headerlink" href="#only-keep-units-that-are-within-the-15-most-responsive-for-either-black-or-white" title="Link to this heading">#</a></h1>
<p>selected_units = selected_units[(responsiveness_black &gt; thresh_black) | (responsiveness_white &gt; thresh_white)]</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>

Let&#39;s visualize the selected units PSTHs to make sure they all look reasonable:


```{code-cell} ipython3
:tags: [render-all]

print(f&quot;Remaining units: {len(selected_units)}&quot;)
peri_white = {k: peri_white[k] for k in selected_units.index}
peri_black = {k: peri_black[k] for k in selected_units.index}

plot_raster_psth(peri_black, selected_units, &quot;black&quot;, n_units=len(peri_black))
plot_raster_psth(peri_white, selected_units, &quot;white&quot;, n_units=len(peri_white))
</pre></div>
</div>
<section id="avoiding-overfitting">
<h2>Avoiding overfitting<a class="headerlink" href="#avoiding-overfitting" title="Link to this heading">#</a></h2>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="place_cells-presenters.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Model selection</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Exploring the Visual Coding Dataset</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-and-preparing-data">Downloading and preparing data</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#restrict-around-stimuli-presentation">Restrict around stimuli presentation</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#filter-according-to-criterion-3">Filter according to criterion 3</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#get-threshold-for-top-15-most-responsive">Get threshold for top 15% most responsive</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#only-keep-units-that-are-within-the-15-most-responsive-for-either-black-or-white">Only keep units that are within the 15% most responsive for either black or white</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#avoiding-overfitting">Avoiding overfitting</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Edoardo Balzani, Billy Broderick, Sarah Jo Venditto, Guillaume Viejo
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025, Edoardo Balzani, Billy Broderick, Sarah Jo Venditto, Guillaume Viejo.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>