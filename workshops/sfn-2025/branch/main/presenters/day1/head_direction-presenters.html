
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Data analysis with pynapple &amp; nemos &#8212; CCN software workshop, SfN 2025  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=f4437bd1" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'presenters/day1/head_direction-presenters';</script>
    <link rel="icon" href="../../_static/ccn_small.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Signal processing and decoding in pynapple" href="phase_precession-presenters.html" />
    <link rel="prev" title="Learning the fundamentals of pynapple" href="fundamentals_of_pynapple-presenters.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/01-FI-primary-logo-color.png" class="logo__image only-light" alt="Home"/>
    <script>document.write(`<img src="../../_static/03-FI-primary-logo-white.png" class="logo__image only-dark" alt="Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/flatironinstitute/ccn-software-sfn-2025" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://flatironinstitute.github.io/neurorse-workshops/" title="Workshops home" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-house fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Workshops home</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://binder.flatironinstitute.org/v2/user/wbroderick/sfn2025?labpath=notebooks/" title="Binder" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="https://mybinder.org/badge_logo.svg" class="icon-link-image" alt="Binder"/></a>
        </li>
</ul></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    Welcome!
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Full notebooks</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../full/day1/fundamentals_of_pynapple.html">Learning the fundamentals of pynapple</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../full/day1/head_direction.html">Data analysis with pynapple &amp; nemos</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../full/day1/phase_precession.html">Signal processing and decoding in pynapple</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../full/day2/current_injection.html">Introduction to GLM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../full/day2/place_cells.html">Model selection</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">For users (some code, some text)</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../users/day1/fundamentals_of_pynapple-users.html">Learning the fundamentals of pynapple</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../users/day1/head_direction-users.html">Data analysis with pynapple &amp; nemos</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../users/day1/phase_precession-users.html">Signal processing and decoding in pynapple</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../users/day2/current_injection-users.html">Introduction to GLM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../users/day2/place_cells-users.html">Model selection</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">For presenter reference (all code, no text)</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="fundamentals_of_pynapple-presenters.html">Learning the fundamentals of pynapple</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Data analysis with pynapple &amp; nemos</a></li>

<li class="toctree-l1"><a class="reference internal" href="phase_precession-presenters.html">Signal processing and decoding in pynapple</a></li>
<li class="toctree-l1"><a class="reference internal" href="../day2/current_injection-presenters.html">Introduction to GLM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../day2/place_cells-presenters.html">Model selection</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/flatironinstitute/ccn-software-sfn-2025" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/presenters/day1/head_direction-presenters.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Data analysis with pynapple & nemos</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Data analysis with pynapple &amp; nemos</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">Learning objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-a-nwb-file">Loading a NWB file</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-tuning-curves">Compute tuning curves</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decode-neural-activity">Decode neural activity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-correlograms">Compute correlograms</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#fitting-a-glm-model-with-nemos">Fitting a GLM model with Nemos</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#features-construction">Features Construction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fitting-the-model">Fitting the Model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inspecting-the-results">Inspecting the results</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#reducing-feature-dimensionality">Reducing feature dimensionality</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-and-compare-the-models">Fit and compare the models</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#all-to-all-connectivity">All-to-all Connectivity</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preparing-the-features">Preparing the features</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Fitting the Model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-model-predictions">Comparing model predictions.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-the-connectivity">Visualizing the connectivity</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</pre></div>
</div>
</div>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="data-analysis-with-pynapple-nemos">
<h1>Data analysis with pynapple &amp; nemos<a class="headerlink" href="#data-analysis-with-pynapple-nemos" title="Link to this heading">#</a></h1>
<p>This notebook has had all its explanatory text removed and has not been run.
It is intended to be downloaded and run locally (or on the provided binder)
while listening to the presenter’s explanation. In order to see the fully
rendered of this notebook, go <a class="reference internal" href="../../full/day1/head_direction.html"><span class="std std-doc">here</span></a></p>
<section id="learning-objectives">
<h2>Learning objectives<a class="headerlink" href="#learning-objectives" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Loading a NWB file</p></li>
<li><p>Compute tuning curves</p></li>
<li><p>Decode neural activity</p></li>
<li><p>Compute correlograms</p></li>
<li><p>Include history-related predictors to NeMoS GLM.</p></li>
<li><p>Reduce over-fitting with <code class="docutils literal notranslate"><span class="pre">Basis</span></code>.</p></li>
<li><p>Learn functional connectivity.</p></li>
</ul>
<p>The pynapple documentation can be found <a class="reference external" href="https://pynapple.org">here</a>.</p>
<p>The nemos documentation can be found <a class="reference external" href="https://nemos.readthedocs.io/en/latest/">here</a>.</p>
<p>Let’s start by importing all the packages.
If an import fails, you can do <code class="docutils literal notranslate"><span class="pre">!pip</span> <span class="pre">install</span> <span class="pre">pynapple</span> <span class="pre">nemos</span> <span class="pre">matplotlib</span></code> in a cell to fix it.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pynapple</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nap</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">workshop_utils</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">nemos</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nmo</span>

<span class="c1"># some helper plotting functions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nemos</span><span class="w"> </span><span class="kn">import</span> <span class="n">_documentation_utils</span> <span class="k">as</span> <span class="n">doc_plots</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">workshop_utils</span>

<span class="c1"># configure pynapple to ignore conversion warning</span>
<span class="n">nap</span><span class="o">.</span><span class="n">nap_config</span><span class="o">.</span><span class="n">suppress_conversion_warnings</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># configure plots some</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">nmo</span><span class="o">.</span><span class="n">styles</span><span class="o">.</span><span class="n">plot_style</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="loading-a-nwb-file">
<h2>Loading a NWB file<a class="headerlink" href="#loading-a-nwb-file" title="Link to this heading">#</a></h2>
<p>Pynapple commit to support NWB for data loading.
If you have installed the repository, you can run the following cell:</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">workshop_utils</span><span class="o">.</span><span class="n">fetch_data</span><span class="p">(</span><span class="s2">&quot;Mouse32-140822.nwb&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Pynapple provides the convenience function <code class="docutils literal notranslate"><span class="pre">nap.load_file</span></code> for loading a NWB file.</p>
<p><strong>Question:</strong> Can you open the NWB file giving the variable <code class="docutils literal notranslate"><span class="pre">path</span></code> to the function <code class="docutils literal notranslate"><span class="pre">load_file</span></code> and call the output <code class="docutils literal notranslate"><span class="pre">data</span></code>?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The content of the NWB file is not loaded yet. The object <code class="docutils literal notranslate"><span class="pre">data</span></code> behaves like a dictionnary.</p>
<p><strong>Question:</strong> Can you load the spike times from the NWB and call the variables <code class="docutils literal notranslate"><span class="pre">spikes</span></code>?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spikes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span>  <span class="c1"># Get spike timings</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Question:</strong> And print it?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">spikes</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>There are a lot of neurons. The neurons that interest us are the neurons labeled <code class="docutils literal notranslate"><span class="pre">adn</span></code>.</p>
<p><strong>Question:</strong> Using the <a class="reference external" href="https://pynapple.org/user_guide/03_metadata.html#using-metadata-to-slice-objects">slicing method</a> of your choice, can you select only the neurons in <code class="docutils literal notranslate"><span class="pre">adn</span></code> that are above 2 Hz firing rate?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spikes</span> <span class="o">=</span> <span class="n">spikes</span><span class="p">[(</span><span class="n">spikes</span><span class="o">.</span><span class="n">location</span><span class="o">==</span><span class="s1">&#39;adn&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">spikes</span><span class="o">.</span><span class="n">rate</span><span class="o">&gt;</span><span class="mf">2.0</span><span class="p">)]</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spikes</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>The NWB file contains other informations about the recording. <code class="docutils literal notranslate"><span class="pre">ry</span></code> contains the value of the head-direction of the animal over time.</p>
<p><strong>Question:</strong> Can you extract the angle of the animal in a variable called <code class="docutils literal notranslate"><span class="pre">angle</span></code> and print it?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">angle</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;ry&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>But are the data actually loaded … or not?</p>
<p><strong>Question:</strong> Can you print the underlying data array of <code class="docutils literal notranslate"><span class="pre">angle</span></code>?</p>
<p>Data are lazy-loaded. This can be useful when reading larger than memory array from disk with memory map.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The animal was recorded during wakefulness and sleep.</p>
<p><strong>Question:</strong> Can you extract the behavioral intervals in a variable called <code class="docutils literal notranslate"><span class="pre">epochs</span></code>?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">epochs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>NWB file can save intervals with multiple labels. The object <code class="docutils literal notranslate"><span class="pre">IntervalSet</span></code> includes the labels as a metadata object.</p>
<p><strong>Question:</strong> Using the column <code class="docutils literal notranslate"><span class="pre">tags</span></code>, can you create one <code class="docutils literal notranslate"><span class="pre">IntervalSet</span></code> object for intervals labeled <code class="docutils literal notranslate"><span class="pre">wake</span></code> and one <code class="docutils literal notranslate"><span class="pre">IntervalSet</span></code> object for intervals labeled <code class="docutils literal notranslate"><span class="pre">sleep</span></code>?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">wake_ep</span> <span class="o">=</span> <span class="n">epochs</span><span class="p">[</span><span class="n">epochs</span><span class="o">.</span><span class="n">tags</span><span class="o">==</span><span class="s2">&quot;wake&quot;</span><span class="p">]</span>
<span class="n">sleep_ep</span> <span class="o">=</span> <span class="n">epochs</span><span class="p">[</span><span class="n">epochs</span><span class="o">.</span><span class="n">tags</span><span class="o">==</span><span class="s2">&quot;sleep&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="compute-tuning-curves">
<h2>Compute tuning curves<a class="headerlink" href="#compute-tuning-curves" title="Link to this heading">#</a></h2>
<p>Now that we have spikes and a behavioral feature (i.e. head-direction), we would like to compute the firing rate of neurons as a function of the variable <code class="docutils literal notranslate"><span class="pre">angle</span></code> during <code class="docutils literal notranslate"><span class="pre">wake_ep</span></code>.
To do this in pynapple, all you need is a single line of code!</p>
<p><strong>Question:</strong> can you compute the firing rate of ADn units as a function of heading direction, i.e. a head-direction tuning curve and call the variable <code class="docutils literal notranslate"><span class="pre">tuning_curves</span></code>?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tuning_curves</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">compute_tuning_curves</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">spikes</span><span class="p">,</span>
    <span class="n">features</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> 
    <span class="n">bins</span><span class="o">=</span><span class="mi">61</span><span class="p">,</span> 
    <span class="n">epochs</span> <span class="o">=</span> <span class="n">angle</span><span class="o">.</span><span class="n">time_support</span><span class="p">,</span>
    <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Angle&quot;</span><span class="p">]</span>
    <span class="p">)</span>

<span class="n">tuning_curves</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Question:</strong> Can you plot some tuning curves?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">221</span><span class="p">)</span>
<span class="n">tuning_curves</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="c1"># plt.plot(tuning_curves[0])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">222</span><span class="p">,</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;polar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tuning_curves</span><span class="o">.</span><span class="n">Angle</span><span class="p">,</span> <span class="n">tuning_curves</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">223</span><span class="p">)</span>
<span class="n">tuning_curves</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;polar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tuning_curves</span><span class="o">.</span><span class="n">Angle</span><span class="p">,</span> <span class="n">tuning_curves</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Most of those neurons are head-directions neurons.</p>
<p>The next cell allows us to get a quick estimate of the neurons’s preferred direction. Since this is a lot of xarray wrangling, it is given.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pref_ang</span> <span class="o">=</span> <span class="n">tuning_curves</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;Angle&quot;</span><span class="p">)</span>

<span class="c1"># pref_ang = tuning_curves.idxmax()</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Question:</strong> Can you add it to the metainformation of <code class="docutils literal notranslate"><span class="pre">spikes</span></code>?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spikes</span><span class="p">[</span><span class="s1">&#39;pref_ang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pref_ang</span>

<span class="n">spikes</span>
</pre></div>
</div>
</div>
</div>
<p>This index maps a neuron to a preferred direction between 0 and 360 degrees.</p>
<p><strong>Question:</strong> Can you plot the spiking activity of the neurons based on their preferred direction as well as the head-direction of the animal?
For the sake of visibility, you should restrict the data to the following epoch : <code class="docutils literal notranslate"><span class="pre">ex_ep</span> <span class="pre">=</span> <span class="pre">nap.IntervalSet(start=8910,</span> <span class="pre">end=8960)</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ex_ep</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">IntervalSet</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">8910</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">8960</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_ep</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spikes</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_ep</span><span class="p">)</span><span class="o">.</span><span class="n">to_tsd</span><span class="p">(</span><span class="s2">&quot;pref_ang&quot;</span><span class="p">),</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="decode-neural-activity">
<h2>Decode neural activity<a class="headerlink" href="#decode-neural-activity" title="Link to this heading">#</a></h2>
<p>Population activity clearly codes for head-direction. Can we use the spiking activity of the neurons to infer the current heading of the animal? There are currently 2 ways to do this in pynapple :</p>
<ul class="simple">
<li><p>bayesian decoding</p></li>
<li><p>template matching</p></li>
</ul>
<p><strong>Question:</strong> Using the method of your choice, can you compute the decoded angle from the spiking activity during wakefulness?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">decoded</span><span class="p">,</span> <span class="n">proba_feature</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">decode_bayes</span><span class="p">(</span>
    <span class="n">tuning_curves</span><span class="o">=</span><span class="n">tuning_curves</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">spikes</span><span class="p">,</span>
    <span class="n">epochs</span><span class="o">=</span><span class="n">wake_ep</span><span class="p">,</span>
    <span class="n">bin_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>  <span class="c1"># second</span>
<span class="p">)</span>

<span class="c1"># decoded, proba_feature = nap.decode_template(</span>
<span class="c1">#     tuning_curves=tuning_curves,</span>
<span class="c1">#     data=spikes,</span>
<span class="c1">#     epochs=wake_ep,</span>
<span class="c1">#     bin_size=0.3,  # second</span>
<span class="c1"># )</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Question:</strong> … and display the decoded angle next to the true angle?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_ep</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">decoded</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_ep</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;decoded&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spikes</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_ep</span><span class="p">)</span><span class="o">.</span><span class="n">to_tsd</span><span class="p">(</span><span class="s2">&quot;pref_ang&quot;</span><span class="p">),</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Since the tuning curves were computed during wakefulness, it is a circular action to decode spiking activity during wakefulness.
We can try something more interesting by trying to decode the angle during sleep.</p>
<p><strong>Question:</strong> Can you instantiate an <code class="docutils literal notranslate"><span class="pre">IntervalSet</span></code> object called <code class="docutils literal notranslate"><span class="pre">rem_ep</span></code> that contains the epochs of REM sleep? You can check the contents of the NWB file by doing first <code class="docutils literal notranslate"><span class="pre">print(data)</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rem_ep</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rem&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Question:</strong> Can you compute the decoded angle from the spiking activity during REM sleep?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">decoded</span><span class="p">,</span> <span class="n">proba_feature</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">decode_bayes</span><span class="p">(</span>
    <span class="n">tuning_curves</span><span class="o">=</span><span class="n">tuning_curves</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">spikes</span><span class="p">,</span>
    <span class="n">epochs</span><span class="o">=</span><span class="n">rem_ep</span><span class="p">,</span>
    <span class="n">bin_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>  <span class="c1"># second</span>
<span class="p">)</span>

<span class="c1"># decoded, proba_feature = nap.decode_template(</span>
<span class="c1">#     tuning_curves=tuning_curves,</span>
<span class="c1">#     data=spikes,</span>
<span class="c1">#     epochs=rem_ep,</span>
<span class="c1">#     bin_size=0.3,  # second</span>
<span class="c1"># )</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Question:</strong> … and display the decoded angle next to the spiking activity?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">decoded</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">rem_ep</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;decoded&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spikes</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">rem_ep</span><span class="p">)</span><span class="o">.</span><span class="n">to_tsd</span><span class="p">(</span><span class="s2">&quot;pref_ang&quot;</span><span class="p">),</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="compute-correlograms">
<h2>Compute correlograms<a class="headerlink" href="#compute-correlograms" title="Link to this heading">#</a></h2>
<p>We see that some neurons have a correlated activity. Can we measure it?</p>
<p><strong>Question:</strong> Can you compute cross-correlograms during wake for all pairs of neurons and call it <code class="docutils literal notranslate"><span class="pre">cc_wake</span></code>?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cc_wake</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">compute_crosscorrelogram</span><span class="p">(</span><span class="n">spikes</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">windowsize</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span> <span class="n">ep</span><span class="o">=</span><span class="n">wake_ep</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Question:</strong> can you plot the cross-correlogram during wake of 2 neurons firing for the same direction?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">index</span> <span class="o">=</span> <span class="n">spikes</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>


<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">tuning_curves</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">20</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Angle&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;unit&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Tuning curves&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cc_wake</span><span class="p">[(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">20</span><span class="p">)])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time lag (s)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Cross-corr.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Question:</strong> can you plot the cross-correlogram during wake of 2 neurons firing for opposite directions?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">index</span> <span class="o">=</span> <span class="n">spikes</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>


<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">tuning_curves</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">26</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Angle&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;unit&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Tuning curves&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cc_wake</span><span class="p">[(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">26</span><span class="p">)])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time lag (s)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Cross-corr.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Pairwise correlation were computed during wakefulness. The activity of the neurons was also recorded during sleep.</p>
<p><strong>Question:</strong> can you compute the cross-correlograms during sleep?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cc_sleep</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">compute_crosscorrelogram</span><span class="p">(</span><span class="n">spikes</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">ep</span><span class="o">=</span><span class="n">sleep_ep</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Question:</strong> can you display the cross-correlogram for wakefulness and sleep of the same pairs of neurons?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">)</span>
<span class="n">tuning_curves</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">20</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Angle&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;unit&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Tuning curves&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cc_wake</span><span class="p">[(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">20</span><span class="p">)])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time lag (s)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Wake&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cc_sleep</span><span class="p">[(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">20</span><span class="p">)])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time lag (s)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Sleep&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">131</span><span class="p">)</span>
<span class="n">tuning_curves</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">26</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Angle&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;unit&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Tuning curves&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">132</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cc_wake</span><span class="p">[(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">26</span><span class="p">)])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time lag (s)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Wake&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cc_sleep</span><span class="p">[(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">26</span><span class="p">)])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time lag (s)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Sleep&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>What does it mean for the relationship between cells here?</p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="fitting-a-glm-model-with-nemos">
<h1>Fitting a GLM model with Nemos<a class="headerlink" href="#fitting-a-glm-model-with-nemos" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">wake_ep</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">IntervalSet</span><span class="p">(</span>
    <span class="n">start</span><span class="o">=</span><span class="n">wake_ep</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="n">wake_ep</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">60</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To use the GLM, we need first to bin the spike trains. Here we use pynapple and the function <code class="docutils literal notranslate"><span class="pre">count</span></code>.</p>
<p><strong>Question: can you bin the spike trains in 10 ms bins during the <code class="docutils literal notranslate"><span class="pre">wake_ep</span></code> and call the variable <code class="docutils literal notranslate"><span class="pre">count</span></code>?</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">bin_size</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">count</span> <span class="o">=</span> <span class="n">spikes</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">bin_size</span><span class="p">,</span> <span class="n">ep</span><span class="o">=</span><span class="n">wake_ep</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">count</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Question: can you reorder the columns of <code class="docutils literal notranslate"><span class="pre">count</span></code> based on the preferred direction of each neuron?</strong></p>
<p>Above we defined <code class="docutils literal notranslate"><span class="pre">pref_ang</span></code> as the preferred direction of each neuron.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">pref_ang</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>It’s time to use NeMoS. Our goal is to estimate the pairwise interaction between neurons.
This can be quantified with a GLM if we use the recent population spike history to predict the current time step.</p>
<p>To simplify our life, let’s see first how we can model spike history effects in a single neuron.
The simplest approach is to use counts in fixed length window <span class="math notranslate nohighlight">\(i\)</span>, <span class="math notranslate nohighlight">\(y_{t-i}, \dots, y_{t-1}\)</span> to predict the next
count <span class="math notranslate nohighlight">\(y_{t}\)</span>.</p>
<p>Before starting the analysis, let’s
- <strong>select a neuron from the <code class="docutils literal notranslate"><span class="pre">count</span></code> object (call the variable <code class="docutils literal notranslate"><span class="pre">neuron_count</span></code>)</strong>
- <strong>Select the first 1.2 seconds for visualization. (call the epoch <code class="docutils literal notranslate"><span class="pre">epoch_one_spk</span></code>).</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># select a neuron&#39;s spike count time series</span>
<span class="n">neuron_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

<span class="c1"># restrict to a smaller time interval</span>
<span class="n">epoch_one_spk</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">IntervalSet</span><span class="p">(</span>
    <span class="n">start</span><span class="o">=</span><span class="n">count</span><span class="o">.</span><span class="n">time_support</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="n">count</span><span class="o">.</span><span class="n">time_support</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.2</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="features-construction">
<h2>Features Construction<a class="headerlink" href="#features-construction" title="Link to this heading">#</a></h2>
<p>Let’s fix the spike history window size that we will use as predictor.</p>
<p><strong>Question: Can you:</strong></p>
<ul class="simple">
<li><p>Fix a history window of 800ms (0.8 seconds).</p></li>
<li><p>Plot the result using <code class="docutils literal notranslate"><span class="pre">doc_plots.plot_history_window</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># set the size of the spike history window in seconds</span>
<span class="n">window_size_sec</span> <span class="o">=</span> <span class="mf">0.8</span>

<span class="n">doc_plots</span><span class="o">.</span><span class="n">plot_history_window</span><span class="p">(</span><span class="n">neuron_count</span><span class="p">,</span> <span class="n">epoch_one_spk</span><span class="p">,</span> <span class="n">window_size_sec</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>For each time point, we shift our window one bin at the time and vertically stack the spike count history in a matrix.
Each row of the matrix will be used as the predictors for the rate in the next bin (red narrow rectangle in
the figure).</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">doc_plots</span><span class="o">.</span><span class="n">run_animation</span><span class="p">(</span><span class="n">neuron_count</span><span class="p">,</span> <span class="n">epoch_one_spk</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>If <span class="math notranslate nohighlight">\(t\)</span> is smaller than the window size, we won’t have a full window of spike history for estimating the rate.
One may think of padding the window (with zeros for example) but this may generate weird border artifacts.
To avoid that, we can simply restrict our analysis to times <span class="math notranslate nohighlight">\(t\)</span> larger than the window and NaN-pad earlier
time-points;</p>
<p>You can construct this feature matrix with the <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/basis/nemos.basis.HistoryConv.html#nemos.basis.HistoryConv" title="nemos 0.2.4"><span class="xref myst"><code class="docutils literal notranslate"><span class="pre">HistoryConv</span></code></span></a> basis.</p>
<p><strong>Question: Can you:</strong>
- Convert the window size in number of bins (call it <code class="docutils literal notranslate"><span class="pre">window_size</span></code>)
- Define an <code class="docutils literal notranslate"><span class="pre">HistoryConv</span></code> basis covering this window size (call it <code class="docutils literal notranslate"><span class="pre">history_basis</span></code>).
- Create the feature matrix with <code class="docutils literal notranslate"><span class="pre">history_basis.compute_features</span></code> (call it <code class="docutils literal notranslate"><span class="pre">input_feature</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># convert the prediction window to bins (by multiplying with the sampling rate)</span>
<span class="n">window_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">window_size_sec</span> <span class="o">*</span> <span class="n">neuron_count</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span>
<span class="c1"># define the history bases</span>
<span class="n">history_basis</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">HistoryConv</span><span class="p">(</span><span class="n">window_size</span><span class="p">)</span>
<span class="c1"># create the feature matrix</span>
<span class="n">input_feature</span> <span class="o">=</span> <span class="n">history_basis</span><span class="o">.</span><span class="n">compute_features</span><span class="p">(</span><span class="n">neuron_count</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>NeMoS NaN pads if there aren’t enough samples to predict the counts.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># print the NaN indices along the time axis</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NaN indices:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">input_feature</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))[</span><span class="mi">0</span><span class="p">])</span> 
</pre></div>
</div>
</div>
</div>
<p>The binned counts originally have shape “number of samples”, we should check that the
dimension are matching our expectation</p>
<p><strong>Question: Can you check the shape of the counts and features?</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time bins in counts: </span><span class="si">{</span><span class="n">neuron_count</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Convolution window size in bins: </span><span class="si">{</span><span class="n">window_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Feature shape: </span><span class="si">{</span><span class="n">input_feature</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Feature shape: </span><span class="si">{</span><span class="n">input_feature</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can visualize the output for a few time bins</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">suptitle</span> <span class="o">=</span> <span class="s2">&quot;Input feature: Count History&quot;</span>
<span class="n">neuron_id</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">workshop_utils</span><span class="o">.</span><span class="n">plot_features</span><span class="p">(</span><span class="n">input_feature</span><span class="p">,</span> <span class="n">count</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="n">suptitle</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>As you may see, the time axis is backward, this happens because under the hood, the basis is using the convolution operator which flips the time axis.
This is equivalent, as we can interpret the result as how much a spike will affect the future rate.
In the previous tutorial our feature was 1-dimensional (just the current), now
instead the feature dimension is 80, because our bin size was 0.01 sec and the window size is 0.8 sec.
We can learn these weights by maximum likelihood by fitting a GLM.</p>
</section>
<section id="fitting-the-model">
<h2>Fitting the Model<a class="headerlink" href="#fitting-the-model" title="Link to this heading">#</a></h2>
<p>When working a real dataset, it is good practice to train your models on a chunk of the data and
use the other chunk to assess the model performance. This process is known as “cross-validation”.
There is no unique strategy on how to cross-validate your model; What works best
depends on the characteristic of your data (time series or independent samples,
presence or absence of trials…), and that of your model. Here, for simplicity use the first
half of the wake epochs for training and the second half for testing. This is a reasonable
choice if the statistics of the neural activity does not change during the course of
the recording. We will learn about better cross-validation strategies with other
examples.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># construct the train and test epochs</span>
<span class="n">duration</span> <span class="o">=</span> <span class="n">input_feature</span><span class="o">.</span><span class="n">time_support</span><span class="o">.</span><span class="n">tot_length</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">input_feature</span><span class="o">.</span><span class="n">time_support</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">input_feature</span><span class="o">.</span><span class="n">time_support</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span>

<span class="c1"># define the interval sets</span>
<span class="n">first_half</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">IntervalSet</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">duration</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">second_half</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">IntervalSet</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">duration</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Question: Can you fit the glm to the first half of the recording and visualize the maximum likelihood weights?</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># define the GLM object</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">glm</span><span class="o">.</span><span class="n">GLM</span><span class="p">(</span><span class="n">solver_name</span><span class="o">=</span><span class="s2">&quot;LBFGS&quot;</span><span class="p">)</span>

<span class="c1"># Fit over the training epochs</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">input_feature</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">first_half</span><span class="p">),</span>
    <span class="n">neuron_count</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">first_half</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The weights represent the effect of a spike at time lag <span class="math notranslate nohighlight">\(i\)</span> on the rate at time <span class="math notranslate nohighlight">\(t\)</span>. The next cell display the learned weights.
The model should be called <code class="docutils literal notranslate"><span class="pre">model</span></code> from the previous cell.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Spike History Weights&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">window_size</span><span class="p">)</span> <span class="o">/</span> <span class="n">count</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;GLM raw history 1st Half&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time From Spike (sec)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Kernel&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The response in the previous figure seems noise added to a decay, therefore the response
can be described with fewer degrees of freedom. In other words, it looks like we
are using way too many weights to describe a simple response.
If we are correct, what would happen if we re-fit the weights on the other half of the data?</p>
<section id="inspecting-the-results">
<h3>Inspecting the results<a class="headerlink" href="#inspecting-the-results" title="Link to this heading">#</a></h3>
<p><strong>Question: Can you fit the model on the second half of the data and compare the results?</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># fit on the other half of the data</span>

<span class="n">model_second_half</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">glm</span><span class="o">.</span><span class="n">GLM</span><span class="p">(</span><span class="n">solver_name</span><span class="o">=</span><span class="s2">&quot;LBFGS&quot;</span><span class="p">)</span>
<span class="n">model_second_half</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">input_feature</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">second_half</span><span class="p">),</span>
    <span class="n">neuron_count</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">second_half</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Compare results.</p></li>
</ul>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Spike History Weights&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">window_size</span><span class="p">)</span> <span class="o">/</span> <span class="n">count</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">),</span>
         <span class="n">label</span><span class="o">=</span><span class="s2">&quot;GLM raw history 1st Half&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">window_size</span><span class="p">)</span> <span class="o">/</span> <span class="n">count</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span>  <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">model_second_half</span><span class="o">.</span><span class="n">coef_</span><span class="p">),</span>
         <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;GLM raw history 2nd Half&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time From Spike (sec)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Kernel&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>What can we conclude?</p>
<p>The fast fluctuations are inconsistent across fits, indicating that
they are probably capturing noise, a phenomenon known as over-fitting;
On the other hand, the decaying trend is fairly consistent, even if
our estimate is noisy. You can imagine how things could get
worst if we needed a finer temporal resolution, such 1ms time bins
(which would require 800 coefficients instead of 80).
What can we do to mitigate over-fitting now?</p>
<section id="reducing-feature-dimensionality">
<span id="head-direction-reducing-dimensionality"></span><h4>Reducing feature dimensionality<a class="headerlink" href="#reducing-feature-dimensionality" title="Link to this heading">#</a></h4>
<p>Let’s see how to use NeMoS’ <code class="docutils literal notranslate"><span class="pre">basis</span></code> module to reduce dimensionality and avoid over-fitting!
For history-type inputs, we’ll use again the raised cosine log-stretched basis,
<a class="reference external" href="https://www.jneurosci.org/content/25/47/11003">Pillow et al., 2005</a>.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">doc_plots</span><span class="o">.</span><span class="n">plot_basis</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<p>We can initialize the <code class="docutils literal notranslate"><span class="pre">RaisedCosineLogConv</span></code> by providing the number of basis functions
and the window size for the convolution. With more basis functions, we’ll be able to represent
the effect of the corresponding input with the higher precision, at the cost of adding additional parameters.</p>
<p><strong>Question: Can you define the basis <code class="docutils literal notranslate"><span class="pre">RaisedCosineLogConv</span></code>and name it <code class="docutils literal notranslate"><span class="pre">basis</span></code>?</strong></p>
<p>Basis parameters:</p>
<ul class="simple">
<li><p>8 basis functions.</p></li>
<li><p>Window size of 0.8sec.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># a basis object can be instantiated in &quot;conv&quot; mode for convolving  the input.</span>
<span class="n">basis</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">RaisedCosineLogConv</span><span class="p">(</span>
    <span class="n">n_basis_funcs</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="n">window_size</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Our spike history predictor was huge: every possible 80 time point chunk of the
data, for <span class="math notranslate nohighlight">\(144 \cdot 10^4\)</span> total numbers. By using this basis set we can instead reduce
the predictor to 8 numbers for every 80 time point window for <span class="math notranslate nohighlight">\(144 \cdot 10^3\)</span> total
numbers, an order of magnitude less. With 1ms bins we would have
achieved 2 order of magnitude reduction in input size. This is a huge benefit
in terms of memory allocation and, computing time. As an additional benefit,
we will reduce over-fitting.</p>
<p>Let’s see our basis in action. We can “compress” spike history feature by convolving the basis
with the counts (without creating the large spike history feature matrix).
This can be performed in NeMoS by calling the <code class="docutils literal notranslate"><span class="pre">compute_features</span></code> method of basis.</p>
<p><strong>Question: Can you:</strong></p>
<ul class="simple">
<li><p>Convolve the counts with the basis functions. (Call the output <code class="docutils literal notranslate"><span class="pre">conv_spk</span></code>)</p></li>
<li><p>Print the shape of <code class="docutils literal notranslate"><span class="pre">conv_spk</span></code> and compare it to <code class="docutils literal notranslate"><span class="pre">input_feature</span></code>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># equivalent to</span>
<span class="c1"># `nmo.convolve.create_convolutional_predictor(basis_kernels, neuron_count)`</span>
<span class="n">conv_spk</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">compute_features</span><span class="p">(</span><span class="n">neuron_count</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raw count history as feature: </span><span class="si">{</span><span class="n">input_feature</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Compressed count history as feature: </span><span class="si">{</span><span class="n">conv_spk</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s focus on two small time windows and visualize the features, which result from convolving the counts with the basis elements.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualize the convolution results</span>
<span class="n">epoch_one_spk</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">IntervalSet</span><span class="p">(</span><span class="mf">8917.5</span><span class="p">,</span> <span class="mf">8918.5</span><span class="p">)</span>
<span class="n">epoch_multi_spk</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">IntervalSet</span><span class="p">(</span><span class="mf">8979.2</span><span class="p">,</span> <span class="mf">8980.2</span><span class="p">)</span>

<span class="n">doc_plots</span><span class="o">.</span><span class="n">plot_convolved_counts</span><span class="p">(</span><span class="n">neuron_count</span><span class="p">,</span> <span class="n">conv_spk</span><span class="p">,</span> <span class="n">epoch_one_spk</span><span class="p">,</span> <span class="n">epoch_multi_spk</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fit-and-compare-the-models">
<h4>Fit and compare the models<a class="headerlink" href="#fit-and-compare-the-models" title="Link to this heading">#</a></h4>
<p>Now that we have our “compressed” history feature matrix, we can fit the ML parameters for a GLM.</p>
<p><strong>Question: Can you fit the model using the compressed features? Call it <code class="docutils literal notranslate"><span class="pre">model_basis</span></code>.</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># use restrict on interval set training</span>
<span class="n">model_basis</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">glm</span><span class="o">.</span><span class="n">GLM</span><span class="p">(</span><span class="n">solver_name</span><span class="o">=</span><span class="s2">&quot;LBFGS&quot;</span><span class="p">)</span>
<span class="n">model_basis</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">conv_spk</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">first_half</span><span class="p">),</span> <span class="n">neuron_count</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">first_half</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>We can plot the resulting response, noting that the weights we just learned needs to be “expanded” back
to the original <code class="docutils literal notranslate"><span class="pre">window_size</span></code> dimension by multiplying them with the basis kernels.
We have now 8 coefficients,</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">model_basis</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>In order to get the response we need to multiply the coefficients by their corresponding
basis function, and sum them.</p>
<p><strong>Question: Can you:</strong></p>
<ul class="simple">
<li><p>Reconstruct the history filter:</p>
<ul>
<li><p>Extract the basis kernels with <code class="docutils literal notranslate"><span class="pre">_,</span> <span class="pre">basis_kernels</span> <span class="pre">=</span> <span class="pre">basis.evaluate_on_grid(window_size)</span></code>.</p></li>
<li><p>Multiply the <code class="docutils literal notranslate"><span class="pre">basis_kernel</span></code> with the coefficient using <code class="docutils literal notranslate"><span class="pre">np.matmul</span></code>.</p></li>
</ul>
</li>
<li><p>Check the shape of <code class="docutils literal notranslate"><span class="pre">self_connection</span></code>.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">basis_kernels</span> <span class="o">=</span> <span class="o">...</span> <span class="c1"># get the basis function kernels</span>
<span class="n">self_connection</span> <span class="o">=</span> <span class="o">...</span> <span class="c1"># multiply with the weights</span>
<span class="nb">print</span><span class="p">(</span><span class="n">self_connection</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># get the basis function kernels</span>
<span class="n">_</span><span class="p">,</span> <span class="n">basis_kernels</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">evaluate_on_grid</span><span class="p">(</span><span class="n">window_size</span><span class="p">)</span>

<span class="c1"># multiply with the weights</span>
<span class="n">self_connection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">basis_kernels</span><span class="p">,</span> <span class="n">model_basis</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">self_connection</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s check if our new estimate does a better job in terms of over-fitting. We can do that
by visual comparison, as we did previously. Let’s fit the second half of the dataset.</p>
<p><strong>Question: Can you fit the other half of the data. Name it <code class="docutils literal notranslate"><span class="pre">model_basis_second_half</span></code>.</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model_basis_second_half</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">glm</span><span class="o">.</span><span class="n">GLM</span><span class="p">(</span><span class="n">solver_name</span><span class="o">=</span><span class="s2">&quot;LBFGS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">conv_spk</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">second_half</span><span class="p">),</span> <span class="n">neuron_count</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">second_half</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Question: Can you:</strong></p>
<ul class="simple">
<li><p>Get the response filters? Multiply the <code class="docutils literal notranslate"><span class="pre">basis_kernels</span></code> with the weights from <code class="docutils literal notranslate"><span class="pre">model_basis_second_half</span></code>.</p></li>
<li><p>Call the output <code class="docutils literal notranslate"><span class="pre">self_connection_second_half</span></code>.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">self_connection_second_half</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">basis_kernels</span><span class="p">,</span> <span class="n">model_basis_second_half</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And plot the results.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">window_size</span><span class="p">)</span> <span class="o">/</span> <span class="n">count</span><span class="o">.</span><span class="n">rate</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Spike History Weights&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">),</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;GLM raw history 1st half&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">model_second_half</span><span class="o">.</span><span class="n">coef_</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;GLM raw history 2nd half&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">self_connection</span><span class="p">,</span> <span class="s2">&quot;--k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;GLM basis 1st half&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">self_connection_second_half</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;GLM basis 2nd half&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time from spike (sec)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Weight&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Question: Can you:</strong></p>
<ul class="simple">
<li><p>Predict the rates from <code class="docutils literal notranslate"><span class="pre">model</span></code> and <code class="docutils literal notranslate"><span class="pre">model_basis</span></code>? Call it <code class="docutils literal notranslate"><span class="pre">rate_history</span></code> and <code class="docutils literal notranslate"><span class="pre">rate_basis</span></code>.</p></li>
<li><p>Convert the rate from spike/bin to spike/sec by multiplying with <code class="docutils literal notranslate"><span class="pre">conv_spk.rate</span></code>?</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rate_basis</span> <span class="o">=</span> <span class="n">model_basis</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">conv_spk</span><span class="p">)</span> <span class="o">*</span> <span class="n">conv_spk</span><span class="o">.</span><span class="n">rate</span>
<span class="n">rate_history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">input_feature</span><span class="p">)</span> <span class="o">*</span> <span class="n">conv_spk</span><span class="o">.</span><span class="n">rate</span>
</pre></div>
</div>
</div>
</div>
<p>And plot it.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ep</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">IntervalSet</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">8819.4</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">8821</span><span class="p">)</span>
<span class="c1"># plot the rates</span>
<span class="n">doc_plots</span><span class="o">.</span><span class="n">plot_rates_and_smoothed_counts</span><span class="p">(</span>
    <span class="n">neuron_count</span><span class="p">,</span>
    <span class="p">{</span><span class="s2">&quot;Self-connection raw history&quot;</span><span class="p">:</span><span class="n">rate_history</span><span class="p">,</span> <span class="s2">&quot;Self-connection bsais&quot;</span><span class="p">:</span> <span class="n">rate_basis</span><span class="p">}</span>
<span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="all-to-all-connectivity">
<h2>All-to-all Connectivity<a class="headerlink" href="#all-to-all-connectivity" title="Link to this heading">#</a></h2>
<p>The same approach can be applied to the whole population. Now the firing rate of a neuron
is predicted not only by its own count history, but also by the rest of the
simultaneously recorded population. We can convolve the basis with the counts of each neuron
to get an array of predictors of shape, <code class="docutils literal notranslate"><span class="pre">(num_time_points,</span> <span class="pre">num_neurons</span> <span class="pre">*</span> <span class="pre">num_basis_funcs)</span></code>.</p>
<section id="preparing-the-features">
<h3>Preparing the features<a class="headerlink" href="#preparing-the-features" title="Link to this heading">#</a></h3>
<p><strong>Question: Can you:</strong></p>
<ul class="simple">
<li><p>Re-define the basis?</p></li>
<li><p>Convolve all counts? Call the output in <code class="docutils literal notranslate"><span class="pre">convolved_count</span></code>.</p></li>
<li><p>Print the output shape?</p></li>
</ul>
<p>Since this time we are convolving more than one neuron, we need to reset the expected input shape.
This can be done by passing the population counts to the <code class="docutils literal notranslate"><span class="pre">set_input_shape</span></code> method.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">basis</span> <span class="o">=</span> <span class="o">...</span> <span class="c1"># reset the input shape by passing the population count</span>
<span class="n">convolved_count</span> <span class="o">=</span> <span class="o">...</span> <span class="c1"># convolve all the neurons</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># reset the input shape by passing the pop. count</span>
<span class="nb">print</span><span class="p">(</span><span class="n">count</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="mi">152</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>

<span class="n">basis</span><span class="o">.</span><span class="n">set_input_shape</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

<span class="c1"># convolve all the neurons</span>
<span class="n">convolved_count</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">compute_features</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Check the dimension to make sure it make sense.</p>
<p>Shape should be <code class="docutils literal notranslate"><span class="pre">(n_samples,</span> <span class="pre">n_basis_func</span> <span class="pre">*</span> <span class="pre">n_neurons)</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Convolved count shape: </span><span class="si">{</span><span class="n">convolved_count</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id1">
<h3>Fitting the Model<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<p>This is an all-to-all neurons model.
We are using the class <a class="reference external" href="https://nemos.readthedocs.io/en/latest/generated/glm/nemos.glm.PopulationGLM.html#nemos.glm.PopulationGLM" title="nemos 0.2.4"><span class="xref myst"><code class="docutils literal notranslate"><span class="pre">PopulationGLM</span></code></span></a> to fit the whole population at once.</p>
<p>Once we condition on past activity, log-likelihood of the population is the sum of the log-likelihood</p>
<p><strong>Question: Can you:</strong></p>
<ul class="simple">
<li><p>Fit a <code class="docutils literal notranslate"><span class="pre">PopulationGLM</span></code>? Call the object <code class="docutils literal notranslate"><span class="pre">model</span></code></p></li>
<li><p>Use Ridge regularization with a <code class="docutils literal notranslate"><span class="pre">regularizer_strength=0.1</span></code>?</p></li>
<li><p>Print the shape of the estimated coefficients.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">glm</span><span class="o">.</span><span class="n">PopulationGLM</span><span class="p">(</span>
    <span class="n">regularizer</span><span class="o">=</span><span class="s2">&quot;Ridge&quot;</span><span class="p">,</span>
    <span class="n">solver_name</span><span class="o">=</span><span class="s2">&quot;LBFGS&quot;</span><span class="p">,</span>
    <span class="n">regularizer_strength</span><span class="o">=</span><span class="mf">0.1</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">convolved_count</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model coefficients shape: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="comparing-model-predictions">
<h4>Comparing model predictions.<a class="headerlink" href="#comparing-model-predictions" title="Link to this heading">#</a></h4>
<p>Predict the rate (counts are already sorted by tuning prefs)</p>
<p>**Question: Can you:**11</p>
<ul class="simple">
<li><p>Predict the firing rate of each neuron? Call it <code class="docutils literal notranslate"><span class="pre">predicted_firing_rate</span></code>.</p></li>
<li><p>Convert the rate from spike/bin to spike/sec?</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">predicted_firing_rate</span> <span class="pre">=</span> <span class="pre">...</span> <span class="pre">#</span> <span class="pre">predict</span> <span class="pre">the</span> <span class="pre">rate</span> <span class="pre">from</span> <span class="pre">the</span> <span class="pre">model</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">predicted_firing_rate</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">convolved_count</span><span class="p">)</span> <span class="o">*</span> <span class="n">conv_spk</span><span class="o">.</span><span class="n">rate</span>
</pre></div>
</div>
</div>
</div>
<p>Plot fit predictions over a short window not used for training.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># use pynapple for time axis for all variables plotted for tick labels in imshow</span>
<span class="n">workshop_utils</span><span class="o">.</span><span class="n">plot_head_direction_tuning_model</span><span class="p">(</span><span class="n">tuning_curves</span><span class="p">,</span> <span class="n">spikes</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> 
                                                <span class="n">predicted_firing_rate</span><span class="p">,</span> <span class="n">threshold_hz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                <span class="n">start</span><span class="o">=</span><span class="mi">8910</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">8960</span><span class="p">,</span> <span class="n">cmap_label</span><span class="o">=</span><span class="s2">&quot;hsv&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s see if our firing rate predictions improved and in what sense.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">doc_plots</span><span class="o">.</span><span class="n">plot_rates_and_smoothed_counts</span><span class="p">(</span>
    <span class="n">neuron_count</span><span class="p">,</span>
    <span class="p">{</span><span class="s2">&quot;Self-connection: raw history&quot;</span><span class="p">:</span> <span class="n">rate_history</span><span class="p">,</span>
     <span class="s2">&quot;Self-connection: bsais&quot;</span><span class="p">:</span> <span class="n">rate_basis</span><span class="p">,</span>
     <span class="s2">&quot;All-to-all: basis&quot;</span><span class="p">:</span> <span class="n">predicted_firing_rate</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualizing-the-connectivity">
<h4>Visualizing the connectivity<a class="headerlink" href="#visualizing-the-connectivity" title="Link to this heading">#</a></h4>
<p>Finally, we can extract and visualize the pairwise interactions between neurons.</p>
<p>**Question: Can you extract the weights and store it in a <code class="docutils literal notranslate"><span class="pre">(n_neurons,</span> <span class="pre">n_neurons,</span> <span class="pre">n_basis_funcs)</span></code> array?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># original shape of the weights</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GLM coeff: </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">split_by_feature</span></code> method of <code class="docutils literal notranslate"><span class="pre">basis</span></code> for this.</p>
<p><img alt="Reshape coefficients" src="../../_images/coeff_reshape.png" /></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># split the coefficient vector along the feature axis (axis=0)</span>
<span class="n">weights_dict</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">split_by_feature</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="c1"># visualize the content</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">weights_dict</span><span class="p">[</span><span class="s2">&quot;RaisedCosineLogConv&quot;</span><span class="p">]</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># split the coefficient vector along the feature axis (axis=0)</span>
<span class="n">weights_dict</span> <span class="o">=</span> <span class="n">basis</span><span class="o">.</span><span class="n">split_by_feature</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># the output is a dict with key the basis label, </span>
<span class="c1"># and value the reshaped coefficients</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">weights_dict</span><span class="p">[</span><span class="s2">&quot;RaisedCosineLogConv&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Re-shaped coeff: </span><span class="si">{</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The shape is <code class="docutils literal notranslate"><span class="pre">(sender_neuron,</span> <span class="pre">num_basis,</span> <span class="pre">receiver_neuron)</span></code>.</p>
<p>Let’s reconstruct the coupling filters by multiplying the weights with the basis functions.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">responses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;jki,tk-&gt;ijt&quot;</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">basis_kernels</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">responses</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we can visualize the pairwise interactions by plotting
all the coupling filters.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">predicted_tuning_curves</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">compute_tuning_curves</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">predicted_firing_rate</span><span class="p">,</span>
    <span class="n">features</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> 
    <span class="n">bins</span><span class="o">=</span><span class="mi">61</span><span class="p">,</span> 
    <span class="n">epochs</span> <span class="o">=</span> <span class="n">angle</span><span class="o">.</span><span class="n">time_support</span><span class="p">,</span>
    <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Angle&quot;</span><span class="p">]</span>
    <span class="p">)</span>

                                                 
<span class="n">fig</span> <span class="o">=</span> <span class="n">workshop_utils</span><span class="o">.</span><span class="n">plot_coupling_filters</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">predicted_tuning_curves</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="fundamentals_of_pynapple-presenters.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Learning the fundamentals of pynapple</p>
      </div>
    </a>
    <a class="right-next"
       href="phase_precession-presenters.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Signal processing and decoding in pynapple</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Data analysis with pynapple &amp; nemos</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">Learning objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-a-nwb-file">Loading a NWB file</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-tuning-curves">Compute tuning curves</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decode-neural-activity">Decode neural activity</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compute-correlograms">Compute correlograms</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#fitting-a-glm-model-with-nemos">Fitting a GLM model with Nemos</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#features-construction">Features Construction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fitting-the-model">Fitting the Model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inspecting-the-results">Inspecting the results</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#reducing-feature-dimensionality">Reducing feature dimensionality</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-and-compare-the-models">Fit and compare the models</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#all-to-all-connectivity">All-to-all Connectivity</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preparing-the-features">Preparing the features</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Fitting the Model</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#comparing-model-predictions">Comparing model predictions.</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-the-connectivity">Visualizing the connectivity</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Edoardo Balzani, Billy Broderick, Sarah Jo Venditto, Guillaume Viejo
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025, Edoardo Balzani, Billy Broderick, Sarah Jo Venditto, Guillaume Viejo.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>