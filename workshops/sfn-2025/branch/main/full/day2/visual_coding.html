
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Exploring the Visual Coding Dataset &#8212; CCN software workshop, SfN 2025  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=f4437bd1" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'full/day2/visual_coding';</script>
    <link rel="icon" href="../../_static/ccn_small.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="For users (some code, some text)" href="../../users/index.html" />
    <link rel="prev" title="NeMoS Advanced: Cross-Validation and Model Selection" href="nemos_advanced.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/01-FI-primary-logo-color.png" class="logo__image only-light" alt="Home"/>
    <script>document.write(`<img src="../../_static/03-FI-primary-logo-white.png" class="logo__image only-dark" alt="Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/flatironinstitute/ccn-software-sfn-2025" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://flatironinstitute.github.io/neurorse-workshops/" title="Workshops home" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-house fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Workshops home</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://binder.flatironinstitute.org/v2/user/wbroderick/sfn2025?labpath=notebooks/" title="Binder" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="https://mybinder.org/badge_logo.svg" class="icon-link-image" alt="Binder"/></a>
        </li>
</ul></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    Welcome!
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Full notebooks</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../day1/fundamentals_of_pynapple.html">Learning the fundamentals of pynapple</a></li>
<li class="toctree-l1"><a class="reference internal" href="../day1/head_direction.html">Data analysis with pynapple &amp; nemos</a></li>

<li class="toctree-l1"><a class="reference internal" href="../day1/phase_precession.html">Group Project: Analyzing hippocampal place cells with Pynapple and NeMoS</a></li>
<li class="toctree-l1"><a class="reference internal" href="current_injection.html">Introduction to GLM</a></li>
<li class="toctree-l1"><a class="reference internal" href="nemos_advanced.html">NeMoS Advanced: Cross-Validation and Model Selection</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Exploring the Visual Coding Dataset</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Limited notebooks</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../users/index.html">For users (some code, some text)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../users/day1/fundamentals_of_pynapple-users.html">Learning the fundamentals of pynapple</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../users/day1/head_direction-users.html">Data analysis with pynapple &amp; nemos</a></li>

<li class="toctree-l2"><a class="reference internal" href="../../users/day1/phase_precession-users.html">Group Project: Analyzing hippocampal place cells with Pynapple and NeMoS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../users/day2/current_injection-users.html">Introduction to GLM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../users/day2/nemos_advanced-users.html">NeMoS Advanced: Cross-Validation and Model Selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../users/day2/visual_coding-users.html">Exploring the Visual Coding Dataset</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../presenters/index.html">For presenter reference (all code, no text)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../presenters/day1/fundamentals_of_pynapple-presenters.html">Learning the fundamentals of pynapple</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presenters/day1/head_direction-presenters.html">Data analysis with pynapple &amp; nemos</a></li>

<li class="toctree-l2"><a class="reference internal" href="../../presenters/day1/phase_precession-presenters.html">Group Project: Analyzing hippocampal place cells with Pynapple and NeMoS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presenters/day2/current_injection-presenters.html">Introduction to GLM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presenters/day2/nemos_advanced-presenters.html">NeMoS Advanced: Cross-Validation and Model Selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presenters/day2/visual_coding-presenters.html">Exploring the Visual Coding Dataset</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/flatironinstitute/ccn-software-sfn-2025" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/full/day2/visual_coding.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Exploring the Visual Coding Dataset</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-and-preparing-data">Downloading and preparing data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preliminary-analyses-and-neuron-selection">Preliminary analyses and neuron selection</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#avoiding-overfitting">Avoiding overfitting</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-a-glm">Fit a GLM</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prepare-data">Prepare data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#construct-design-matrix">Construct design matrix</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#construct-and-fit-your-model">Construct and fit your model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#score-your-model">Score your model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#try-to-improve-your-model">Try to improve your model?</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell tag_hide-input tag_render-all docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
    <span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;plotting functions contained within `_documentation_utils` are intended for nemos&#39;s documentation.&quot;</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
    <span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Converting &#39;d&#39; to numpy.array&quot;</span><span class="p">,</span>
    <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="important render-all admonition">
<p class="admonition-title">Download</p>
<p>This notebook can be downloaded as <strong><a class="reference download internal" download="" href="../../_downloads/c616133a2f96b1827552c39b0f655454/visual_coding.ipynb"><code class="xref download myst-nb docutils literal notranslate"><span class="pre">visual_coding.ipynb</span></code></a></strong>. See the button at the top right to download as markdown or pdf.</p>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="exploring-the-visual-coding-dataset">
<h1>Exploring the Visual Coding Dataset<a class="headerlink" href="#exploring-the-visual-coding-dataset" title="Link to this heading">#</a></h1>
<div class="render-all">
<p>This notebook serves as a group project: in groups of 4 or 5, you will analyze data from the <a class="reference external" href="https://portal.brain-map.org/circuits-behavior/visual-coding-neuropixels">Visual Coding - Neuropixels dataset</a>, published by the Allen Institute. This dataset uses <a class="reference external" href="https://www.nature.com/articles/nature24636">extracellular electrophysiology probes</a> to record spikes from multiple regions in the brain during passive visual stimulation.</p>
<p>To start, we will focus on the activity of neurons in the visual cortex (VISp) during passive exposure to full-field flashes of color either black (coded as “-1.0”) or white (coded as “1.0”) in a gray background. If you have time, you can apply the same procedure to other stimuli or brain areas.</p>
<p>In this notebook, the pre-filled section will first select visually responsive neurons in area VISp. Then, you will fit GLMs to the selected neurons using <code class="docutils literal notranslate"><span class="pre">nemos</span></code>.</p>
<p>As this is the last notebook, the instructions are a bit more hands-off: you will make more of the modeling decisions yourselves. As a group, you will use your neuroscience knowledge and the skills gained over this workshop to decide:</p>
<ul class="simple">
<li><p>How to avoid overfitting.</p></li>
<li><p>What features to include in your GLMs.</p></li>
<li><p>Which basis functions (and parameters) to use for each feature.</p></li>
<li><p>How to regularize your features.</p></li>
<li><p>How to evaluate your model.</p></li>
</ul>
<p>At the end of this session, we will regroup to discuss the decisions people made and evaluate each others’ models.</p>
</div>
<p>This notebook is adapted from Camila Maura’s <a class="reference external" href="https://alleninstitute.github.io/openscope_databook/higher-order/GLM_pynapple_nemos.html">Intro to GLM notebook</a> in the Allen Institute OpenScope Databook. See that notebook for a thorough introduction to using <code class="docutils literal notranslate"><span class="pre">pynapple</span></code> and <code class="docutils literal notranslate"><span class="pre">nemos</span></code> by fitting this dataset.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import everything</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">jax</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pynapple</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nap</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">nemos</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nmo</span>

<span class="c1"># some helper plotting functions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nemos</span><span class="w"> </span><span class="kn">import</span> <span class="n">_documentation_utils</span> <span class="k">as</span> <span class="n">doc_plots</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">workshop_utils</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="kn">import</span> <span class="n">MaxNLocator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_kde</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">Patch</span>

<span class="c1"># configure plots some</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">nmo</span><span class="o">.</span><span class="n">styles</span><span class="o">.</span><span class="n">plot_style</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:2025-10-31 19:15:26,281:jax._src.xla_bridge:850: An NVIDIA GPU may be present on this machine, but a CUDA-enabled jaxlib is not installed. Falling back to cpu.
</pre></div>
</div>
</div>
</div>
<section id="downloading-and-preparing-data">
<h2>Downloading and preparing data<a class="headerlink" href="#downloading-and-preparing-data" title="Link to this heading">#</a></h2>
<div class="render-all">
In this section, we will download the data and extract the relevant parts for analysis and modeling. This section is largely presented to you as is, so that you can get to the substantive sections more quickly.
<p>First we download and load the data into pynapple.</p>
</div><div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">workshop_utils</span><span class="o">.</span><span class="n">fetch_data</span><span class="p">(</span><span class="s2">&quot;visual_coding_data.zip&quot;</span><span class="p">)</span>
<span class="n">flashes</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="p">[</span><span class="n">nap</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading file &#39;visual_coding_data.zip&#39; from &#39;https://osf.io/download/6c7rj&#39; to &#39;/home/agent/workspace/rorse_ccn-software-sfn-2025_main/lib/python3.12/data&#39;.
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Unzipping contents of &#39;/home/agent/workspace/rorse_ccn-software-sfn-2025_main/lib/python3.12/data/visual_coding_data.zip&#39; to &#39;/home/agent/workspace/rorse_ccn-software-sfn-2025_main/lib/python3.12/data/visual_coding_data.zip.unzip&#39;
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Full dataset?</p>
<p>In this notebook, we are using only a subset of the full dataset. We’ve done a little bit of preprocessing and selection to reduce the size of the total file, which includes neurons from many different brain areas and stimulus paradigms.</p>
<p>To load the whole dataset for this session, run the following:</p>
<p><strong>WARNING:</strong> this dataset is 2.6GB, so the following may take a while to run.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dataset information</span>
<span class="n">dandiset_id</span> <span class="o">=</span> <span class="s2">&quot;000021&quot;</span>
<span class="n">dandi_filepath</span> <span class="o">=</span> <span class="s2">&quot;sub-726298249/sub-726298249_ses-754829445.nwb&quot;</span>

<span class="c1"># Download the data using NeMoS</span>
<span class="n">io</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">fetch</span><span class="o">.</span><span class="n">download_dandi_data</span><span class="p">(</span><span class="n">dandiset_id</span><span class="p">,</span> <span class="n">dandi_filepath</span><span class="p">)</span>

<span class="c1"># load data using pynapple</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">NWBFile</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">lazy_loading</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">data</span></code> is then a pynapple NWB object, as we’ve interacted with in other notebooks. The following additional preprocessing was done to the NWB file before saving to the files we load at the beginning of this notebook:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># grab the spiking data</span>
<span class="n">units</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span>

<span class="c1"># map from electrodes to brain area</span>
<span class="n">channel_probes</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">elec</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">nwb</span><span class="o">.</span><span class="n">electrodes</span><span class="p">:</span>
    <span class="n">channel_id</span> <span class="o">=</span> <span class="n">elec</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">location</span> <span class="o">=</span> <span class="n">elec</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">channel_probes</span><span class="p">[</span><span class="n">channel_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">location</span>

<span class="c1"># Add a new column to include location in our spikes TsGroup</span>
<span class="n">units</span><span class="o">.</span><span class="n">brain_area</span> <span class="o">=</span> <span class="p">[</span><span class="n">channel_probes</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ch_id</span><span class="p">)]</span> <span class="k">for</span> <span class="n">ch_id</span> <span class="ow">in</span> <span class="n">units</span><span class="o">.</span><span class="n">peak_channel_id</span><span class="p">]</span>
<span class="c1"># and only grab those located in area VISp</span>
<span class="n">units</span> <span class="o">=</span> <span class="n">units</span><span class="p">[</span><span class="n">units</span><span class="o">.</span><span class="n">brain_area</span> <span class="o">==</span> <span class="s2">&quot;VISp&quot;</span><span class="p">]</span>

<span class="c1"># drop unnecessary metadata</span>
<span class="n">units</span><span class="o">.</span><span class="n">restrict_info</span><span class="p">([</span><span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="s2">&quot;quality&quot;</span><span class="p">,</span> <span class="s2">&quot;brain_area&quot;</span><span class="p">])</span>

<span class="n">flashes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;flashes_presentations&quot;</span><span class="p">]</span>
<span class="n">flashes</span><span class="o">.</span><span class="n">restrict_info</span><span class="p">([</span><span class="s2">&quot;color&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>See <a class="reference external" href="https://portal.brain-map.org/circuits-behavior/visual-coding-neuropixels">Allen Institute website</a> for more information on the dataset.</p>
</div>
<div class="render-all">
<p>Now that we have our spiking data, let’s restrict our dataset to the relevant part.</p>
<p><img alt="Visual stimuli set" src="../../_images/visual_stimuli_set.png" /></p>
<p>During the flashes presentation trials, mice were exposed to white or black full-field flashes in a gray background, each lasting 250 ms, and separated by a 2 second inter-trial interval. In total, they were exposed to 150 flashes (75 black, 75 white).</p>
</div><div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create a separate object for black and white flashes</span>
<span class="n">flashes_white</span> <span class="o">=</span> <span class="n">flashes</span><span class="p">[</span><span class="n">flashes</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1.0&quot;</span><span class="p">]</span>
<span class="n">flashes_black</span> <span class="o">=</span> <span class="n">flashes</span><span class="p">[</span><span class="n">flashes</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-1.0&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="render-all">
<p>Let’s visualize our stimuli:</p>
</div><div class="cell tag_render-all tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_flashes</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">n_seconds</span> <span class="o">=</span> <span class="mi">13</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mf">.5</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">flashes</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">offset</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">n_seconds</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="n">flash</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">flashes_white</span><span class="p">,</span> <span class="n">flashes_black</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;silver&quot;</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">fl</span> <span class="ow">in</span> <span class="n">flash</span><span class="p">[:</span><span class="n">n_flashes</span><span class="p">]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fl</span><span class="o">.</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.4</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>      

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Absent = 0, Present = 1&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Stimuli presentation&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">integer</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">start</span><span class="o">-</span><span class="mf">.1</span><span class="p">,</span><span class="n">end</span><span class="p">)</span>
    
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1285.000869922, 1298.100869922)
</pre></div>
</div>
<img alt="../../_images/eeb931f4863bf108e3a85a9c66923ecf28f6606f7e5b49437969f45d1c6e4951.png" src="../../_images/eeb931f4863bf108e3a85a9c66923ecf28f6606f7e5b49437969f45d1c6e4951.png" />
</div>
</div>
</section>
<section id="preliminary-analyses-and-neuron-selection">
<h2>Preliminary analyses and neuron selection<a class="headerlink" href="#preliminary-analyses-and-neuron-selection" title="Link to this heading">#</a></h2>
<div class="render-all">
<p>In this section, we will select a subset of the neurons that are visually responsive, which we will fit our GLM to.</p>
<p>First, we’ll construct a <a class="reference external" href="https://pynapple.org/generated/pynapple.IntervalSet.html#pynapple.IntervalSet" title="(in pynapple v0.10.0)"><code class="xref py py-class docutils literal notranslate"><span class="pre">IntervalSet</span></code></a> called <code class="docutils literal notranslate"><span class="pre">extended_flashes</span></code> which contains the peristimulus time. Right now, our <code class="docutils literal notranslate"><span class="pre">flashes</span></code> <code class="docutils literal notranslate"><span class="pre">IntervalSet</span></code> defines the start and end time for the flashes. In order to make sure we can model the pre-stimulus baseline and any responses to the stimulus being turned off, we would like to expand these intervals to go from 500 msecs before the start of the stimuli to 500 msecs after the end.</p>
<p>This <code class="docutils literal notranslate"><span class="pre">IntervalSet</span></code> will be the same shape as <code class="docutils literal notranslate"><span class="pre">flashes</span></code> and have the same metadata columns.</p>
</div><div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dt</span> <span class="o">=</span> <span class="mf">.50</span> <span class="c1"># 500 ms</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">flashes</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">dt</span> <span class="c1"># Start 500 ms before stimulus presentation</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">flashes</span><span class="o">.</span><span class="n">end</span> <span class="o">+</span> <span class="n">dt</span> <span class="c1"># End 500 ms after stimulus presentation</span>

<span class="n">extended_flashes</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">IntervalSet</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">flashes</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<div class="render-all">
<p>Now, we’ll create two separate <code class="docutils literal notranslate"><span class="pre">IntervalSet</span></code> objects, <code class="docutils literal notranslate"><span class="pre">extended_flashes_black</span></code> and <code class="docutils literal notranslate"><span class="pre">extended_flashes_white</span></code>, which contain this info for only the black and the white flashes, respectively.</p>
</div><div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">extended_flashes_white</span> <span class="o">=</span> <span class="n">extended_flashes</span><span class="p">[</span><span class="n">extended_flashes</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;1.0&quot;</span><span class="p">]</span>
<span class="n">extended_flashes_black</span> <span class="o">=</span> <span class="n">extended_flashes</span><span class="p">[</span><span class="n">extended_flashes</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-1.0&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="render-all">
<p>Now, we’ll select our neurons. There are four criteria we want to use:</p>
<ol class="arabic simple">
<li><p>Brain area: we are interested in analyzing VISp units for this tutorial</p></li>
<li><p>Quality: we will only select “good” quality units. If you’re curious, you can (optionally) <a class="reference external" href="https://alleninstitute.github.io/openscope_databook/visualization/visualize_unit_metrics.html">read more</a> how about the Allen Institute defines quality.</p></li>
<li><p>Firing rate: overall, we want units with a firing rate larger than 2Hz around the presentation of stimuli</p></li>
<li><p>Responsiveness: we want units that actually respond to changes in the visual stimuli, i.e., their firing rate changes as a result of the stimulus.</p></li>
</ol>
<p>We’ll create a new <code class="docutils literal notranslate"><span class="pre">TsGroup</span></code>, <code class="docutils literal notranslate"><span class="pre">selected_units</span></code>, which includes only those units that meet the first three criteria, then check that it passes the assertion block.</p>
</div><div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Filter units according criteria 1 &amp; 2</span>
<span class="n">selected_units</span> <span class="o">=</span> <span class="n">units</span><span class="p">[(</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;brain_area&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;VISp&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;quality&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;good&quot;</span><span class="p">)]</span> 

<span class="c1"># Restrict around stimuli presentation</span>
<span class="n">selected_units</span> <span class="o">=</span> <span class="n">selected_units</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">extended_flashes</span><span class="p">)</span> 

<span class="c1"># Filter according to criterion 3</span>
<span class="n">selected_units</span> <span class="o">=</span> <span class="n">selected_units</span><span class="p">[(</span><span class="n">selected_units</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">2.0</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="render-all">
<p>Now, in order to determine the responsiveness of the units, it’s helpful to use the <a class="reference external" href="https://pynapple.org/generated/pynapple.process.perievent.html#pynapple.process.perievent.compute_perievent" title="(in pynapple v0.10.0)"><code class="xref py py-func docutils literal notranslate"><span class="pre">compute_perievent()</span></code></a> function: this will align units’ spiking timestamps with the onset of the stimulus repetitions and take an average over them.</p>
<p>Let’s use that function to construct two separate perievent dictionaries, one aligned to the start of the white stimuli, one aligned to the start of the black, and they should run from 250 msec before to 500 msec after the event.</p>
</div><div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set window of perievent 500 ms before and after the start of the event</span>
<span class="n">window_size</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">.250</span><span class="p">,</span> <span class="mf">.500</span><span class="p">)</span> 

<span class="n">peri_white</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">compute_perievent</span><span class="p">(</span><span class="n">timestamps</span><span class="o">=</span><span class="n">selected_units</span><span class="p">,</span>
                                   <span class="n">tref</span><span class="o">=</span><span class="n">nap</span><span class="o">.</span><span class="n">Ts</span><span class="p">(</span><span class="n">flashes_white</span><span class="o">.</span><span class="n">start</span><span class="p">),</span>
                                   <span class="n">minmax</span><span class="o">=</span><span class="n">window_size</span><span class="p">)</span>
<span class="n">peri_black</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">compute_perievent</span><span class="p">(</span><span class="n">timestamps</span><span class="o">=</span><span class="n">selected_units</span><span class="p">,</span>
                                   <span class="n">tref</span><span class="o">=</span><span class="n">nap</span><span class="o">.</span><span class="n">Ts</span><span class="p">(</span><span class="n">flashes_black</span><span class="o">.</span><span class="n">start</span><span class="p">),</span>
                                   <span class="n">minmax</span><span class="o">=</span><span class="n">window_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="render-all">
<p>Visualizing these perievents can help us determine what features we’ll want to include in our GLM. The following helper function should help.</p>
</div><div class="cell tag_render-all tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_raster_psth</span><span class="p">(</span><span class="n">peri</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">color_flashes</span><span class="p">,</span> <span class="n">n_units</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">start_unit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mf">.005</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mf">0.015</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot perievent time histograms (PSTHs) and raster plots for multiple units.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    peri : dict</span>
<span class="sd">        Dictionary mapping unit names to binned spike count peri-stimulus data (e.g., binned time series).</span>
<span class="sd">    units : dict</span>
<span class="sd">        Dictionary of neural units, e.g., spike trains or trial-aligned spike events.</span>
<span class="sd">    color_flashes : str</span>
<span class="sd">        A label indicating the flash color condition (&#39;black&#39; or &#39;white&#39;), used for visual styling.</span>
<span class="sd">    n_units : int</span>
<span class="sd">        The number of units to visualize.</span>
<span class="sd">    start_unit : int</span>
<span class="sd">        The index of the unit to start with.</span>
<span class="sd">    bin_size : float</span>
<span class="sd">        Size of the bin used for spike count computation (in seconds).</span>
<span class="sd">    smoothing : float</span>
<span class="sd">        Standard deviation for Gaussian smoothing of the PSTH traces.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Layout setup: 9 columns (units), 2 rows (split vertically into PSTH and raster plot)</span>
    <span class="n">n_cols</span> <span class="o">=</span> <span class="n">n_units</span>
    <span class="n">n_rows</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span>
                             <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_cols</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

    <span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab10</span><span class="o">.</span><span class="n">colors</span>

    <span class="c1"># Extract unit names for iteration</span>
    <span class="n">units_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">start_unit</span><span class="p">:</span><span class="n">start_unit</span><span class="o">+</span><span class="n">n_units</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">units_list</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">peri</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span>
        <span class="n">line_color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)]</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>

        <span class="c1"># Plot PSTH (smoothed firing rate)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">bin_size</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">bin_size</span><span class="p">)</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">std</span><span class="o">=</span><span class="n">smoothing</span><span class="p">),</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">line_color</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># Stimulus onset line</span>

        <span class="n">span_color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span> <span class="k">if</span> <span class="n">color_flashes</span> <span class="o">==</span> <span class="s2">&quot;black&quot;</span> <span class="k">else</span> <span class="s2">&quot;silver&quot;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.250</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">span_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>  <span class="c1"># Stim duration</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Plot raster</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">to_tsd</span><span class="p">(),</span> <span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">line_color</span><span class="p">,</span> <span class="n">mew</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.250</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">span_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>

    <span class="c1"># Y-axis and title annotations</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Rate (Hz)&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Trial&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_rows</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Rate (Hz)&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Trial&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="s1">&#39;Time from stim(s)&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;PSTH &amp; Spike Raster Plot - </span><span class="si">{</span><span class="n">color_flashes</span><span class="si">}</span><span class="s1"> flashes&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># called like this, the function will visualize the first 9 units. play with the n_units</span>
<span class="c1"># and start_unit arguments to see the other units.</span>
<span class="n">plot_raster_psth</span><span class="p">(</span><span class="n">peri_white</span><span class="p">,</span> <span class="n">selected_units</span><span class="p">,</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">n_units</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">start_unit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plot_raster_psth</span><span class="p">(</span><span class="n">peri_black</span><span class="p">,</span> <span class="n">selected_units</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">n_units</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">start_unit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/2de61422b8e6d841eaf13ecc145c5b8c24046d3cba47b5a9ace9cc768f9ce750.png" src="../../_images/2de61422b8e6d841eaf13ecc145c5b8c24046d3cba47b5a9ace9cc768f9ce750.png" />
<img alt="../../_images/874820a09ff8482c6847ceb4453e37d0986e121ea20d213f45cf3885a8cddddd.png" src="../../_images/874820a09ff8482c6847ceb4453e37d0986e121ea20d213f45cf3885a8cddddd.png" />
</div>
</div>
<div class="render-all">
<p>You could manually visualize each of our units and select those that appear, from their PSTH to be responsive.</p>
<p>However, it would be easier to scale (and more reproducible) if you came up with some measure of responsiveness. So how do we compute something that captures “this neuron responds to visual stimuli”? Here, we will define “responsiveness” as the normalized difference in average firing rate between during stimulus presentation and before the stimulus was presented. We’ll define a function that does that in the following hidden cell.</p>
<p>If you have other ideas and the time to explore them, you can return to this section and try other definitions of responsiveness.</p>
</div><div class="cell tag_render-all tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_responsiveness</span><span class="p">(</span><span class="n">perievents</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mf">0.005</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate responsiveness for each neuron. This is computed as:</span>

<span class="sd">    post_presentation_avg  : </span>
<span class="sd">        Average firing rate during presentation (250 ms) of stimulus across</span>
<span class="sd">        all instances of stimulus. </span>

<span class="sd">    pre_presentation_avg :</span>
<span class="sd">        Average firing rate prior (250 ms) to the presentation of stimulus</span>
<span class="sd">        across all instances prior of stimulus. </span>

<span class="sd">    responsiveness : </span>
<span class="sd">        abs((post_presentation_avg - pre_presentation_avg) / (post_presentation_avg + pre_presentation_avg))</span>

<span class="sd">    Larger values indicate higher responsiveness to the stimuli.</span>
<span class="sd">        </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    perievents : TsGroup</span>
<span class="sd">        Contains perievent information of a subset of neurons</span>
<span class="sd">    bin_size : float</span>
<span class="sd">        Bin size for calculating spike counts</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------   </span>
<span class="sd">    resp_array : np.array</span>
<span class="sd">        Array of responsiveness information.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resp_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">resp_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">perievents</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">peri</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">perievents</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
        <span class="c1"># Count the number of timestamps in each bin_size bin.</span>
        <span class="n">peri_counts</span> <span class="o">=</span> <span class="n">peri</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">bin_size</span><span class="p">)</span>

        <span class="c1"># Compute average spikes for each millisecond in the</span>
        <span class="c1"># the 250 ms before stimulus presentation</span>
        <span class="n">pre_presentation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">peri_counts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">nap</span><span class="o">.</span><span class="n">IntervalSet</span><span class="p">([</span><span class="o">-</span><span class="mf">.25</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># Compute average spikes for each millisecond in the</span>
        <span class="c1"># the 250 ms after stimulus presentation</span>
        <span class="n">post_presentation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">peri_counts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">nap</span><span class="o">.</span><span class="n">IntervalSet</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mf">.25</span><span class="p">]))</span>

        <span class="n">pre_presentation_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pre_presentation</span><span class="p">)</span>
        <span class="n">post_presentation_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">post_presentation</span><span class="p">)</span>
        <span class="n">responsiveness</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">post_presentation_avg</span> <span class="o">-</span> <span class="n">pre_presentation_avg</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">post_presentation_avg</span> <span class="o">+</span> <span class="n">pre_presentation_avg</span><span class="p">))</span>

        <span class="n">resp_array</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">responsiveness</span>

    <span class="k">return</span> <span class="n">resp_array</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute the responsiveness measure</span>
<span class="n">responsiveness_white</span> <span class="o">=</span> <span class="n">get_responsiveness</span><span class="p">(</span><span class="n">peri_white</span><span class="p">)</span>
<span class="n">responsiveness_black</span> <span class="o">=</span> <span class="n">get_responsiveness</span><span class="p">(</span><span class="n">peri_black</span><span class="p">)</span>

<span class="c1"># Get threshold for top 15% most responsive</span>
<span class="n">thresh_black</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">responsiveness_black</span><span class="p">,</span> <span class="mi">85</span><span class="p">)</span>
<span class="n">thresh_white</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">responsiveness_white</span><span class="p">,</span> <span class="mi">85</span><span class="p">)</span>

<span class="c1"># Only keep units that are within the 15% most responsive for either black or white</span>
<span class="n">selected_units</span> <span class="o">=</span> <span class="n">selected_units</span><span class="p">[(</span><span class="n">responsiveness_black</span> <span class="o">&gt;</span> <span class="n">thresh_black</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">responsiveness_white</span> <span class="o">&gt;</span> <span class="n">thresh_white</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="render-all">
<p>Let’s visualize the selected units PSTHs to make sure they all look reasonable:</p>
</div><div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Remaining units: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_units</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">peri_white</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">peri_white</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">selected_units</span><span class="o">.</span><span class="n">index</span><span class="p">}</span>
<span class="n">peri_black</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">peri_black</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">selected_units</span><span class="o">.</span><span class="n">index</span><span class="p">}</span>

<span class="n">plot_raster_psth</span><span class="p">(</span><span class="n">peri_black</span><span class="p">,</span> <span class="n">selected_units</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">n_units</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">peri_black</span><span class="p">))</span>
<span class="n">plot_raster_psth</span><span class="p">(</span><span class="n">peri_white</span><span class="p">,</span> <span class="n">selected_units</span><span class="p">,</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">n_units</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">peri_white</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Remaining units: 19
</pre></div>
</div>
<img alt="../../_images/d4ce09732564c17f430f96399b8631013aebb614ab0f06bc9424f6af72e35c86.png" src="../../_images/d4ce09732564c17f430f96399b8631013aebb614ab0f06bc9424f6af72e35c86.png" />
<img alt="../../_images/035157d0deef4155693d865897801afd2cd26fd4e32edac387362a209d15d39d.png" src="../../_images/035157d0deef4155693d865897801afd2cd26fd4e32edac387362a209d15d39d.png" />
</div>
</div>
</section>
<section id="avoiding-overfitting">
<h2>Avoiding overfitting<a class="headerlink" href="#avoiding-overfitting" title="Link to this heading">#</a></h2>
<div class="render-all">
<p>As we’ve seen throughout this workshop, it is important to avoid overfitting your model. We’ve covered two strategies for doing so: either separate your dataset into train and test subsets or set up a cross-validation scheme. Pick one of these approaches and use it when fitting your GLM model in the next section.</p>
<p>You might find it helpful to refer back to the <a class="reference internal" href="nemos_advanced.html#sklearn-cv"><span class="std std-ref">advanced nemos</span></a> notebook and / or to use the following pynapple functions: <code class="xref py py-func docutils literal notranslate"><span class="pre">set_diff()</span></code>, <code class="xref py py-func docutils literal notranslate"><span class="pre">union()</span></code>, <code class="xref py py-func docutils literal notranslate"><span class="pre">restrict()</span></code> (see <a class="reference internal" href="../../users/day1/phase_precession-users.html#phase-precess-cv"><span class="std std-ref">phase precession notebook</span></a>).</p>
<div class="hint admonition">
<p class="admonition-title">Hints</p>
<p>Throughout this section and the next we’ll include hints. They’ll either be links back to earlier notebooks from this workshop that show an example of how to do the step in question, or a hint admonition like this, which you can expand to get a hint.</p>
</div>
</div>
<p>Again, multiple viable ways of solving this. Here’s the simplest: grab every third flash and use that as the test set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We take one every three flashes (33% of all flashes of test)</span>
<span class="n">flashes_test_white</span> <span class="o">=</span> <span class="n">extended_flashes_white</span><span class="p">[::</span><span class="mi">3</span><span class="p">]</span>
<span class="n">flashes_test_black</span> <span class="o">=</span> <span class="n">extended_flashes_black</span><span class="p">[::</span><span class="mi">3</span><span class="p">]</span>
<span class="c1"># The remaining is separated for training</span>
<span class="n">flashes_train_white</span> <span class="o">=</span> <span class="n">extended_flashes_white</span><span class="o">.</span><span class="n">set_diff</span><span class="p">(</span><span class="n">flashes_test_white</span><span class="p">)</span>
<span class="n">flashes_train_black</span> <span class="o">=</span> <span class="n">extended_flashes_black</span><span class="o">.</span><span class="n">set_diff</span><span class="p">(</span><span class="n">flashes_test_black</span><span class="p">)</span>
<span class="c1"># Merge both stimuli types in a single interval set</span>
<span class="n">flashes_test</span> <span class="o">=</span> <span class="n">flashes_test_white</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">flashes_test_black</span><span class="p">)</span>
<span class="n">flashes_train</span> <span class="o">=</span> <span class="n">flashes_train_white</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">flashes_train_black</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/agent/workspace/rorse_ccn-software-sfn-2025_main/lib/python3.12/site-packages/pynapple/core/interval_set.py:708: UserWarning: metadata incompatible with union method. dropping metadata from result
  warnings.warn(
</pre></div>
</div>
</div>
</div>
</section>
<section id="fit-a-glm">
<span id="visual-glm"></span><h2>Fit a GLM<a class="headerlink" href="#fit-a-glm" title="Link to this heading">#</a></h2>
<div class="render-all">
<p>In this section, you will use nemos to build a GLM. There are a lot of scientific decisions to be made here, so we suggest starting simple and then adding complexity. Construct a design matrix with a single predictor, using a basis of your choice, then construct, fit, and score your model to a single neuron (remembering to either use your train/test or cross-validation to avoid overfitting). Then add regularization to your GLM. Then return to the beginning and add more predictors. Then fit all the neurons. Then evaluate what basis functions and parameters are best for your predictors. Then use the tricks we covered in <a class="reference internal" href="nemos_advanced.html#sklearn-feature-selection"><span class="std std-ref">the advanced nemos notebook</span></a> to evaluate whether which predictors are necessary for your model, which are the most important.</p>
<p>You don’t have to exactly follow those steps, but make sure you can go from beginning to end before getting too complex.</p>
<p>Good luck and we look forward to seeing what you come up with!</p>
</div>
<p>There are many ways to do this. We’ll show fitting a single neuron <code class="docutils literal notranslate"><span class="pre">GLM</span></code> to a variety of stimulus-derived predictors. You can also see <a class="reference external" href="https://alleninstitute.github.io/openscope_databook/higher-order/GLM_pynapple_nemos.html#adding-coupling-as-a-new-predictor">the original notebook</a> for a <code class="docutils literal notranslate"><span class="pre">PopulationGLM</span></code> that adds coupling.</p>
<section id="prepare-data">
<h3>Prepare data<a class="headerlink" href="#prepare-data" title="Link to this heading">#</a></h3>
<div class="render-all">
<ul class="simple">
<li><p>Create spike count data. (Hint: review the <a class="reference internal" href="current_injection.html#current-inj-basic"><span class="std std-ref">current injection notebook</span></a>.)</p></li>
</ul>
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bin_size</span> <span class="o">=</span> <span class="mf">.005</span>
<span class="n">units_counts</span> <span class="o">=</span> <span class="n">selected_units</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">bin_size</span><span class="p">,</span> <span class="n">ep</span><span class="o">=</span><span class="n">extended_flashes</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="construct-design-matrix">
<h3>Construct design matrix<a class="headerlink" href="#construct-design-matrix" title="Link to this heading">#</a></h3>
<div class="render-all">
<ul class="simple">
<li><p>Decide on feature(s).</p></li>
<li><p>Decide on basis. (Hint: review the <a class="reference internal" href="current_injection.html#current-inj-basis"><span class="std std-ref">current injection</span></a> or <a class="reference internal" href="nemos_advanced.html#sklearn-basis"><span class="std std-ref">place cell</span></a> notebooks.)</p></li>
<li><p>Construct design matrix. (Hint: review the <a class="reference internal" href="../day1/phase_precession.html#basis-eval-place-cells"><span class="std std-ref">place cell</span></a> notebook.)</p></li>
</ul>
<div class="hint dropdown admonition">
<p class="admonition-title">What features should I include?</p>
<p>If you’re having trouble coming up with features to include, here are some possibilities:</p>
<ul class="simple">
<li><p>Stimulus. (Review the <a class="reference internal" href="current_injection.html#current-inj-prep"><span class="std std-ref">current injection</span></a> notebook.)</p></li>
<li><p>Stimulus onset. (Hint: you can use <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.diff.html#numpy.diff" title="(in NumPy v2.3)"><code class="xref py py-func docutils literal notranslate"><span class="pre">numpy.diff()</span></code></a> to find when the stimulus transitions from off to on.)</p></li>
<li><p>Stimulus offset. (Hint: you can use <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.diff.html#numpy.diff" title="(in NumPy v2.3)"><code class="xref py py-func docutils literal notranslate"><span class="pre">numpy.diff()</span></code></a> to find when the stimulus transitions from on to off.)</p></li>
<li><p>For multiple neurons: neuron-to-neuron coupling. (Refer back to the <a class="reference internal" href="../day1/head_direction.html#head-direction-fit"><span class="std std-ref">the head direction notebook from the first day</span></a> to see an example of fitting coupling filters.)</p></li>
</ul>
<p>For the stimuli predictors, you probably want to model white and black separately.</p>
</div>
</div>
<p>Here we’ll model three separate components of the response:</p>
<ul class="simple">
<li><p>Flash onset (beginning): We will convolve the early phase of the flash presentation with a basis function. This allows for fine temporal resolution immediately after stimulus onset, where rapid neural responses are often expected.</p></li>
<li><p>Flash offset (end): We will convolve the later phase of the flash (around its end) with a different basis function. This emphasizes activity changes around stimulus termination.</p></li>
<li><p>Full flash duration (smoothing): We will convolve the entire flash period with a third basis function, serving as a smoother to capture more sustained or slowly varying effects across the full stimulus window.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a TsdFrame filled by zeros, for the size of units_counts</span>
<span class="n">stim</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">TsdFrame</span><span class="p">(</span>
    <span class="n">t</span><span class="o">=</span><span class="n">units_counts</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
    <span class="n">d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">units_counts</span><span class="p">),</span> <span class="mi">2</span><span class="p">)),</span> 
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">]</span>
<span class="p">)</span>
<span class="c1"># Check whether there is a flash within a given bin of spikes</span>
<span class="c1"># If there is not, put a nan in that index</span>
<span class="n">idx_white</span> <span class="o">=</span> <span class="n">flashes_white</span><span class="o">.</span><span class="n">in_interval</span><span class="p">(</span><span class="n">units_counts</span><span class="p">)</span>
<span class="n">idx_black</span> <span class="o">=</span> <span class="n">flashes_black</span><span class="o">.</span><span class="n">in_interval</span><span class="p">(</span><span class="n">units_counts</span><span class="p">)</span>

<span class="c1"># Replace everything that is not nan with 1 in the corresponding column</span>
<span class="n">stim</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">idx_white</span><span class="p">),</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">stim</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">idx_black</span><span class="p">),</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">white_onset</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">Tsd</span><span class="p">(</span>
    <span class="n">t</span><span class="o">=</span><span class="n">stim</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> 
    <span class="n">d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">stim</span><span class="p">[</span><span class="s2">&quot;white&quot;</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">)),</span>
    <span class="n">time_support</span> <span class="o">=</span> <span class="n">units_counts</span><span class="o">.</span><span class="n">time_support</span>
<span class="p">)</span>

<span class="n">white_offset</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">Tsd</span><span class="p">(</span>
    <span class="n">t</span><span class="o">=</span><span class="n">stim</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> 
    <span class="n">d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">stim</span><span class="p">[</span><span class="s2">&quot;white&quot;</span><span class="p">])</span><span class="o">==-</span><span class="mi">1</span><span class="p">)),</span>
    <span class="n">time_support</span> <span class="o">=</span> <span class="n">units_counts</span><span class="o">.</span><span class="n">time_support</span>
<span class="p">)</span>

<span class="n">black_onset</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">Tsd</span><span class="p">(</span>
    <span class="n">t</span><span class="o">=</span><span class="n">stim</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> 
    <span class="n">d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">stim</span><span class="p">[</span><span class="s2">&quot;black&quot;</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">)),</span>
    <span class="n">time_support</span> <span class="o">=</span> <span class="n">units_counts</span><span class="o">.</span><span class="n">time_support</span>
<span class="p">)</span>
<span class="n">black_offset</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">Tsd</span><span class="p">(</span>
    <span class="n">t</span><span class="o">=</span><span class="n">stim</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> 
    <span class="n">d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">stim</span><span class="p">[</span><span class="s2">&quot;black&quot;</span><span class="p">])</span><span class="o">==-</span><span class="mi">1</span><span class="p">)),</span>
    <span class="n">time_support</span> <span class="o">=</span> <span class="n">units_counts</span><span class="o">.</span><span class="n">time_support</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now set up the basis functions</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Duration of stimuli</span>
<span class="n">stimulus_history_duration</span> <span class="o">=</span> <span class="mf">0.250</span>

<span class="c1"># Window length in bin size units</span>
<span class="n">window_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stimulus_history_duration</span> <span class="o">/</span> <span class="n">bin_size</span><span class="p">)</span>

<span class="c1"># Initialize basis objects</span>
<span class="n">basis_white_on</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">RaisedCosineLogConv</span><span class="p">(</span>
    <span class="n">n_basis_funcs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
    <span class="n">window_size</span><span class="o">=</span><span class="n">window_len</span><span class="p">,</span> 
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;white_on&quot;</span>
<span class="p">)</span>
<span class="n">basis_white_off</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">RaisedCosineLinearConv</span><span class="p">(</span>
    <span class="n">n_basis_funcs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
    <span class="n">window_size</span><span class="o">=</span><span class="n">window_len</span><span class="p">,</span> 
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;white_off&quot;</span><span class="p">,</span>
    <span class="n">conv_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;predictor_causality&quot;</span><span class="p">:</span><span class="s2">&quot;acausal&quot;</span><span class="p">}</span>
<span class="p">)</span>
<span class="n">basis_white_stim</span><span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">RaisedCosineLogConv</span><span class="p">(</span>
    <span class="n">n_basis_funcs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
    <span class="n">window_size</span><span class="o">=</span><span class="n">window_len</span><span class="p">,</span> 
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;white_stim&quot;</span>
<span class="p">)</span>
<span class="n">basis_black_on</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">RaisedCosineLogConv</span><span class="p">(</span>
    <span class="n">n_basis_funcs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
    <span class="n">window_size</span><span class="o">=</span><span class="n">window_len</span><span class="p">,</span> 
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;black_on&quot;</span>
<span class="p">)</span>
<span class="n">basis_black_off</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">RaisedCosineLinearConv</span><span class="p">(</span>
    <span class="n">n_basis_funcs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
    <span class="n">window_size</span><span class="o">=</span><span class="n">window_len</span><span class="p">,</span> 
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;black_off&quot;</span><span class="p">,</span>
    <span class="n">conv_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;predictor_causality&quot;</span><span class="p">:</span><span class="s2">&quot;acausal&quot;</span><span class="p">}</span>
<span class="p">)</span>
<span class="n">basis_black_stim</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">basis</span><span class="o">.</span><span class="n">RaisedCosineLogConv</span><span class="p">(</span>
    <span class="n">n_basis_funcs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
    <span class="n">window_size</span><span class="o">=</span><span class="n">window_len</span><span class="p">,</span> 
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;black_stim&quot;</span>
<span class="p">)</span>

<span class="c1"># Define additive basis object to construct design matrix</span>
<span class="n">additive_basis</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">basis_white_on</span> <span class="o">+</span> 
    <span class="n">basis_white_off</span> <span class="o">+</span> 
    <span class="n">basis_white_stim</span> <span class="o">+</span> 
    <span class="n">basis_black_on</span> <span class="o">+</span> 
    <span class="n">basis_black_off</span> <span class="o">+</span> 
    <span class="n">basis_black_stim</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Construct design matrix, separately for test and train.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convolve basis with inputs - test set</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">additive_basis</span><span class="o">.</span><span class="n">compute_features</span><span class="p">(</span>
    <span class="n">white_onset</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">flashes_test</span><span class="p">),</span>
    <span class="n">white_offset</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">flashes_test</span><span class="p">),</span>
    <span class="n">stim</span><span class="p">[</span><span class="s2">&quot;white&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">flashes_test</span><span class="p">),</span>
    <span class="n">black_onset</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">flashes_test</span><span class="p">),</span>
    <span class="n">black_offset</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">flashes_test</span><span class="p">),</span>
    <span class="n">stim</span><span class="p">[</span><span class="s2">&quot;black&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">flashes_test</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Convolve basis with inputs - train set</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">additive_basis</span><span class="o">.</span><span class="n">compute_features</span><span class="p">(</span>
    <span class="n">white_onset</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">flashes_train</span><span class="p">),</span>
    <span class="n">white_offset</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">flashes_train</span><span class="p">),</span>
    <span class="n">stim</span><span class="p">[</span><span class="s2">&quot;white&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">flashes_train</span><span class="p">),</span>
    <span class="n">black_onset</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">flashes_train</span><span class="p">),</span>
    <span class="n">black_offset</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">flashes_train</span><span class="p">),</span>
    <span class="n">stim</span><span class="p">[</span><span class="s2">&quot;black&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">flashes_train</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/agent/workspace/rorse_ccn-software-sfn-2025_main/lib/python3.12/site-packages/nemos/convolve.py:416: UserWarning: With `acausal` filter, `basis_matrix.shape[0] should probably be odd, so that we can place an equal number of NaNs on either side of input.
  warnings.warn(
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/agent/workspace/rorse_ccn-software-sfn-2025_main/lib/python3.12/site-packages/nemos/convolve.py:416: UserWarning: With `acausal` filter, `basis_matrix.shape[0] should probably be odd, so that we can place an equal number of NaNs on either side of input.
  warnings.warn(
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/agent/workspace/rorse_ccn-software-sfn-2025_main/lib/python3.12/site-packages/nemos/convolve.py:416: UserWarning: With `acausal` filter, `basis_matrix.shape[0] should probably be odd, so that we can place an equal number of NaNs on either side of input.
  warnings.warn(
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/agent/workspace/rorse_ccn-software-sfn-2025_main/lib/python3.12/site-packages/nemos/convolve.py:416: UserWarning: With `acausal` filter, `basis_matrix.shape[0] should probably be odd, so that we can place an equal number of NaNs on either side of input.
  warnings.warn(
</pre></div>
</div>
</div>
</div>
</section>
<section id="construct-and-fit-your-model">
<h3>Construct and fit your model<a class="headerlink" href="#construct-and-fit-your-model" title="Link to this heading">#</a></h3>
<div class="render-all">
<ul class="simple">
<li><p>Decide on regularization. (Hint: review Edoardo’s presentation and the <a class="reference internal" href="nemos_advanced.html#sklearn-cv"><span class="std std-ref">place cell</span></a> notebook.)</p></li>
<li><p>Initialize GLM. (Hint: review the <a class="reference internal" href="current_injection.html#current-inj-glm"><span class="std std-ref">current injection</span></a> or <a class="reference internal" href="nemos_advanced.html#sklearn-cv"><span class="std std-ref">place cell</span></a> notebooks.)</p></li>
<li><p>Call fit. (Hint: review the <a class="reference internal" href="current_injection.html#current-inj-glm"><span class="std std-ref">current injection</span></a> or <a class="reference internal" href="nemos_advanced.html#sklearn-cv"><span class="std std-ref">place cell</span></a> notebooks.)</p></li>
<li><p>Visualize result on PSTHs. (Note that you should use <a class="reference external" href="https://pynapple.org/generated/pynapple.process.perievent.html#pynapple.process.perievent.compute_perievent_continuous" title="(in pynapple v0.10.0)"><code class="xref py py-func docutils literal notranslate"><span class="pre">compute_perievent_continuous()</span></code></a> and the model predictions here! Otherwise, this looks very similar to our PSTH calculation above.)</p></li>
</ul>
</div>
<p>Here’s an example of how this could look for a single neuron. To do multiple neurons, <code class="docutils literal notranslate"><span class="pre">model</span></code> should be a <code class="docutils literal notranslate"><span class="pre">PopulationGLM</span></code> and fit to <code class="docutils literal notranslate"><span class="pre">units_counts.restrict(flashes_train)</span></code> instead.</p>
<p>(The following regularizer strength comes from cross-validation.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">regularizer_strength</span> <span class="o">=</span> <span class="mf">7.745e-06</span>
<span class="c1"># Initialize model object of a single unit</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">.</span><span class="n">glm</span><span class="o">.</span><span class="n">GLM</span><span class="p">(</span>
    <span class="n">regularizer</span><span class="o">=</span><span class="s2">&quot;Ridge&quot;</span><span class="p">,</span>
    <span class="n">regularizer_strength</span><span class="o">=</span><span class="n">regularizer_strength</span><span class="p">,</span>
    <span class="n">solver_name</span><span class="o">=</span><span class="s2">&quot;LBFGS&quot;</span><span class="p">,</span> 
<span class="p">)</span>
<span class="c1"># Choose an example unit</span>
<span class="n">unit_id</span> <span class="o">=</span> <span class="mi">951768318</span>

<span class="c1"># Get counts for train and test for said unit</span>
<span class="n">u_counts</span> <span class="o">=</span> <span class="n">units_counts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">u_counts</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">flashes_train</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>#sk-container-id-1 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: #000;
  --sklearn-color-text-muted: #666;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-1 {
  color: var(--sklearn-color-text);
}

#sk-container-id-1 pre {
  padding: 0;
}

#sk-container-id-1 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-1 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-1 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-1 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-1 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-1 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-1 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-1 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-1 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-1 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-1 label.sk-toggleable__label {
  cursor: pointer;
  display: flex;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
  align-items: start;
  justify-content: space-between;
  gap: 0.5em;
}

#sk-container-id-1 label.sk-toggleable__label .caption {
  font-size: 0.6rem;
  font-weight: lighter;
  color: var(--sklearn-color-text-muted);
}

#sk-container-id-1 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-1 div.sk-toggleable__content {
  display: none;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  display: block;
  width: 100%;
  overflow: visible;
}

#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-1 div.sk-label label.sk-toggleable__label,
#sk-container-id-1 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-1 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-1 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-1 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-1 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-1 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 0.5em;
  text-align: center;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-1 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-1 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-1 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-1 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}

.estimator-table summary {
    padding: .5rem;
    font-family: monospace;
    cursor: pointer;
}

.estimator-table details[open] {
    padding-left: 0.1rem;
    padding-right: 0.1rem;
    padding-bottom: 0.3rem;
}

.estimator-table .parameters-table {
    margin-left: auto !important;
    margin-right: auto !important;
}

.estimator-table .parameters-table tr:nth-child(odd) {
    background-color: #fff;
}

.estimator-table .parameters-table tr:nth-child(even) {
    background-color: #f6f6f6;
}

.estimator-table .parameters-table tr:hover {
    background-color: #e0e0e0;
}

.estimator-table table td {
    border: 1px solid rgba(106, 105, 104, 0.232);
}

.user-set td {
    color:rgb(255, 94, 0);
    text-align: left;
}

.user-set td.value pre {
    color:rgb(255, 94, 0) !important;
    background-color: transparent !important;
}

.default td {
    color: black;
    text-align: left;
}

.user-set td i,
.default td i {
    color: black;
}

.copy-paste-icon {
    background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0NDggNTEyIj48IS0tIUZvbnQgQXdlc29tZSBGcmVlIDYuNy4yIGJ5IEBmb250YXdlc29tZSAtIGh0dHBzOi8vZm9udGF3ZXNvbWUuY29tIExpY2Vuc2UgLSBodHRwczovL2ZvbnRhd2Vzb21lLmNvbS9saWNlbnNlL2ZyZWUgQ29weXJpZ2h0IDIwMjUgRm9udGljb25zLCBJbmMuLS0+PHBhdGggZD0iTTIwOCAwTDMzMi4xIDBjMTIuNyAwIDI0LjkgNS4xIDMzLjkgMTQuMWw2Ny45IDY3LjljOSA5IDE0LjEgMjEuMiAxNC4xIDMzLjlMNDQ4IDMzNmMwIDI2LjUtMjEuNSA0OC00OCA0OGwtMTkyIDBjLTI2LjUgMC00OC0yMS41LTQ4LTQ4bDAtMjg4YzAtMjYuNSAyMS41LTQ4IDQ4LTQ4ek00OCAxMjhsODAgMCAwIDY0LTY0IDAgMCAyNTYgMTkyIDAgMC0zMiA2NCAwIDAgNDhjMCAyNi41LTIxLjUgNDgtNDggNDhMNDggNTEyYy0yNi41IDAtNDgtMjEuNS00OC00OEwwIDE3NmMwLTI2LjUgMjEuNS00OCA0OC00OHoiLz48L3N2Zz4=);
    background-repeat: no-repeat;
    background-size: 14px 14px;
    background-position: 0;
    display: inline-block;
    width: 14px;
    height: 14px;
    cursor: pointer;
}
</style><body><div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>GLM(
    observation_model=PoissonObservations(),
    inverse_link_function=exp,
    regularizer=Ridge(),
    regularizer_strength=7.745e-06,
    solver_name=&#x27;LBFGS&#x27;
)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox" checked><label for="sk-estimator-id-1" class="sk-toggleable__label fitted sk-toggleable__label-arrow"><div><div>GLM</div></div><div><span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></div></label><div class="sk-toggleable__content fitted" data-param-prefix="">
        <div class="estimator-table">
            <details>
                <summary>Parameters</summary>
                <table class="parameters-table">
                  <tbody>
                    
        <tr class="user-set">
            <td><i class="copy-paste-icon"
                 onclick="copyToClipboard('observation_model',
                          this.parentElement.nextElementSibling)"
            ></i></td>
            <td class="param">observation_model&nbsp;</td>
            <td class="value">PoissonObservations()</td>
        </tr>
    

        <tr class="user-set">
            <td><i class="copy-paste-icon"
                 onclick="copyToClipboard('inverse_link_function',
                          this.parentElement.nextElementSibling)"
            ></i></td>
            <td class="param">inverse_link_function&nbsp;</td>
            <td class="value">&lt;PjitFunction...7f90fca3e700&gt;&gt;</td>
        </tr>
    

        <tr class="user-set">
            <td><i class="copy-paste-icon"
                 onclick="copyToClipboard('regularizer',
                          this.parentElement.nextElementSibling)"
            ></i></td>
            <td class="param">regularizer&nbsp;</td>
            <td class="value">Ridge()</td>
        </tr>
    

        <tr class="user-set">
            <td><i class="copy-paste-icon"
                 onclick="copyToClipboard('regularizer_strength',
                          this.parentElement.nextElementSibling)"
            ></i></td>
            <td class="param">regularizer_strength&nbsp;</td>
            <td class="value">7.745e-06</td>
        </tr>
    

        <tr class="user-set">
            <td><i class="copy-paste-icon"
                 onclick="copyToClipboard('solver_name',
                          this.parentElement.nextElementSibling)"
            ></i></td>
            <td class="param">solver_name&nbsp;</td>
            <td class="value">&#x27;LBFGS&#x27;</td>
        </tr>
    

        <tr class="user-set">
            <td><i class="copy-paste-icon"
                 onclick="copyToClipboard('solver_kwargs',
                          this.parentElement.nextElementSibling)"
            ></i></td>
            <td class="param">solver_kwargs&nbsp;</td>
            <td class="value">{}</td>
        </tr>
    
                  </tbody>
                </table>
            </details>
        </div>
    </div></div></div></div></div><script>function copyToClipboard(text, element) {
    // Get the parameter prefix from the closest toggleable content
    const toggleableContent = element.closest('.sk-toggleable__content');
    const paramPrefix = toggleableContent ? toggleableContent.dataset.paramPrefix : '';
    const fullParamName = paramPrefix ? `${paramPrefix}${text}` : text;

    const originalStyle = element.style;
    const computedStyle = window.getComputedStyle(element);
    const originalWidth = computedStyle.width;
    const originalHTML = element.innerHTML.replace('Copied!', '');

    navigator.clipboard.writeText(fullParamName)
        .then(() => {
            element.style.width = originalWidth;
            element.style.color = 'green';
            element.innerHTML = "Copied!";

            setTimeout(() => {
                element.innerHTML = originalHTML;
                element.style = originalStyle;
            }, 2000);
        })
        .catch(err => {
            console.error('Failed to copy:', err);
            element.style.color = 'red';
            element.innerHTML = "Failed!";
            setTimeout(() => {
                element.innerHTML = originalHTML;
                element.style = originalStyle;
            }, 2000);
        });
    return false;
}

document.querySelectorAll('.fa-regular.fa-copy').forEach(function(element) {
    const toggleableContent = element.closest('.sk-toggleable__content');
    const paramPrefix = toggleableContent ? toggleableContent.dataset.paramPrefix : '';
    const paramName = element.parentElement.nextElementSibling.textContent.trim();
    const fullParamName = paramPrefix ? `${paramPrefix}${paramName}` : paramName;

    element.setAttribute('title', fullParamName);
});
</script></body></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use predict to obtain the firing rates</span>
<span class="n">pred_unit</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Convert units from spikes/bin to spikes/sec</span>
<span class="n">pred_unit</span> <span class="o">=</span> <span class="n">pred_unit</span><span class="o">/</span> <span class="n">bin_size</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Re-center timestamps around white stimuli</span>
<span class="c1"># +50 because we subtracted .50 at beginning of stimulus presentation</span>
<span class="n">peri_white_pred_unit</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">compute_perievent_continuous</span><span class="p">(</span>
    <span class="n">timeseries</span><span class="o">=</span><span class="n">pred_unit</span><span class="p">,</span> 
    <span class="n">tref</span><span class="o">=</span><span class="n">nap</span><span class="o">.</span><span class="n">Ts</span><span class="p">(</span><span class="n">flashes_test_white</span><span class="o">.</span><span class="n">start</span><span class="o">+</span><span class="mf">.50</span><span class="p">),</span>
    <span class="n">minmax</span><span class="o">=</span><span class="n">window_size</span>
<span class="p">)</span>  
<span class="c1"># Re-center timestamps for black stimuli</span>
<span class="c1"># +50 because we subtracted .50 at beginning of stimulus presentation</span>
<span class="n">peri_black_pred_unit</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">compute_perievent_continuous</span><span class="p">(</span>
    <span class="n">timeseries</span><span class="o">=</span><span class="n">pred_unit</span><span class="p">,</span> 
    <span class="n">tref</span><span class="o">=</span><span class="n">nap</span><span class="o">.</span><span class="n">Ts</span><span class="p">(</span><span class="n">flashes_test_black</span><span class="o">.</span><span class="n">start</span><span class="o">+</span><span class="mf">.50</span><span class="p">),</span> 
    <span class="n">minmax</span><span class="o">=</span><span class="n">window_size</span>
<span class="p">)</span>  
</pre></div>
</div>
</div>
</div>
<div class="render-all">
<p>Here’s a helper function for plotting the PSTH of the data and predictions (for one or multiple neurons), which you may find helpful for visualizing your model performance.</p>
</div><div class="cell tag_render-all tag_hide-input docutils container">
<details class="admonition hide above-input">
<summary aria-label="Toggle hidden content">
<p class="collapsed admonition-title">Show code cell source</p>
<p class="expanded admonition-title">Hide code cell source</p>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_pop_psth</span><span class="p">(</span>
        <span class="n">peri</span><span class="p">,</span>
        <span class="n">color_flashes</span><span class="p">,</span>
        <span class="n">bin_size</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span>
        <span class="n">smoothing</span><span class="o">=</span><span class="mf">0.015</span><span class="p">,</span>
        <span class="o">**</span><span class="n">peri_others</span>
        <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot perievent time histograms (PSTHs) and raster plots for multiple units.</span>

<span class="sd">    Model predictions should be passed as additional keyword arguments. The key will be</span>
<span class="sd">    used as the label, and the value should be a 2-tuple of `(style, peri)`, where</span>
<span class="sd">    `style` is a matplotlib style (e.g., &quot;blue&quot; or &quot;--&quot;) and `peri` is a PSTH</span>
<span class="sd">    dictionary, as returned by `compute_perievent_continuous`.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    peri : dict or TsGroup</span>
<span class="sd">        Dictionary mapping unit names to binned spike count peri-stimulus data (e.g., binned time series).</span>
<span class="sd">    color_flashes : str</span>
<span class="sd">        A label indicating the flash color condition (&#39;black&#39; or other), used for visual styling.</span>
<span class="sd">    bin_size : float</span>
<span class="sd">        Size of the bin used for spike count computation (in seconds).</span>
<span class="sd">    smoothing : float</span>
<span class="sd">        Standard deviation for Gaussian smoothing of the PSTH traces.</span>
<span class="sd">    peri_others : tuple</span>
<span class="sd">        Model PSTHs to plot. See above for description</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">peri</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">peri</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">peri</span><span class="p">}</span>
        
    <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">peri</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span>
                             <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">n_cols</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">n_cols</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">peri</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c1"># then there&#39;s only set of axes</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span>
        <span class="c1"># Plot PSTH (smoothed firing rate)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">bin_size</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">bin_size</span><span class="p">)</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">std</span><span class="o">=</span><span class="n">smoothing</span><span class="p">),</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Observed&quot;</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># Stimulus onset line</span>
        <span class="n">span_color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span> <span class="k">if</span> <span class="n">color_flashes</span> <span class="o">==</span> <span class="s2">&quot;black&quot;</span> <span class="k">else</span> <span class="s2">&quot;silver&quot;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.250</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">span_color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>  <span class="c1"># Stim duration</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">peri_pred</span><span class="p">))</span> <span class="ow">in</span> <span class="n">peri_others</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">peri_pred</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">peri_pred</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">key</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
            <span class="p">)</span>

    <span class="c1"># Y-axis and title annotations</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Rate (Hz)&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="o">*</span><span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">())</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.00</span><span class="p">,</span> <span class="s1">&#39;Time from stim(s)&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;PSTH - </span><span class="si">{</span><span class="n">color_flashes</span><span class="si">}</span><span class="s1"> flashes&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="render-all">
<p>The following cell shows you how to call this visualization function. Its arguments are:</p>
<ul class="simple">
<li><p>The PSTH object computed from the data. This should only contain the responses to either the black or white flashes, but can contain the PSTHs from one or more-than-one neurons.</p></li>
<li><p>A string, either <code class="docutils literal notranslate"><span class="pre">&quot;white&quot;</span></code> or <code class="docutils literal notranslate"><span class="pre">&quot;black&quot;</span></code>, which determines some of the styling.</p></li>
<li><p>Any number of keyword arguments (e.g., <code class="docutils literal notranslate"><span class="pre">predictions=</span></code> shown below) whose values are a tuple of <code class="docutils literal notranslate"><span class="pre">(style,</span> <span class="pre">peri)</span></code>, where <code class="docutils literal notranslate"><span class="pre">style</span></code> is a valid matplotlib style (e.g., <code class="docutils literal notranslate"><span class="pre">&quot;red&quot;</span></code>) and <code class="docutils literal notranslate"><span class="pre">peri</span></code> is additional PSTHs to plot. Expected use is, as below, to plot the predictions in a different color on top of the actual data.</p></li>
</ul>
</div><div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_pop_psth</span><span class="p">(</span><span class="n">peri_white</span><span class="p">[</span><span class="n">unit_id</span><span class="p">],</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">predictions</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">peri_white_pred_unit</span><span class="p">))</span>
<span class="n">plot_pop_psth</span><span class="p">(</span><span class="n">peri_black</span><span class="p">[</span><span class="n">unit_id</span><span class="p">],</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">predictions</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">peri_black_pred_unit</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/efea9ceb392a798fc3ec6e9201ece5bd375cdc705e30f83ad2b1bd6bb95e0e1a.png" src="../../_images/efea9ceb392a798fc3ec6e9201ece5bd375cdc705e30f83ad2b1bd6bb95e0e1a.png" />
<img alt="../../_images/4ae2ba24f0918b0dbb0c111409f2c82dec43daf914c485806c70971d424107ee.png" src="../../_images/4ae2ba24f0918b0dbb0c111409f2c82dec43daf914c485806c70971d424107ee.png" />
</div>
</div>
</section>
<section id="score-your-model">
<h3>Score your model<a class="headerlink" href="#score-your-model" title="Link to this heading">#</a></h3>
<div class="render-all">
<ul class="simple">
<li><p>We trained on the train set, so now we score on the test set. (Or use cross-validation.)</p></li>
<li><p>Get a score for your model that you can use to compare across the modeling choices outlined above. (Hint: refer back to the <a class="reference internal" href="current_injection.html#current-inj-score"><span class="std std-ref">current injection</span></a> or <a class="reference internal" href="nemos_advanced.html#sklearn-cv"><span class="std std-ref">place cell</span></a> notebook.)</p></li>
</ul>
</div><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the mean score for the Stimuli + Coupling model</span>
<span class="c1"># using pseudo-r2-McFadden</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span>
    <span class="n">X_test</span><span class="p">,</span>
    <span class="n">u_counts</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">flashes_test</span><span class="p">),</span>
    <span class="n">score_type</span><span class="o">=</span><span class="s2">&quot;pseudo-r2-McFadden&quot;</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.141631
</pre></div>
</div>
</div>
</div>
</section>
<section id="try-to-improve-your-model">
<h3>Try to improve your model?<a class="headerlink" href="#try-to-improve-your-model" title="Link to this heading">#</a></h3>
<div class="render-all">
<ul class="simple">
<li><p>Go back to the beginning of <a class="reference internal" href="#visual-glm"><span class="std std-ref">this section</span></a> and try to improve your model’s performance (as reflected by increased score).</p></li>
<li><p>Keep track of what you’ve tried and their respective scores.</p>
<ul>
<li><p>You can do this by hand, but constructing a <a class="reference external" href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.html">pandas DataFrame</a>, as we’ve seen in the <a class="reference internal" href="nemos_advanced.html#sklearn-cv"><span class="std std-ref">advanced nemos notebook</span></a>, is useful:</p></li>
</ul>
</li>
</ul>
</div><div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example construction of dataframe.</span>
<span class="c1"># In this:</span>
<span class="c1"># - additive_basis is the single AdditiveBasis object we used to construct the entire design matrix</span>
<span class="c1"># - model is the GLM we fit to a single neuron</span>
<span class="c1"># - unit_id is the int identifying the neuron we&#39;re fitting</span>
<span class="c1"># - score is the float giving the model score, summarizing model performance (on the test set)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;model_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;regularizer&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">regularizer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="s2">&quot;regularizer_strength&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">regularizer_strength</span><span class="p">,</span>
        <span class="s2">&quot;solver&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">solver_name</span><span class="p">,</span>
        <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span>
        <span class="s2">&quot;n_predictors&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">additive_basis</span><span class="p">),</span>
        <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="n">unit_id</span><span class="p">,</span>
        <span class="s2">&quot;predictor_i&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
        <span class="s2">&quot;predictor&quot;</span><span class="p">:</span> <span class="n">basis</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
        <span class="s2">&quot;basis&quot;</span><span class="p">:</span> <span class="n">basis</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="c1"># any other info you think is important ...</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">basis</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">additive_basis</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>model_id</th>
      <th>regularizer</th>
      <th>regularizer_strength</th>
      <th>solver</th>
      <th>score</th>
      <th>n_predictors</th>
      <th>unit</th>
      <th>predictor_i</th>
      <th>predictor</th>
      <th>basis</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>Ridge</td>
      <td>0.000008</td>
      <td>LBFGS</td>
      <td>0.141631</td>
      <td>6</td>
      <td>951768318</td>
      <td>0</td>
      <td>white_on</td>
      <td>RaisedCosineLogConv</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>Ridge</td>
      <td>0.000008</td>
      <td>LBFGS</td>
      <td>0.141631</td>
      <td>6</td>
      <td>951768318</td>
      <td>1</td>
      <td>white_off</td>
      <td>RaisedCosineLinearConv</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>Ridge</td>
      <td>0.000008</td>
      <td>LBFGS</td>
      <td>0.141631</td>
      <td>6</td>
      <td>951768318</td>
      <td>2</td>
      <td>white_stim</td>
      <td>RaisedCosineLogConv</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>Ridge</td>
      <td>0.000008</td>
      <td>LBFGS</td>
      <td>0.141631</td>
      <td>6</td>
      <td>951768318</td>
      <td>3</td>
      <td>black_on</td>
      <td>RaisedCosineLogConv</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>Ridge</td>
      <td>0.000008</td>
      <td>LBFGS</td>
      <td>0.141631</td>
      <td>6</td>
      <td>951768318</td>
      <td>4</td>
      <td>black_off</td>
      <td>RaisedCosineLinearConv</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0</td>
      <td>Ridge</td>
      <td>0.000008</td>
      <td>LBFGS</td>
      <td>0.141631</td>
      <td>6</td>
      <td>951768318</td>
      <td>5</td>
      <td>black_stim</td>
      <td>RaisedCosineLogConv</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="nemos_advanced.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">NeMoS Advanced: Cross-Validation and Model Selection</p>
      </div>
    </a>
    <a class="right-next"
       href="../../users/index.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">For users (some code, some text)</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#downloading-and-preparing-data">Downloading and preparing data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preliminary-analyses-and-neuron-selection">Preliminary analyses and neuron selection</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#avoiding-overfitting">Avoiding overfitting</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fit-a-glm">Fit a GLM</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prepare-data">Prepare data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#construct-design-matrix">Construct design matrix</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#construct-and-fit-your-model">Construct and fit your model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#score-your-model">Score your model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#try-to-improve-your-model">Try to improve your model?</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Edoardo Balzani, Billy Broderick, Sarah Jo Venditto, Guillaume Viejo
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025, Edoardo Balzani, Billy Broderick, Sarah Jo Venditto, Guillaume Viejo.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>