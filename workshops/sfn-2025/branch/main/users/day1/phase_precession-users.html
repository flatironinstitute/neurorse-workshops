
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Signal processing and decoding in pynapple &#8212; CCN software workshop, SfN 2025  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=f4437bd1" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'users/day1/phase_precession-users';</script>
    <link rel="icon" href="../../_static/ccn_small.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Introduction to GLM" href="../day2/current_injection-users.html" />
    <link rel="prev" title="Data analysis with pynapple &amp; nemos" href="head_direction-users.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/01-FI-primary-logo-color.png" class="logo__image only-light" alt="Home"/>
    <script>document.write(`<img src="../../_static/03-FI-primary-logo-white.png" class="logo__image only-dark" alt="Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/flatironinstitute/ccn-software-sfn-2025" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://flatironinstitute.github.io/neurorse-workshops/" title="Workshops home" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-house fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Workshops home</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://binder.flatironinstitute.org/v2/user/wbroderick/sfn2025?labpath=notebooks/" title="Binder" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="https://mybinder.org/badge_logo.svg" class="icon-link-image" alt="Binder"/></a>
        </li>
</ul></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    Welcome!
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Full notebooks</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../full/day1/fundamentals_of_pynapple.html">Learning the fundamentals of pynapple</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../full/day1/head_direction.html">Data analysis with pynapple &amp; nemos</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../full/day1/phase_precession.html">Signal processing and decoding in pynapple</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../full/day2/current_injection.html">Introduction to GLM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../full/day2/place_cells.html">Model selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../full/day2/visual_coding.html">Exploring the Visual Coding Dataset</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Limited notebooks</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../index.html">For users (some code, some text)</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="fundamentals_of_pynapple-users.html">Learning the fundamentals of pynapple</a></li>
<li class="toctree-l2"><a class="reference internal" href="head_direction-users.html">Data analysis with pynapple &amp; nemos</a></li>

<li class="toctree-l2 current active"><a class="current reference internal" href="#">Signal processing and decoding in pynapple</a></li>
<li class="toctree-l2"><a class="reference internal" href="../day2/current_injection-users.html">Introduction to GLM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../day2/place_cells-users.html">Model selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../day2/visual_coding-users.html">Exploring the Visual Coding Dataset</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../presenters/index.html">For presenter reference (all code, no text)</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../presenters/day1/fundamentals_of_pynapple-presenters.html">Learning the fundamentals of pynapple</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presenters/day1/head_direction-presenters.html">Data analysis with pynapple &amp; nemos</a></li>

<li class="toctree-l2"><a class="reference internal" href="../../presenters/day1/phase_precession-presenters.html">Signal processing and decoding in pynapple</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presenters/day2/current_injection-presenters.html">Introduction to GLM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presenters/day2/place_cells-presenters.html">Model selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../presenters/day2/visual_coding-presenters.html">Exploring the Visual Coding Dataset</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/flatironinstitute/ccn-software-sfn-2025" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/users/day1/phase_precession-users.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Signal processing and decoding in pynapple</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#identifying-phase-precession-and-hippocampal-sequences">Identifying phase precession and hippocampal sequences</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#objectives">Objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fetching-the-data">Fetching the data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#units">units</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rem-nrem-and-forward-ep">rem, nrem, and forward_ep</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#eeg">eeg</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#position">position</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#restricting-the-data">Restricting the data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-the-lfp-and-animal-position">Plotting the LFP and animal position</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-the-wavelet-decomposition">Getting the Wavelet Decomposition</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-additional-signal-processing-methods">Bonus: Additional signal processing methods</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#filtering-for-theta">Filtering for theta</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-theta-phase">Computing theta phase</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-1d-tuning-curves-place-fields">Computing 1D tuning curves: place fields</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-phase-precession-within-a-single-unit">Visualizing phase precession within a single unit</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-2d-tuning-curves-position-vs-phase">Computing 2D tuning curves: position vs. phase</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decoding-position-from-spiking-activity">Decoding position from spiking activity</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#aside-cross-validation">ASIDE: Cross-validation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-1d-decoder">Run 1D decoder</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#smooth-spike-counts">Smooth spike counts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decoding-theta-sequences">Decoding theta sequences</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="signal-processing-and-decoding-in-pynapple">
<h1>Signal processing and decoding in pynapple<a class="headerlink" href="#signal-processing-and-decoding-in-pynapple" title="Link to this heading">#</a></h1>
<p>This notebook has had all its explanatory text removed and has not been run.
It is intended to be downloaded and run locally (or on the provided binder)
while listening to the presenter’s explanation. In order to see the fully
rendered of this notebook, go <a class="reference internal" href="../../full/day1/phase_precession.html"><span class="std std-doc">here</span></a></p>
<section id="identifying-phase-precession-and-hippocampal-sequences">
<h2>Identifying phase precession and hippocampal sequences<a class="headerlink" href="#identifying-phase-precession-and-hippocampal-sequences" title="Link to this heading">#</a></h2>
<p>In this tutorial we will learn how to use more advanced applications of pynapple: signal processing and decoding. We’ll apply these methods to demonstrate and visualize some well-known physiological properties of hippocampal activity, specifically phase presession of place cells and sequential coordination of place cell activity during theta oscillations.</p>
</section>
<section id="objectives">
<h2>Objectives<a class="headerlink" href="#objectives" title="Link to this heading">#</a></h2>
<p>We can break our goals of identifying phase presession and coordinated activity of place cells into the following objectives:</p>
<ol class="arabic simple">
<li><p>Get a feel for the data set</p>
<ul class="simple">
<li><p>Load in and visualize the data</p></li>
<li><p>Restrict the data to regions of interest</p></li>
</ul>
</li>
<li><p>Identify and extract theta oscillations in the LFP</p>
<ul class="simple">
<li><p>Decompose the LFP into frequency components to identify theta oscillations</p></li>
<li><p>Filter the LFP to isolate the theta frequency band</p></li>
</ul>
</li>
<li><p>Identify place cells</p>
<ul class="simple">
<li><p>Calculate 1D tuning curves to identify place selectivity across many units</p></li>
</ul>
</li>
<li><p>Visualize phase precession</p>
<ul class="simple">
<li><p>Compare spike location to spike phase in a single unit</p></li>
<li><p>Calculate 2D tuning curves to identify place vs phase selectivity across many units</p></li>
</ul>
</li>
<li><p>Reconstruct spatial sequences from population activity</p>
<ul class="simple">
<li><p>Apply Bayesian decoding to predict position from spiking activity</p></li>
<li><p>Decode at a fast time-scale to identify spatial “sweeps” coordinated with theta oscillations</p></li>
</ul>
</li>
</ol>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># suppress warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="c1"># imports</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">signal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tqdm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pynapple</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nap</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">workshop_utils</span>

<span class="c1"># necessary for animation</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">nemos</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nmo</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">nmo</span><span class="o">.</span><span class="n">styles</span><span class="o">.</span><span class="n">plot_style</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fetching-the-data">
<h2>Fetching the data<a class="headerlink" href="#fetching-the-data" title="Link to this heading">#</a></h2>
<p>First we’ll fetch the relevant data set for this exercise.</p>
<ul class="simple">
<li><p>Manuscript: <a class="reference external" href="https://www.science.org/doi/10.1126/science.aad1935">Diversity in neural firing dynamics supports both rigid and learned hippocampal sequences</a></p></li>
<li><p>Full data source: <a class="reference external" href="https://dandiarchive.org/dandiset/000044/0.210812.1516">DANDI</a></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># fetch file path</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">workshop_utils</span><span class="o">.</span><span class="n">fetch_data</span><span class="p">(</span><span class="s2">&quot;Achilles_10252013_EEG.nwb&quot;</span><span class="p">)</span>
<span class="c1"># load data with pynapple</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="note render-all admonition">
<p class="admonition-title">Note</p>
<p>We will ignore the object <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code> because we will be computing this ourselves later on in the exercise.</p>
</div>
<section id="units">
<h3>units<a class="headerlink" href="#units" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">units</span></code> field is a <code class="docutils literal notranslate"><span class="pre">TsGroup</span></code>: a collection of <code class="docutils literal notranslate"><span class="pre">Ts</span></code> objects containing the spike times of each unit, where the “Index” is the unit number or key. Each unit has the following metadata:</p>
<ul class="simple">
<li><p><strong>rate</strong>: computed by pynapple, is the average firing rate of the neuron across all recorded time points.</p></li>
<li><p><strong>location</strong>, <strong>shank</strong>, and <strong>cell_type</strong>: variables saved and imported from the original data set.</p></li>
</ul>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We can access the spike times of a single unit by indexing the <code class="docutils literal notranslate"><span class="pre">TsGroup</span></code> by its unit number. For example, to access the spike times of unit 1:</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="rem-nrem-and-forward-ep">
<h3>rem, nrem, and forward_ep<a class="headerlink" href="#rem-nrem-and-forward-ep" title="Link to this heading">#</a></h3>
<p>The next three objects; <code class="docutils literal notranslate"><span class="pre">rem</span></code>, <code class="docutils literal notranslate"><span class="pre">nrem</span></code>, and <code class="docutils literal notranslate"><span class="pre">forward_ep</span></code>; are all IntervalSets containing time windows of REM sleep, nREM sleep, and forward runs down the linear maze, respectively.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rem&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;nrem&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;forward_ep&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>The following plot demonstrates how each of these labelled epochs are organized across the session.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">t_start</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;nrem&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sp1</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">((</span><span class="n">iset</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">t_start</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="p">(</span><span class="n">iset</span><span class="o">.</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">t_start</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> <span class="k">for</span> <span class="n">iset</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;rem&quot;</span><span class="p">]];</span>
<span class="n">sp2</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">((</span><span class="n">iset</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">t_start</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="p">(</span><span class="n">iset</span><span class="o">.</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">t_start</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> <span class="k">for</span> <span class="n">iset</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;nrem&quot;</span><span class="p">]];</span>
<span class="n">sp3</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">((</span><span class="n">iset</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">t_start</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="p">(</span><span class="n">iset</span><span class="o">.</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">t_start</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> <span class="k">for</span> <span class="n">iset</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;forward_ep&quot;</span><span class="p">]];</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Time within session (minutes)&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Labelled time intervals across session&quot;</span><span class="p">,</span> <span class="n">yticks</span><span class="o">=</span><span class="p">[])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">sp1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">sp2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">sp3</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="s2">&quot;REM sleep&quot;</span><span class="p">,</span><span class="s2">&quot;nREM sleep&quot;</span><span class="p">,</span><span class="s2">&quot;forward runs&quot;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="eeg">
<h3>eeg<a class="headerlink" href="#eeg" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">eeg</span></code> object is a <code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code> containing an LFP voltage trace for a single representative channel in CA1.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;eeg&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Despite having a single column, this <code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code> is still a 2D object. We can represent this as a 1D <code class="docutils literal notranslate"><span class="pre">Tsd</span></code> by indexing into the first column.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;eeg&quot;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="position">
<h3>position<a class="headerlink" href="#position" title="Link to this heading">#</a></h3>
<p>The final object, <code class="docutils literal notranslate"><span class="pre">position</span></code>, is a <code class="docutils literal notranslate"><span class="pre">Tsd</span></code> containing the linearized position of the animal, in centimeters, recorded during the exploration window.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Positions that are not defined, i.e. when the animal is at rest, are filled with <code class="docutils literal notranslate"><span class="pre">NaN</span></code>.</p>
<p>This object additionally contains a <code class="docutils literal notranslate"><span class="pre">time_support</span></code> attribute, which gives the time interval during which positions are recorded (including points recorded as <code class="docutils literal notranslate"><span class="pre">NaN</span></code>).</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">time_support</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s visualize the first 300 seconds of position data and overlay <code class="docutils literal notranslate"><span class="pre">forward_ep</span></code> intervals.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pos_start</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">time_support</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">l1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">])</span>
<span class="n">l2</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">iset</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">iset</span><span class="o">.</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> <span class="k">for</span> <span class="n">iset</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;forward_ep&quot;</span><span class="p">]];</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="n">pos_start</span><span class="p">,</span><span class="n">pos_start</span><span class="o">+</span><span class="mi">300</span><span class="p">],</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Position (cm)&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Tracked position along linear maze&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">l1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="s2">&quot;animal position&quot;</span><span class="p">,</span> <span class="s2">&quot;forward run epochs&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="restricting-the-data">
<h2>Restricting the data<a class="headerlink" href="#restricting-the-data" title="Link to this heading">#</a></h2>
<p>For the following exercises, we’ll only focus on periods when the animal is awake and running. We can get this information from <code class="docutils literal notranslate"><span class="pre">position</span></code>.</p>
<ol class="arabic simple">
<li><p>Save out the time support of position, which will give us the epoch during which the animal is awake</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># enter code here</span>
</pre></div>
</div>
</div>
</div>
<p>Since <code class="docutils literal notranslate"><span class="pre">forward_ep</span></code> is formatted as discontinuous epochs when the animal is running down the track, we will want two additional IntervalSets to describe the exploration period:</p>
<ol class="arabic simple">
<li><p>An IntervalSet with a single interval for the entire awake period</p></li>
<li><p>An IntervalSet containing the intervals at which the animal is at rest.</p></li>
</ol>
<p>We can derive both of these from <code class="docutils literal notranslate"><span class="pre">forward_ep</span></code>.</p>
<p>For the first, we can use the <code class="docutils literal notranslate"><span class="pre">IntervalSet</span></code> method <code class="docutils literal notranslate"><span class="pre">time_span</span></code>, which will give the total epoch spanning all the intervals in <code class="docutils literal notranslate"><span class="pre">forward_ep</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">awake_ep</span> <span class="o">=</span>
</pre></div>
</div>
</div>
</div>
<p>For the second, we know that the animal is likely at rest when there is no recorded position (i.e. the position is NaN). We can create this <code class="docutils literal notranslate"><span class="pre">IntervalSet</span></code>, then, using the following steps.</p>
<ol class="arabic simple">
<li><p>Drop <code class="docutils literal notranslate"><span class="pre">NaN</span></code> values from the position to grab only points where position is defined.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># drop nan values</span>
<span class="n">pos_good</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<ol class="arabic simple" start="2">
<li><p>Extract time intervals from <code class="docutils literal notranslate"><span class="pre">pos_good</span></code> using the <code class="docutils literal notranslate"><span class="pre">find_support</span></code> method</p>
<ul class="simple">
<li><p>The first input argument, <code class="docutils literal notranslate"><span class="pre">min_gap</span></code>, sets the minumum separation between adjacent intervals in order to be split</p></li>
<li><p>Here, use <code class="docutils literal notranslate"><span class="pre">min_gap</span></code> of 1 s</p></li>
</ul>
</li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># extract time support</span>
<span class="n">position_ep</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<ol class="arabic simple" start="3">
<li><p>Define resting epochs as the set difference between <code class="docutils literal notranslate"><span class="pre">awake_ep</span></code> and <code class="docutils literal notranslate"><span class="pre">position_ep</span></code>, using the <code class="docutils literal notranslate"><span class="pre">set_diff</span></code> method.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">set_diff</span></code> should be applied to <code class="docutils literal notranslate"><span class="pre">awake_ep</span></code>, not the other way around, such that intervals in <code class="docutils literal notranslate"><span class="pre">position_ep</span></code> are subtracted out of <code class="docutils literal notranslate"><span class="pre">awake_ep</span></code></p></li>
</ul>
</li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rest_ep</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<div class="note render-all admonition">
<p class="admonition-title">Note</p>
<p>Performing <code class="docutils literal notranslate"><span class="pre">set_diff</span></code> between <code class="docutils literal notranslate"><span class="pre">awake_ep</span></code> and <code class="docutils literal notranslate"><span class="pre">forward_ep</span></code> will <em>not</em> give us purely resting epochs, since these intervals will also include times when the animal is moving <em>backwards</em> across the linear track.</p>
</div>
<p>Now, when extracting the LFP, spikes, and position, we can use <code class="docutils literal notranslate"><span class="pre">restrict()</span></code> with <code class="docutils literal notranslate"><span class="pre">awake_ep</span></code> to restrict the data to our region of interest.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lfp_run</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;eeg&quot;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">awake_ep</span><span class="p">)</span>
<span class="n">spikes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">awake_ep</span><span class="p">)</span>
<span class="n">position</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">awake_ep</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>For visualization, we’ll look at a single run down the linear track. For a good example, we’ll start by looking at run 10 (python index 9). Furthermore, we’ll add two seconds on the end of the run to additionally visualize a period of rest following the run.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ex_run_ep</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">IntervalSet</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">forward_ep</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">forward_ep</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">end</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ex_run_ep</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="plotting-the-lfp-and-animal-position">
<h2>Plotting the LFP and animal position<a class="headerlink" href="#plotting-the-lfp-and-animal-position" title="Link to this heading">#</a></h2>
<p>To get a sense of what the LFP looks like while the animal runs down the linear track, we can plot each variable, <code class="docutils literal notranslate"><span class="pre">lfp_run</span></code> and <code class="docutils literal notranslate"><span class="pre">position</span></code>, side-by-side.</p>
<p>We’ll want to further restrict each variable to our run of interest, <code class="docutils literal notranslate"><span class="pre">ex_run_ep</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ex_lfp_run</span> <span class="o">=</span> 
<span class="n">ex_position</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>Let’s plot the example LFP trace and anmimal position. Plotting <code class="docutils literal notranslate"><span class="pre">Tsd</span></code> objects will automatically put time on the x-axis.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># plot LFP</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_lfp_run</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Local Field Potential on Linear Track&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;LFP (a.u.)&quot;</span><span class="p">)</span>

<span class="c1"># plot animal&#39;s position</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_position</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Animal Position on Linear Track&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Position (cm)&quot;</span><span class="p">)</span> <span class="c1"># LOOK UP UNITS</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="getting-the-wavelet-decomposition">
<h2>Getting the Wavelet Decomposition<a class="headerlink" href="#getting-the-wavelet-decomposition" title="Link to this heading">#</a></h2>
<p>To illustrate this further, we’ll perform a wavelet decomposition on the LFP trace during this run. We can do this in pynapple using the function <code class="docutils literal notranslate"><span class="pre">nap.compute_wavelet_transform</span></code>. This function takes the following inputs (in order):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sig</span></code>: the input signal; a <code class="docutils literal notranslate"><span class="pre">Tsd</span></code>, a <code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code>, or a <code class="docutils literal notranslate"><span class="pre">TsdTensor</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">freqs</span></code>: a 1D array of frequency values to decompose</p></li>
</ul>
<p>We will also supply the following optional arguments:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">fs</span></code>: the sampling rate of <code class="docutils literal notranslate"><span class="pre">sig</span></code></p></li>
</ul>
<ol class="arabic simple">
<li><p>Define 100 log-spaced samples between 5 and 200 Hz using <code class="docutils literal notranslate"><span class="pre">np.geomspace</span></code></p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 100 log-spaced samples between 5Hz and 200Hz</span>
<span class="n">freqs</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<ol class="arabic simple" start="2">
<li><p>Compute the wavelet transform, supplying the known sampling rate of 1250 Hz.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sample_rate</span> <span class="o">=</span> <span class="mi">1250</span>
<span class="n">cwt_run</span> <span class="o">=</span>
</pre></div>
</div>
</div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">fs</span></code> is not provided, it can be inferred from the time series <code class="docutils literal notranslate"><span class="pre">rate</span></code> attribute.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ex_lfp_run</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can visualize the results by plotting a heat map of the calculated wavelet scalogram.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Wavelet Decomposition&quot;</span><span class="p">)</span>

<span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cwt_run</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">cax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">cwt_run</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">amp</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Frequency (Hz)&quot;</span><span class="p">,</span> <span class="n">yscale</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">yticks</span><span class="o">=</span><span class="n">freqs</span><span class="p">[::</span><span class="mi">10</span><span class="p">],</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">freqs</span><span class="p">[::</span><span class="mi">10</span><span class="p">]));</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">minorticks_off</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cax</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Amplitude&quot;</span><span class="p">)</span>

<span class="n">p1</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_lfp_run</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;LFP (a.u.)&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Time(s)&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_position</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Position (cm)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="s2">&quot;raw LFP&quot;</span><span class="p">,</span><span class="s2">&quot;animal position&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="bonus-additional-signal-processing-methods">
<h2>Bonus: Additional signal processing methods<a class="headerlink" href="#bonus-additional-signal-processing-methods" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">nap.compute_fft</span></code></p></li>
</ul>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fft_amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">nap</span><span class="o">.</span><span class="n">compute_fft</span><span class="p">(</span><span class="n">lfp_run</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fft_amp</span><span class="p">[(</span><span class="n">fft_amp</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">fft_amp</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">)])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;theta band&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Frequency (Hz)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Normalized Amplitude (a.u.)&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;FFT amplitude during the awake epoch&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">nap.compute_power_spectral_density</span></code></p></li>
</ul>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">power</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">compute_power_spectral_density</span><span class="p">(</span><span class="n">lfp_run</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">power</span><span class="p">[(</span><span class="n">power</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">power</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">)])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;theta band&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Frequency (Hz)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Power/Frequency (a.u./Hz)&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Periodogram during the awake epoch&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="filtering-for-theta">
<h2>Filtering for theta<a class="headerlink" href="#filtering-for-theta" title="Link to this heading">#</a></h2>
<p>For the remaining exercises, we’ll reduce our example epoch to the portion when the animal is running down the linear track.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ex_run_ep</span> <span class="o">=</span> <span class="n">forward_ep</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
<span class="n">ex_lfp_run</span> <span class="o">=</span> <span class="n">lfp_run</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">)</span>
<span class="n">ex_position</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can filter our signal for theta by using <code class="docutils literal notranslate"><span class="pre">nap.apply_bandpass_filter</span></code>, which requires following arguments:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">data</span></code>: the signal to be filtered; a <code class="docutils literal notranslate"><span class="pre">Tsd</span></code>, <code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code>, or <code class="docutils literal notranslate"><span class="pre">TsdTensor</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cutoff</span></code>: tuple containing the frequency cutoffs, (lower frequency, upper frequency)</p></li>
</ul>
<p>Same as before, we’ll pass the optional argument:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">fs</span></code>: the sampling rate of <code class="docutils literal notranslate"><span class="pre">data</span></code> in Hz</p></li>
</ul>
<p>Using this function, filter <code class="docutils literal notranslate"><span class="pre">lfp_run</span></code> within a 6-12 Hz range.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">theta_band</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>We can visualize the output by plotting the filtered signal with the original signal.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_lfp_run</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;raw&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_band</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;filtered&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;LFP (a.u.)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Bandpass filter for theta oscillations (6-12 Hz)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="computing-theta-phase">
<h2>Computing theta phase<a class="headerlink" href="#computing-theta-phase" title="Link to this heading">#</a></h2>
<p>In order to examine phase precession in place cells, we need to extract the phase of theta from the filtered signal. We can do this by taking the angle of the <a class="reference external" href="https://en.wikipedia.org/wiki/Hilbert_transform">Hilbert transform</a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">signal</span></code> module of <code class="docutils literal notranslate"><span class="pre">scipy</span></code> includes a function to perform the Hilbert transform, after which we can use the numpy function <code class="docutils literal notranslate"><span class="pre">np.angle</span></code> to extract the angle.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">phase</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>The output angle will be in the range <span class="math notranslate nohighlight">\(-\pi\)</span> to <span class="math notranslate nohighlight">\(\pi\)</span>. Converting this to a <span class="math notranslate nohighlight">\(0\)</span> to <span class="math notranslate nohighlight">\(2\pi\)</span> range instead, by adding <span class="math notranslate nohighlight">\(2\pi\)</span> to negative angles, will make later visualization more interpretable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># enter code here</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we need to turn this into a <code class="docutils literal notranslate"><span class="pre">Tsd</span></code> to make full use of pynapple’s conveniences! Do this using the time index of <code class="docutils literal notranslate"><span class="pre">theta_band</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">theta_phase</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>Let’s plot the phase on top of the filtered LFP signal.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span><span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#, sharex=True, height_ratios=[2,1])</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_lfp_run</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_phase</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Phase (rad)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_band</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;LFP (a.u.)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="s2">&quot;theta phase&quot;</span><span class="p">,</span><span class="s2">&quot;filtered LFP&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s zoom in on a few cycles to get a better look.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#, sharex=True, height_ratios=[2,1])</span>

<span class="n">ex_run_shorter</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">IntervalSet</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ex_run_ep</span><span class="o">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.25</span><span class="p">)</span>

<span class="n">p1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_phase</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_shorter</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Phase (rad)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_band</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_shorter</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;LFP (a.u.)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="s2">&quot;theta phase&quot;</span><span class="p">,</span><span class="s2">&quot;filtered LFP&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="computing-1d-tuning-curves-place-fields">
<h2>Computing 1D tuning curves: place fields<a class="headerlink" href="#computing-1d-tuning-curves-place-fields" title="Link to this heading">#</a></h2>
<p>In order to identify phase precession in single units, we need to know their place selectivity. We can find place firing preferences of each unit by using the function <code class="docutils literal notranslate"><span class="pre">nap.compute_1d_tuning_curves</span></code>. This function has the following required inputs:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">group</span></code>: a <code class="docutils literal notranslate"><span class="pre">TsGroup</span></code> of units for which tuning curves are computed</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">feature</span></code>: a <code class="docutils literal notranslate"><span class="pre">Tsd</span></code> or single-column <code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code> of the feature over which tuning curves are computed (e.g. position)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nb_bins</span></code>: the number of bins in which to split the feature values for the tuning curve</p></li>
</ul>
<p>First, we’ll filter for units that fire at least 1 Hz and at most 10 Hz when the animal is running forward along the linear track. This will select for units that are active during our window of interest and eliminate putative interneurons (i.e. fast-firing inhibitory neurons that don’t usually have place selectivity).</p>
<ol class="arabic simple">
<li><p>Restrict <code class="docutils literal notranslate"><span class="pre">spikes</span></code> to <code class="docutils literal notranslate"><span class="pre">forward_ep</span></code></p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">forward_spikes</span> <span class="o">=</span>
</pre></div>
</div>
</div>
</div>
<ol class="arabic simple" start="2">
<li><p>Select for units whose rate is at least 1 Hz and at most 10 Hz</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">good_spikes</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>Using these units and the position data, we can compute their place fields using <code class="docutils literal notranslate"><span class="pre">nap.compute_1d_tuning_curves</span></code>. This function will return a <code class="docutils literal notranslate"><span class="pre">pandas.DataFrame</span></code>, where the index is the corresponding feature value, and the column is the unit label. Let’s compute this for 50 position bins.</p>
<div class="tip render-all admonition">
<p class="admonition-title">Tip</p>
<p>The reason <code class="docutils literal notranslate"><span class="pre">nap.compute_1d_tuning_curves</span></code> returns a <code class="docutils literal notranslate"><span class="pre">pandas.DataFrame</span></code> and not a Pynapple object is because the index corresponds to the <em>feature</em>, where all Pynapple objects assume the index is <em>time</em>.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">place_fields</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>We can use a subplot array to visualize the place fields of many units simultaneously. Let’s do this for the first 50 units.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.ndimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">gaussian_filter1d</span>

<span class="c1"># smooth the place fields so they look nice</span>
<span class="n">place_fields</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">gaussian_filter1d</span><span class="p">(</span><span class="n">place_fields</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">place_fields</span><span class="p">[</span><span class="mi">25</span><span class="p">:</span><span class="mi">50</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;unit&quot;</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">set_ylabels</span><span class="p">(</span><span class="s2">&quot;firing rate (Hz)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="visualizing-phase-precession-within-a-single-unit">
<h2>Visualizing phase precession within a single unit<a class="headerlink" href="#visualizing-phase-precession-within-a-single-unit" title="Link to this heading">#</a></h2>
<p>First, let’s look at how an example unit fires with respect to the filtered LFP. Using the pynapple object method <code class="docutils literal notranslate"><span class="pre">value_from</span></code>, we can find the value of <code class="docutils literal notranslate"><span class="pre">theta_band</span></code> corresponding to each spike time. Let’s do this for unit 177, who’s place field is cenetered on the linear track.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">unit</span> <span class="o">=</span> <span class="mi">177</span>
<span class="n">spike_theta</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>Let’s plot <code class="docutils literal notranslate"><span class="pre">spike_theta</span></code> on top of the LFP and filtered theta, as well as visualize the animal’s position along the track.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span><span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_lfp_run</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;raw LFP&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_band</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;slateblue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;filtered theta&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spike_theta</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">),</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;spike times&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;LFP (a.u.)&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_position</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;animal position&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_position</span><span class="p">[(</span><span class="n">ex_position</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">values</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ex_position</span> <span class="o">&lt;</span> <span class="mi">130</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;place field bounds&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Position (cm)&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>As the animal runs through unit 177’s place field (thick green), the unit spikes (orange dots) at specific points along the theta cycle dependent on position: starting at the rising edge, moving towards the trough, and ending at the falling edge.</p>
<p>We can exemplify this pattern by plotting the spike times aligned to the phase of theta. Let’s compute the phase at which each spike occurs by using <code class="docutils literal notranslate"><span class="pre">value_from</span></code> with <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spike_phase</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>To visualize the results, we’ll recreate the plot above, but instead with the theta phase.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span><span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_band</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;slateblue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;filtered theta&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spike_theta</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">),</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;spike times&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;LFP (a.u.)&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Spike times relative to filtered theta&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_phase</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;slateblue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;theta phase&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spike_phase</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">),</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;spike times&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Phase (rad)&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Spike times relative to theta phase&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_position</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;animal position&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_position</span><span class="p">[(</span><span class="n">ex_position</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span><span class="o">.</span><span class="n">values</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ex_position</span> <span class="o">&lt;</span> <span class="mi">130</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;place field bounds&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Position (cm)&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Animal position&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We now see a negative trend in the spike phase as the animal moves through unit 177’s place field, indicative of this unit <em>phase precessing</em>.</p>
<p>We can observe this phenomena on average across the session by relating the spike phase to the spike position. Try computing the spike position from what we’ve learned so far.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spike_position</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>Now we can plot the spike phase against the spike position in a scatter plot.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spike_position</span><span class="p">,</span> <span class="n">spike_phase</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Phase (rad)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Position (cm)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="computing-2d-tuning-curves-position-vs-phase">
<h2>Computing 2D tuning curves: position vs. phase<a class="headerlink" href="#computing-2d-tuning-curves-position-vs-phase" title="Link to this heading">#</a></h2>
<p>The scatter plot above can be similarly be represented as a 2D tuning curve over position and phase. We can compute this using the function <code class="docutils literal notranslate"><span class="pre">nap.compute_2d_tuning_curves</span></code>. This function requires the same inputs as <code class="docutils literal notranslate"><span class="pre">nap.compute_1d_tuning_curves</span></code>, except now the second input, <code class="docutils literal notranslate"><span class="pre">features</span></code>, must be a 2-column <code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code> containing the two target features.</p>
<p>To use this function, we’ll need to combine <code class="docutils literal notranslate"><span class="pre">position</span></code> and <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code> into a <code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code>. To do this, both variables must have the same length. We can achieve this by upsampling <code class="docutils literal notranslate"><span class="pre">position</span></code> to the length of <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code> using the pynapple object method <code class="docutils literal notranslate"><span class="pre">interpolate</span></code>. This method will linearly interpolate new position samples between existing position samples at timestamps given by another pynapple object, in our case by <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">upsampled_pos</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>Let’s visualize the results of the interpolation.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span><span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">),</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Position (cm)&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Original position points&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">upsampled_pos</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">),</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Position (cm)&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Upsampled position points&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can now stack <code class="docutils literal notranslate"><span class="pre">upsampled_pos</span></code> and <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code> into a single array.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">feats</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>Using <code class="docutils literal notranslate"><span class="pre">feats</span></code>, we can define a <code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code> using the time index from <code class="docutils literal notranslate"><span class="pre">theta_phase</span></code> and the time support from <code class="docutils literal notranslate"><span class="pre">upsampled_pos</span></code>. Note that <code class="docutils literal notranslate"><span class="pre">feats</span></code> has the wrong shape; we want time in the first dimension, so we’ll need to pass its transpose.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">features</span> <span class="o">=</span>
</pre></div>
</div>
</div>
</div>
<p>Now we have what we need to compute 2D tuning curves. Let’s apply <code class="docutils literal notranslate"><span class="pre">nap.compute_2d_tuning_curves</span></code> on our reduced group of units, <code class="docutils literal notranslate"><span class="pre">good_spikes</span></code>, using 20 bins for each feature.</p>
<p>This function will return two outputs:</p>
<ol class="arabic simple">
<li><p>A dictionary of the 2D tuning curves, where dictionary keys correspond to the unit label</p></li>
<li><p>A list with length 2 containing the feature bin centers</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tuning_curves</span><span class="p">,</span> <span class="p">[</span><span class="n">pos_x</span><span class="p">,</span> <span class="n">phase_y</span><span class="p">]</span> <span class="o">=</span>
</pre></div>
</div>
</div>
</div>
<p>We can plot the first 50 2D tuning curves and visualize how many of these units are phase precessing.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># fig, axs = plt.subplots(10, 5, figsize=(10, 15), sharex=True, constrained_layout=True)</span>
<span class="c1"># for i, f in enumerate(list(tuning_curves.keys())[:50]):</span>
<span class="c1">#     idx = np.unravel_index(i, axs.shape)</span>
<span class="c1">#     axs[idx].pcolormesh(pos_x, phase_y, tuning_curves[f])</span>
<span class="c1">#     axs[idx].set_title(f)</span>

<span class="c1"># fig.supylabel(&quot;Phase (rad)&quot;)</span>
<span class="c1"># fig.supxlabel(&quot;Position (cm)&quot;);</span>

<span class="n">tuning_curves</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;phase&quot;</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;unit&quot;</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="decoding-position-from-spiking-activity">
<h2>Decoding position from spiking activity<a class="headerlink" href="#decoding-position-from-spiking-activity" title="Link to this heading">#</a></h2>
<p>Next we’ll do a popular analysis in the rat hippocampal sphere: Bayesian decoding. This analysis is an elegent application of Bayes’ rule in predicting the animal’s location (or other behavioral variables) from neural activity at some point in time.</p>
<section id="background">
<h3>Background<a class="headerlink" href="#background" title="Link to this heading">#</a></h3>
<p>For a more in-depth background on Bayesian decoding, see the full version of this notebook online.</p>
</section>
<section id="aside-cross-validation">
<h3>ASIDE: Cross-validation<a class="headerlink" href="#aside-cross-validation" title="Link to this heading">#</a></h3>
<div class="important render-user render-presenter admonition">
<p class="admonition-title">Important</p>
<p>Generally this method is cross-validated, which means you train the model on one set of data and test the model on a different, held-out data set. For Bayesian decoding, the “model” refers to the model <em>likelihood</em>, which is computed from the tuning curves. Run the code below if you want to use a separate training set to compute the tuning curves.</p>
</div>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># hold out trial from place field computation</span>
<span class="n">run_train</span> <span class="o">=</span> <span class="n">forward_ep</span><span class="o">.</span><span class="n">set_diff</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">)</span>
<span class="c1"># get position of training set</span>
<span class="n">position_train</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">run_train</span><span class="p">)</span>
<span class="c1"># compute place fields using training set</span>
<span class="n">place_fields</span> <span class="o">=</span> <span class="n">nap</span><span class="o">.</span><span class="n">compute_tuning_curves</span><span class="p">(</span><span class="n">spikes</span><span class="p">,</span> <span class="n">position_train</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;position&quot;</span><span class="p">])</span>
<span class="c1"># smooth place fields</span>
<span class="n">place_fields</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">gaussian_filter1d</span><span class="p">(</span><span class="n">place_fields</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="run-1d-decoder">
<h3>Run 1D decoder<a class="headerlink" href="#run-1d-decoder" title="Link to this heading">#</a></h3>
<p>With a single dimension in our tuning curves (position), we can apply Bayesian decoding using the function <code class="docutils literal notranslate"><span class="pre">nap.decode_1d</span></code>. This function requires the following inputs:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">tuning_curves</span></code>: a <code class="docutils literal notranslate"><span class="pre">pandas.DataFrame</span></code>, computed by <code class="docutils literal notranslate"><span class="pre">nap.compute_1d_tuning_curves</span></code>, with the tuning curves relative to the feature being decoded</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">group</span></code>: a <code class="docutils literal notranslate"><span class="pre">TsGroup</span></code> of spike times, or a <code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code> of spike counts, for each unit in <code class="docutils literal notranslate"><span class="pre">tuning_curves</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ep</span></code>: an <code class="docutils literal notranslate"><span class="pre">IntervalSet</span></code> containing the epoch to be decoded</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bin_size</span></code>: the time length, in seconds, of each decoded bin. If <code class="docutils literal notranslate"><span class="pre">group</span></code> is a <code class="docutils literal notranslate"><span class="pre">TsGroup</span></code> of spike times, this determines how the spikes are binned in time. If <code class="docutils literal notranslate"><span class="pre">group</span></code> is a <code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code> of spike counts, this should be the bin size used for the counts.</p></li>
</ul>
<p>This function will return two outputs:</p>
<ul class="simple">
<li><p>a <code class="docutils literal notranslate"><span class="pre">Tsd</span></code> containing the decoded feature at each decoded time point</p></li>
<li><p>a <code class="docutils literal notranslate"><span class="pre">TsdFrame</span></code> containing the decoded probability of each feature value at each decoded time point, where the column names are the corresponding feature values</p></li>
</ul>
<p>To increase decoder accuracy, we’ll want to use the tuning curves of all the units in <code class="docutils literal notranslate"><span class="pre">spikes</span></code>. Recompute <code class="docutils literal notranslate"><span class="pre">place_fields</span></code> using <code class="docutils literal notranslate"><span class="pre">nap.compute_1d_tuning_curves</span></code> for all available units. (You can skip this if you’re using the cross-validated <code class="docutils literal notranslate"><span class="pre">place_fields</span></code> from above.)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">place_fields</span> <span class="o">=</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s decode position during <code class="docutils literal notranslate"><span class="pre">ex_run_ep</span></code> using 40 ms time bins.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">decoded_position</span><span class="p">,</span> <span class="n">decoded_prob</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>Let’s plot decoded position with the animal’s true position. We’ll overlay them on a heat map of the decoded probability to visualize the confidence of the decoder.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">decoded_position</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">place_fields</span><span class="o">.</span><span class="n">position</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">decoded_prob</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">decoded_position</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;decoded position&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_position</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;true position&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;decoded probability&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Position (cm)&quot;</span><span class="p">,</span> <span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="smooth-spike-counts">
<h3>Smooth spike counts<a class="headerlink" href="#smooth-spike-counts" title="Link to this heading">#</a></h3>
<p>One way to improve our decoder is to supply smoothed spike counts to <code class="docutils literal notranslate"><span class="pre">nap.decode_1d</span></code>. We can smooth the spike counts by convolving them with a kernel of ones; this is equivalent to applying a moving sum to adjacent bins, where the length of the kernel is the number of adjacent bins being added together. You can think of this as counting spikes in a <em>sliding window</em> that shifts in shorter increments than the window’s width, resulting in bins that overlap. This combines the accuracy of using a wider time bin with the temporal resolution of a shorter time bin.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ex_counts</span> <span class="o">=</span> <span class="n">spikes</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mf">0.04</span><span class="p">)</span>
<span class="n">workshop_utils</span><span class="o">.</span><span class="n">animate_1d_convolution</span><span class="p">(</span><span class="n">ex_counts</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">tsd_label</span><span class="o">=</span><span class="s2">&quot;original counts&quot;</span><span class="p">,</span> <span class="n">kernel_label</span><span class="o">=</span><span class="s2">&quot;moving sum&quot;</span><span class="p">,</span> <span class="n">conv_label</span><span class="o">=</span><span class="s2">&quot;convolved counts&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s compute the smoothed counts for all units.</p>
<ol class="arabic simple">
<li><p>On spike times restricted to <code class="docutils literal notranslate"><span class="pre">ep_run_ep</span></code>, count spikes in <span class="math notranslate nohighlight">\(40 ms\)</span> bins using the pynapple object method <code class="docutils literal notranslate"><span class="pre">count</span></code>.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">counts</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<ol class="arabic simple" start="2">
<li><p>Convolve the counts with the kernel <code class="docutils literal notranslate"><span class="pre">np.ones(5)</span></code> using the pynapple object method <code class="docutils literal notranslate"><span class="pre">convolve</span></code>.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">smth_counts</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>Now we can use <code class="docutils literal notranslate"><span class="pre">nap.decode_1d</span></code> again with our smoothed counts in place of the raw spike times. Note that the bin size we’ll want to provide is <span class="math notranslate nohighlight">\(200 ms\)</span>, since this is the true width of each bin.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">smth_decoded_position</span><span class="p">,</span> <span class="n">smth_decoded_prob</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>Let’s plot the results.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">smth_decoded_position</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">place_fields</span><span class="o">.</span><span class="n">position</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">smth_decoded_prob</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">smth_decoded_position</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;decoded position&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_position</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;true position&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;decoded probability&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Position (cm)&quot;</span><span class="p">,</span> <span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="decoding-theta-sequences">
<h3>Decoding theta sequences<a class="headerlink" href="#decoding-theta-sequences" title="Link to this heading">#</a></h3>
<p>Units phase precessing together creates fast, spatial sequences around the animal’s true position. We can reveal this by decoding at an even shorter time scale, which will appear as smooth errors in the decoder.</p>
<ol class="arabic simple">
<li><p>Get smoothed counts for a sliding window of <span class="math notranslate nohighlight">\(50 ms\)</span> shifted by <span class="math notranslate nohighlight">\(10 ms\)</span>.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">smth_counts</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<ol class="arabic simple" start="2">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">nap.decode_1d</span></code> to get the smoothed decoded position.</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">smth_decoded_position</span><span class="p">,</span> <span class="n">smth_decoded_prob</span> <span class="o">=</span> 
</pre></div>
</div>
</div>
</div>
<p>We’ll make the same plot as before to visualize the results, but plot it alongside the raw and filtered LFP.</p>
<div class="cell tag_render-all docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">smth_decoded_prob</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">smth_decoded_prob</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">smth_decoded_prob</span><span class="p">))</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">smth_decoded_position</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_position</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Position (cm)&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="s2">&quot;decoded position&quot;</span><span class="p">,</span><span class="s2">&quot;true position&quot;</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;predicted probability&quot;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex_lfp_run</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_band</span><span class="o">.</span><span class="n">restrict</span><span class="p">(</span><span class="n">ex_run_ep</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;LFP (a.u.)&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="head_direction-users.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Data analysis with pynapple &amp; nemos</p>
      </div>
    </a>
    <a class="right-next"
       href="../day2/current_injection-users.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Introduction to GLM</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#identifying-phase-precession-and-hippocampal-sequences">Identifying phase precession and hippocampal sequences</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#objectives">Objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fetching-the-data">Fetching the data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#units">units</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#rem-nrem-and-forward-ep">rem, nrem, and forward_ep</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#eeg">eeg</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#position">position</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#restricting-the-data">Restricting the data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plotting-the-lfp-and-animal-position">Plotting the LFP and animal position</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#getting-the-wavelet-decomposition">Getting the Wavelet Decomposition</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bonus-additional-signal-processing-methods">Bonus: Additional signal processing methods</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#filtering-for-theta">Filtering for theta</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-theta-phase">Computing theta phase</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-1d-tuning-curves-place-fields">Computing 1D tuning curves: place fields</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-phase-precession-within-a-single-unit">Visualizing phase precession within a single unit</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#computing-2d-tuning-curves-position-vs-phase">Computing 2D tuning curves: position vs. phase</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decoding-position-from-spiking-activity">Decoding position from spiking activity</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#background">Background</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#aside-cross-validation">ASIDE: Cross-validation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-1d-decoder">Run 1D decoder</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#smooth-spike-counts">Smooth spike counts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decoding-theta-sequences">Decoding theta sequences</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Edoardo Balzani, Billy Broderick, Sarah Jo Venditto, Guillaume Viejo
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025, Edoardo Balzani, Billy Broderick, Sarah Jo Venditto, Guillaume Viejo.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>